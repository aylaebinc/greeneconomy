---
title: "Stockton Green Economy Report"
author: "City Systems"
date: "2019"
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    code_folding: hide
    df_print: paged
---

```{r load libraries, include=FALSE}
library(tidycensus)
library(censusapi)
library(tigris)
library(units)
library(lehdr)
library(sf)
library(osrm)
library(mapview)
library(tidyverse)
library(magrittr)
library(lwgeom)
library(knitr)
opts_chunk$set(echo = TRUE, message = FALSE)
options(tigris_use_cache = TRUE)
options(tigris_class = "sf")
options(osrm.server = "http://127.0.0.1:5000/")
census_api_key("c8aa67e4086b4b5ce3a8717f59faa9a28f611dab", install = TRUE, overwrite = TRUE)
Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

***

# Introduction

The Office of the Mayor in Stockton, CA is seeking to differentiate the City’s investment opportunities, including potential capital from public (e.g. Transformative Climate Communities), private (e.g. Opportunity Zones), and philanthropic (e.g. foundations) sources, through the lens of **green economy**. The challenge at hand is to conduct a comprehensive assessment of Stockton’s assets and opportunities across a wide range of industry, infrastructure, development, and policy domains which could be marketed as green economy investment opportunities, thereby enabling City representatives to prioritize and drive evidence-informed discussions with investors, as opposed to agendas being driven by one-off outside interests. In particular, the City is focused on leveraging such a framework to target and scope a green demonstration project in the short-term (2019-2020), which already has committed capital, that generates the most useful short-term results, both in realized environmental and economic benefits and in attracting further investment interest.

City Systems has conducted a research activity with the following outcomes:

1. A repository of information about green economy investment opportunities in Stockton, including relevant technical review, case studies of implementation in other cities, key risks/challenges, and estimated ranges of possible environmental and economic benefits per dollar of investment.
2. Communication materials for the City of Stockton and partners to use in investor outreach.
3. A detailed design and implementation plan for a green demonstration project, informed by consensus-building discussion with City-identified stakeholders throughout the research phase, and likely to have initiated before the conclusion of the research phase.

The following document describes our methodology and results.

## Approach

The goal of every urban government is to provide residents a high quality of life, which not only includes the benefits associated with high-quality jobs, but a vibrant economy filled with excellent amenities and supported by well-maintained infrastructure. Building a robust business tax base is one recognized strategy in California for cities to adequately fund general expenses and capital infrastructure, given, for example, state restrictions on property taxes, and this strategy particularly important to Stockton given its history of bankruptcy following the Recession and its "brain drain" challenge of keeping high-quality talent from leaving for economic opportunities in the Bay Area. One useful related indicator is the jobs to employed residents (J/ER) ratio; the higher this ratio, the greater the share of business and sales tax relative to property tax, and the less likely the region is a "bedroom community" in which there are more people at night than during the day. For reference, a city like San Jose is unique to have its metropolitan core location and have a J/ER ratio less than 1; nearby cities like Palo Alto approach a J/ER ratio of 3. 

If Stockton is to reinvent its economy, a key goal should be to increase its J/ER ratio. To do so, it must aggressively attract high-quality businesses and support the growth of its existing ones, so that its number of jobs may increase more quickly than its population. Historical data for both population and jobs will help us understand the baseline performance of Stockton and its surrounding region in this regard, as well as allow us to forecast what "business as usual" looks like into the future. Then, J/ER ratio targets can be set in comparison to business as usual, which can be achieved through the kinds of economic development strategies explored in this report.

Of course, both job and population growth directly impact a city's environmental footprint. In later sections, we will prepare a baseline assessment of Stockton's greenhouse gas inventory, our primary indicator of environmental performance. Importantly, GHGs should be disaggregated as much as possible into residential and non-residential (commercial, industrial, agricultural) sectors and normalized by respective populations (residents vs. workers) to understand the GHG use per capita. Stockton's GHG footprint will almost certainly increase in the coming decades simply due to the increase in jobs and population, but if GHG/capita for each sector can be reduced through the kinds of strategies explored in this report, then it should be considered successful in curbing GHGs -- and perhaps the City's GHG footprint may actually decrease as a whole.

So, in summary, an accurate assessment of current population and jobs, combined with a GHG inventory, helps us measure important indicators of success like J/ER and GHG/capita. And a best estimate of how population and jobs will change in the future shows us what business as usual looks like for both economic and environmental health. Given this outlook, Stockton can consider a wide range of possible strategies that stimulate job growth, reduce our environmental footprint, or both at the same time, all categorized under the term **green economy**, and the effects of those strategies can be modeled into the future in comparison to business as usual to see if they help us achieve our economic and environmental targets.

# Baseline Assessment

The first step to our research is to conduct a baseline assessment of Stockton's environmental and economic performance, and produce "business as usual" forecasts. Different datasets will be limited to different historical ranges and geographic scales. We will explain all key assumptions made in data processing. For forecasting, we will generally rely on simple regression and will project to 2040, a common planning horizon.

## Population and Jobs

The following analysis first processes population and jobs data at the County (SJC) level, where it is more readily available, followed by estimations at the city level. 

The following datasets were collected for San Joaquin County:

- [Total Population, American Communities Survey, 1-Yr Estimates, 2010-2017](https://www.census.gov/programs-surveys/acs)
- [Population projections for US counties, 2020-2100](https://osf.io/9ynfc/)
- [Quarterly Workforce Indicators, 2010-2018](https://www.census.gov/data/developers/data-sets/qwi.html)
- [Nonemployer Statistics, 2010-2017](https://www.census.gov/data/developers/data-sets/cbp-nonemp-zbp/nonemp-api.2017.html)


A few notes on methodology and assumptions:

1. From the ACS, we collected Total Population, Total Population 16 and Older, Total Employed Residents (16+), and Unemployment Rate (for 16+). In order to forecast the future number of employed residents, which would then be used to forecast the future number of jobs, we chose to perform a linear regression on employment rate projecting to 2040, given that the unemployment rate was significantly more variable from 2010-2017.
2. Population projections come from a [study](https://www.nature.com/articles/sdata20195) published in Nature in 2019. The specific methodology is far beyond the scope of this project. What's notable is that five different projections were made by the author based on diferent "potential futures involving various growth policies, fossil-fuel usage, mitigation policies (ie emission reductions), adaptation policies (ie deployment of flood defenses), and population change". We used the "Middle of the road" projection.
3. Projections from the above study were available in 5-year age groups. While the total population projection is directly used in the result below for SJC, Population of 15+ was also collected which was multiplied by the previously projected Employment Rate (#1) to forecast total Employed Residents. Note that given data limitations we have a discontinuity between Population 16+ data from 2010-2017 and Population 15+ data from 2020-2040. We assume this difference is negligible for the purposes of our analysis, but it would have the effect of overestimating job count.
4. From the Quarterly Workforce Indicators, we collected Industry, Employee Count, and Total Earnings. From the Nonemployer Statistics, we collected Total Establishments and Total Revenue. Nonemployer Establishments include Sole Proprietorships and LLCs. We chose to estimate total Jobs by adding Employee Count and Total Nonemployer Establishments. Total Nonemployer Establishments is likely an overestimate of "jobs" in this sector if individuals own multiple establishments, but we assume this difference to be negligible.
5. We calculated J/ER for 2010-2017 by dividing total Jobs by Employed Residents. Then, we chose to perform a linear regression on J/ER ratio projecting to 2040, and multiplied this by our projected Employed Residents (#3) to forecast total Jobs.

```{r population and jobs data}
pop_sjc <- data.frame(matrix(ncol=3,nrow=0))
colnames(pop_sjc) <- c("POP","Population15andolder","year")

for(year in 2010:2017){ 
  
  temp <- 
    getCensus(
      name = "acs/acs1",
      vintage = year,
      vars = c("B01003_001E"),
      region = "county:077",
      regionin = "state:06"
    ) %>% 
    mutate(
      Population = B01003_001E, 
      year = year
    ) %>% 
    select(
      Population,
      year
    )
  
  pop_sjc<- rbind(pop_sjc,temp)
  
}

sjc_projection <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/SSP_asrc_STATEfiles/DATA-PROCESSED/SPLITPROJECTIONS/CA.csv") %>% 
  filter(COUNTY == "077") %>% 
  group_by(YEAR) %>% 
  summarize(
    Population = sum(SSP2),
    Population15andOlder = sum(SSP2[which(AGE > 3)])
  ) %>% 
  filter(YEAR %in% c(2020,2025,2030,2035,2040)) %>% 
  select(Population, Population15andOlder, year = YEAR)

pop_sjc_w_projection <-
  bind_rows(pop_sjc,sjc_projection)

emp_sjc <- data.frame(matrix(ncol=2,nrow=0))
colnames(emp_sjc) <- c("EmployedResidents","year")

for(year in 2010:2017){ 
  
  temp <- 
    getCensus(
      name = "acs/acs1/subject",
      vintage = year,
      vars = c("S2301_C01_001E","S2301_C03_001E","S2301_C04_001E"),
      region = "county:077",
      regionin = "state:06"
    ) %>% 
    mutate(
      Population16andOlder = S2301_C01_001E,
      PercEmployedResidents = S2301_C03_001E,
      EmployedResidents = PercEmployedResidents/100*Population16andOlder,
      UnemploymentRate = S2301_C04_001E,
      year = year
    ) %>% 
    select(
      Population16andOlder,
      PercEmployedResidents,
      EmployedResidents,
      UnemploymentRate,
      year
    )
  
  emp_sjc<- rbind(emp_sjc,temp)
  
}

pop_emp_sjc_w_projection <-
  pop_sjc_w_projection %>% 
  left_join(emp_sjc, by = "year") %>% 
  mutate(
    PercEmployedResidents = ifelse(
      !is.na(PercEmployedResidents),
      PercEmployedResidents,
      lm(
        formula = `PercEmployedResidents`[1:8] ~ year[1:8]
      )$coefficients[1]+
        lm(
          formula = `PercEmployedResidents`[1:8] ~ year[1:8]
        )$coefficients[2]*year
    ),
    EmployedResidents = ifelse(!is.na(EmployedResidents),EmployedResidents,Population15andOlder*PercEmployedResidents/100)
  )

label_industry <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/label_industry.csv")

qwi_sjc <- data.frame(matrix(ncol=5,nrow=0))
colnames(qwi_sjc) <- c("year","industry","label","EmpS","EarnS")

for(years in 2010:2018){
  qwi<- 
    getCensus(
      name = "timeseries/qwi/sa",
      region = "county:077",
      regionin = "state:06",
      vars = c("EmpS","EarnS","industry","ind_level"),
      time = years
    ) %>% 
    filter(ind_level == 4) %>% 
    mutate(
      year = substr(time,1,4)
    ) %>% 
    left_join(label_industry, by= "industry") %>% 
    group_by(year,industry,label) %>% 
    summarize(
      EmpS = round(mean(as.numeric(EmpS), na.rm = TRUE),0),
      EarnS = round(mean(as.numeric(EarnS), na.rm = TRUE),0)
    ) %>% 
    filter(!is.na(EmpS) & EmpS != 0)
  
  qwi_sjc<- 
    bind_rows(qwi_sjc,qwi)
}

nonemp_sjc <- data.frame(matrix(ncol=3,nrow=0))
colnames(nonemp_sjc) <- c("NESTAB","NRCPTOT","year")

for(year in 2010:2017){
  
  nonemp <-
    getCensus(
      name = "nonemp",
      vintage = year,
      region = "county:077",
      regionin = "state:06",
      vars = c(
        "NESTAB",
        "NRCPTOT"
      )
    ) %>%
    mutate(year = as.numeric(year)) %>% 
    select(-c(state,county))
  
  nonemp_sjc<- 
    rbind(nonemp_sjc,nonemp)
  
}

jobs_sjc <- 
  qwi_sjc %>% 
  mutate(year = as.numeric(year)) %>% 
  group_by(year) %>% 
  summarize(
    EmpS=sum(as.numeric(EmpS))
  ) %>% 
  left_join(nonemp_sjc, by = "year") %>% 
  mutate(
    totaljobs = EmpS + as.numeric(NESTAB)
  )

# pop_jobs_sjc_w_projection <-
#   pop_sjc_w_projection %>% 
#   left_join(jobs_sjc, by = "year") %>% 
#   mutate(
#     ratio = POP/EmpS
#   )

pop_jobs_sjc_w_projection <-
  pop_emp_sjc_w_projection %>% 
  left_join(jobs_sjc, by = "year") %>%
  mutate(
    ratio = ifelse(
      !is.na(totaljobs),
      totaljobs/EmployedResidents,
      lm(
        formula = totaljobs[1:8]/EmployedResidents[1:8] ~ year[1:8]
      )$coefficients[1]+
        lm(
          formula = totaljobs[1:8]/EmployedResidents[1:8] ~ year[1:8]
        )$coefficients[2]*year
    ),
    totaljobs = ifelse(!is.na(totaljobs),totaljobs,EmployedResidents*ratio)
  ) %>% 
  select(
    Year = year,
    Population,
    `Jobs` = totaljobs,
    `Employed Residents` = EmployedResidents,
    `J/ER Ratio` = ratio,
    Employees = EmpS,
    `Nonemployer Establishments` = NESTAB,
    `Percent Employed Residents` = PercEmployedResidents,
    `Percent Unemployment` = UnemploymentRate
  )

pop_jobs_sjc_w_projection
```
*Table 1. Historical Population and Job counts for San Joaquin County 2010-2017, followed by projections to 2040.*

The following graph shows the J/ER ratio projected out to 2040, reaching a high of 0.85. This is not particularly high, though we would expect Stockton's city-specific J/ER ratio to be higher. There is certainly room for improvement through proactive economic development strategies.

```{r}
ggplot(pop_jobs_sjc_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `J/ER Ratio`), size=2, colour = "forest green") +
  geom_vline(aes(xintercept = 2017), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2017, y=.83, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2017, y=.83, angle = 90, size=4) +
  labs(title = "San Joaquin County, CA")
```
*Figure 1. Historical Jobs to Employed Residents Ratio for San Joaquin County 2010-2017, followed by projections to 2040.*

The following graph shows Population, Employed Residents, and Jobs projections to 2040. 

```{r}
ggplot(pop_jobs_sjc_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `Employed Residents`, colour = "Employed Residents"), size = 2) +
  geom_line(aes(y = Jobs, colour = "Jobs"), size = 2) +
  geom_line(aes(y = Population, colour = "Population"), size = 2) + 
  geom_vline(aes(xintercept = 2017), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2017, y=5e05, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2017, y=5e05, angle = 90, size=4) +
  scale_colour_manual(values = c("purple","blue","red")) + 
  labs(title = "San Joaquin County, CA", y = "Count", colour = "")
```
*Figure 2. Historical Population, Employed Residents, and Jobs for San Joaquin County 2010-2017, followed by projections to 2040.*

facet_wrap

Industry class
Green jobs