---
title: "Stockton Green Economy Report"
author: "City Systems"
date: "Last Updated: February 2020"
output: 
  bookdown::gitbook:
    df_print: paged
    split_by: section
    includes:
      in_header: header.html
    config:
      toc:
        collapse: none
        scroll_highlight: yes
        before: null
        after: null
      toolbar:
        position: fixed
      edit : null
      download: null
      search: yes
      fontsettings:
        theme: white
        family: sans
        size: 2
      sharing:
        facebook: no
        github: no
        twitter: no
        linkedin: no
        weibo: no
        instapaper: no
        vk: no
        all: no
      info: no
editor_options: 
  chunk_output_type: inline
---

# Introduction

```{r libraries, include=FALSE}
library(tidycensus)
library(censusapi)
library(tigris)
library(units)
library(lehdr)
library(sf)
library(osrm)
library(mapview)
library(tidyverse)
library(magrittr)
library(lwgeom)
library(knitr)
library(DT)
library(bookdown)
library(kableExtra)
library(FinancialMath)
opts_chunk$set(
  echo = TRUE, 
  warning=FALSE, 
  message=FALSE,
  cache=TRUE
)
mapviewOptions(
  basemaps = "OpenStreetMap",
  leafletWidth = "100%")
options(
  tigris_use_cache = TRUE,
  tigris_class = "sf",
  osrm.server = "http://127.0.0.1:5000/",
  scipen=999
)
census_api_key("c8aa67e4086b4b5ce3a8717f59faa9a28f611dab", install = TRUE, overwrite = TRUE)
Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

```{r codefolding, echo=FALSE, eval=TRUE}
codejs <- readr::read_lines("js/codefolding.js")
collapsejs <- readr::read_lines("js/collapse.js")
transitionjs <- readr::read_lines("js/transition.js")

htmlhead <- 
  paste('
<script>',
paste(transitionjs, collapse = "\n"),
'</script>
<script>',
paste(collapsejs, collapse = "\n"),
'</script>
<script>',
paste(codejs, collapse = "\n"),
'</script>
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
.row { display: flex; }
.collapse { display: none; }
.in { display:block }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>
', sep = "\n")

readr::write_lines(htmlhead, path = "header.html")
```

The Office of the Mayor in Stockton, CA is seeking to differentiate the City's investment opportunities, including potential capital from public (e.g. Transformative Climate Communities), private (e.g. Opportunity Zones), and philanthropic (e.g. foundations) sources, through the lens of **green economy**. The challenge at hand is to conduct a comprehensive assessment of Stockton's assets and opportunities across a wide range of industry, infrastructure, development, and policy domains which could be marketed as green economy investment opportunities, thereby enabling City representatives to prioritize and drive evidence-informed discussions with investors, as opposed to agendas being driven by one-off outside interests. In particular, the City is focused on leveraging such a framework to target and scope a green demonstration project in the short-term (2020-2021), which already has committed capital, that generates the most useful short-term results, both in realized environmental and economic benefits and in attracting further investment interest.

City Systems has conducted a research activity with the following outcomes:

1. A repository of information about green economy investment opportunities in Stockton, including relevant technical review, case studies of implementation in other cities, key risks/challenges, and estimated ranges of possible environmental and economic benefits per dollar of investment.
2. Communication materials for the City of Stockton and partners to use in investor outreach.
3. A detailed design and implementation plan for a green demonstration project, informed by consensus-building discussion with City-identified stakeholders throughout the research phase, and likely to have initiated before the conclusion of the research phase.

The following document describes our methodology and results. Given the scope of this report, readers encouraged to navigate freely throughout different sections using the table of contents on the left, or with the summary table below.

| If you are interested in... | Skip to... |
|:---|:---|
| Baseline assessment of economy and GHG footprint | [Chapter 2](#baseline-assessment) |
| Overview of fifty green economy strategies from around the U.S. | [Chapter 3](overview-of-green-economy-strategies) |
| Analysis of five green economy strategies for Stockton | [Chapter 4](analysis-of-green-economy-strategies) |
| U.S. strategy overview organized by city/county/state | [Appendix A](appendix-a-index-of-case-studies-by-place) |

## Approach

The goal of every urban government is to provide residents a high quality of life, which not only includes the benefits associated with high-quality jobs, but also a vibrant economy filled with excellent amenities and supported by well-maintained infrastructure. Building a robust business tax base is one recognized strategy in California for cities to adequately fund general expenses and capital infrastructure, given, for example, state restrictions on property taxes. This strategy is particularly relevant to Stockton given its history of bankruptcy following the Recession and its "brain drain" challenge of keeping high-quality talent from leaving for economic opportunities in the Bay Area and elsewhere. One useful related indicator is the jobs to employed residents (J/ER) ratio; the higher this ratio, the greater the share of business and sales tax relative to property tax, and the less likely the region is a "bedroom community" in which there are more people at night than during the day. For reference, a city like San Jose is unique to have its metropolitan core location yet have a J/ER ratio less than 1; nearby cities like Palo Alto approach a J/ER ratio of 3. 

If Stockton is to reinvent its economy, a key goal should be to increase its J/ER ratio while ensuring the quality of those jobs. To do so, it must aggressively attract high-quality businesses and support the growth of its existing ones, so that its number of jobs may increase more quickly than its population. Historical data for both population and jobs will help us understand the baseline performance of Stockton and its surrounding region in this regard, as well as allow us to forecast what "business as usual" looks like into the future. Then, J/ER ratio targets can be set in comparison to business as usual, which can be achieved through the kinds of economic development strategies explored in this report.

Of course, both job and population growth directly impact a city's environmental footprint. In Chapter 2, we will prepare a baseline assessment of Stockton's greenhouse gas inventory, our primary indicator of environmental performance. Importantly, GHGs should be disaggregated as much as possible into residential and non-residential (commercial, industrial, agricultural) sectors and normalized by respective populations (residents vs. workers) to understand the GHG use per capita in these different sectors. Stockton's GHG footprint will almost certainly increase in the coming decades simply due to the increase in jobs and population, but if GHG/capita for each sector can be reduced through the kinds of strategies explored in this report, then it should be considered successful in curbing GHGs -- and perhaps the City's GHG footprint may actually decrease as a whole.

So, in summary, an accurate assessment of current population and jobs, combined with a GHG inventory, helps us measure important indicators of success like J/ER and GHG/capita. And a best estimate of how population and jobs will change in the future shows us what business as usual looks like for both economic and environmental health. Given this outlook, Stockton can consider a wide range of possible strategies that stimulate job growth, reduce our environmental footprint, or in the best case scenario, achieve both at the same time, all categorized under the term **green economy**. The effects of those strategies can be modeled into the future in comparison to business as usual to see if they help us achieve our economic and environmental targets. Of course, strategies will also need to be evaluated based on their costs and return on investment, which we will approximate as a $/tCO2e (metric tons of carbon dioxide equivalent) in net-present value, similar to the work done in [Climate Smart San Jose](https://www.sanjoseca.gov/your-government/environment/climate-smart-san-jos). After robustly carrying out the quantitative analysis involved, this report will highlight the most promising strategies at the intersection of "green" and "economy" so that future decision-makers can take actionable steps towards a vibrant and sustainable future.

# Baseline Assessment

The first step to our research is to conduct a baseline assessment of Stockton's environmental and economic performance, and produce "business as usual" forecasts. Different datasets will be limited to different historical ranges and geographic scales. We will explain all key assumptions made in data processing. For forecasting, we will generally rely on simple regression and will project to 2040, a common planning horizon.

## Population and Jobs

The following analysis first processes population and jobs data at the County (SJC) level, where it is more readily available, followed by estimations at the City level. 

### County-level Analysis

The following datasets were collected for SJC:

- [Total Population, American Communities Survey, 1-Yr Estimates, 2010-2018](https://www.census.gov/programs-surveys/acs)
- [Population projections for US counties, 2020-2100](https://osf.io/9ynfc/)
- [Longitudinal Employer-Household Dynamics Origin-Destination Employment Statistics, 2010-2017](https://lehd.ces.census.gov/data/), available at the block level

A few notes on methodology and assumptions:

1. From the ACS, we collected Total Population, Total Population 16 and Older, Total Employed Residents (16+), and Unemployment Rate (for 16+). In order to forecast the future number of employed residents, which would then be used to forecast the future number of jobs, we chose to perform a linear regression on employment rate projecting to 2040, given that the unemployment rate was significantly more variable from 2010-2018.
2. Population projections come from a [study](https://www.nature.com/articles/sdata20195) published in Nature in 2019. The specific methodology is beyond the scope of this project to unpack. What's notable is that five different projections were made by the author based on diferent "potential futures involving various growth policies, fossil-fuel usage, mitigation policies (i.e. emission reductions), adaptation policies (i.e. deployment of flood defenses), and population change". We used the "Middle of the road" projection.
3. Projections from the above study were available in 5-year age groups. While the total population projection is directly used in the final table below for SJC, Population of 15+ was also collected which was multiplied by the previously projected Employment Rate (#1) to forecast total Employed Residents. Note that given data limitations we have a discontinuity between Population 16+ data from 2010-2018 and Population 15+ data from 2020-2040. We assume this difference is negligible for the purposes of our analysis, but it would have the effect of overestimating job count.
4. From LODES we collected "Primary Jobs" at the block group level and aggregated all jobs for block groups in SJC. These are meant to match the number of individual workers in a region. We also compared this number to the number of employees provided by the [Quarterly Workforce Indicators](https://www.census.gov/data/developers/data-sets/qwi.html) dataset and the number of nonemployer establishments in the [Nonemployer Statistics](https://www.census.gov/data/developers/data-sets/cbp-nonemp-zbp/nonemp-api.2017.html) dataset. The LODES Primary Jobs number was higher than the QWI Employee count but lower than the QWI Employee count plus Nonemployer Establishments count, which seems to make sense (since an individual could operate multiple nonemployer establishments).
5. We calculated J/ER for 2010-2018 by dividing total Jobs by Employed Residents. Then, we chose to perform a linear regression on J/ER ratio projecting to 2040, and multiplied this by our projected Employed Residents (#3) to forecast total Jobs.

```{r sjc-pop-jobs}
ca_counties <- counties("CA", cb = TRUE)
ca_tracts <- tracts("CA", cb = TRUE)
ca_bgs <- block_groups("CA", cb = TRUE)

county_neighbors <-
  ca_counties %>% 
  filter(NAME %in% c(
    "San Joaquin",
    "Alameda",
    "Sacramento",
    "Santa Clara",
    "Stanislaus",
    "Contra Costa",
    "San Francisco",
    "San Mateo",
    "Solano",
    "Fresno",
    "Placer",
    "Yolo",
    "Sonoma",
    "Merced",
    "Monterey"
  ))

pop_sjc <- data.frame(matrix(ncol=3,nrow=0))
colnames(pop_sjc) <- c("Population","Population15andolder","year")

for(year in 2010:2018){

  temp <-
    getCensus(
      name = "acs/acs1",
      vintage = year,
      vars = c("B01003_001E"),
      region = "county:077",
      regionin = "state:06"
    ) %>%
    mutate(
      Population = B01003_001E,
      year = year
    ) %>%
    dplyr::select(
      Population,
      year
    )

  pop_sjc<- rbind(pop_sjc,temp)

}

sjc_projection <-
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/SSP_asrc_STATEfiles/DATA-PROCESSED/SPLITPROJECTIONS/CA.csv") %>%
  filter(COUNTY == "077") %>%
  group_by(YEAR) %>%
  summarize(
    Population = sum(SSP2),
    Population15andOlder = sum(SSP2[which(AGE > 3)])
  ) %>%
  filter(YEAR %in% c(2020,2025,2030,2035,2040)) %>%
  dplyr::select(Population, Population15andOlder, year = YEAR)

pop_sjc_w_projection <-
  bind_rows(pop_sjc,sjc_projection)

emp_sjc <- data.frame(matrix(ncol=2,nrow=0))
colnames(emp_sjc) <- c("EmployedResidents","year")

for(year in 2010:2018){

  temp <-
    getCensus(
      name = "acs/acs1/subject",
      vintage = year,
      vars = c("S2301_C01_001E","S2301_C03_001E","S2301_C04_001E"),
      region = "county:077",
      regionin = "state:06"
    ) %>%
    mutate(
      Population16andOlder = S2301_C01_001E,
      PercEmployedResidents = S2301_C03_001E,
      EmployedResidents = PercEmployedResidents/100*Population16andOlder,
      UnemploymentRate = S2301_C04_001E,
      year = year
    ) %>%
    dplyr::select(
      Population16andOlder,
      PercEmployedResidents,
      EmployedResidents,
      UnemploymentRate,
      year
    )

  emp_sjc<- rbind(emp_sjc,temp)

}

pop_emp_sjc_w_projection <-
  pop_sjc_w_projection %>%
  left_join(emp_sjc, by = "year") %>%
  mutate(
    PercEmployedResidents = ifelse(
      !is.na(PercEmployedResidents),
      PercEmployedResidents,
      lm(
        formula = `PercEmployedResidents`[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = `PercEmployedResidents`[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    EmployedResidents = ifelse(!is.na(EmployedResidents),EmployedResidents,Population15andOlder*PercEmployedResidents/100)
  )

# sjc_wac <-
#   2010:2017 %>%
#   map(function(year){
#     ca_wac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "wac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     temp <-
#       ca_wac %>%
#       filter(substr(w_bg,1,5) == "06077")
# 
#     return(temp)
#   }) %>%
#   rbindlist()
# 
# save(sjc_wac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/sjc_wac.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/sjc_wac.Rdata")

jobs_sjc <-
  sjc_wac %>%
  group_by(year) %>% 
  summarize(Jobs = sum(C000))

#Add 2018 jobs projection
jobs_sjc[9,1] <- 2018
jobs_sjc[9,2] <- 
  lm(formula = jobs_sjc$Jobs[1:8] ~ jobs_sjc$year[1:8])$coefficients[1]+
  lm(formula = jobs_sjc$Jobs[1:8] ~ jobs_sjc$year[1:8])$coefficients[2]*2018

pop_jobs_sjc_w_projection <-
  pop_emp_sjc_w_projection %>%
  left_join(jobs_sjc, by = "year") %>%
  mutate(
    ratio = ifelse(
      !is.na(Jobs),
      Jobs/EmployedResidents,
      lm(
        formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    Jobs = ifelse(!is.na(Jobs),Jobs,EmployedResidents*ratio)
  ) %>%
  transmute(
    Year = year,
    Population = Population,
    Jobs = Jobs,
    `Employed Residents` = EmployedResidents,
    `J/ER Ratio` = ratio,
    `Percent Employed Residents` = PercEmployedResidents,
    `Percent Unemployment` = UnemploymentRate
  )

pop_jobs_sjc_w_projection_table <-
  pop_jobs_sjc_w_projection %>%
  transmute(
    Year = Year,
    Population = prettyNum(round(Population,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `Employed Residents` = prettyNum(round(`Employed Residents`,-3),big.mark=","),
    `J/ER Ratio` = round(`J/ER Ratio`,2),
    `Percent Employed Residents` = paste0(round(`Percent Employed Residents`),"%"),
    `Percent Unemployment` = ifelse(is.na(`Percent Unemployment`),"NA",paste0(round(`Percent Unemployment`),"%"))
  )

# save(pop_jobs_sjc_w_projection, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/pop_jobs_sjc_w_projection.Rdata")

kable(
  pop_jobs_sjc_w_projection_table,
  booktabs = TRUE,
  caption = 'Historical population and job counts for San Joaquin County 2010-2017, followed by projections to 2040.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The figure below shows the J/ER ratio projected out to 2040, reaching a high of 0.78. This is not particularly high (given our goal of surpassing 1). There is certainly room for improvement through proactive economic development strategies.

```{r sjc-jer, fig.cap = "Historical Jobs to Employed Residents Ratio for San Joaquin County 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_sjc_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `J/ER Ratio`), size=2, colour = "forest green") +
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  labs(title = "San Joaquin County, CA")
```

$~$

```{r sjc-projection, fig.cap = "Historical population, employed residents, and jobs for San Joaquin County 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_sjc_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `Employed Residents`/100000, colour = "Employed Residents"), size = 2) +
  geom_line(aes(y = Jobs/100000, colour = "Jobs"), size = 2) +
  geom_line(aes(y = Population/100000, colour = "Population"), size = 2) + 
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=5, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=5, angle = 90, size=4) +
  scale_colour_manual(values = c("purple","blue","red")) + 
  labs(title = "San Joaquin County, CA", y = "Count (100,000s)", colour = "")
```

$~$

The following figure compares the J/ER ratio for SJC and its neighboring counties since 2010. SJC is toward the lower end of the group. It appears that all of these counties are stagnant or decreasing in this metric, and are all "bedroom counties" in the sense of being net exporters of workers during the day. 

```{r compare-jer, fig.cap = "Comparison of Jobs to Employment Ratio for different counties, 2010-2017."}
# county_jer <- NULL
# 
# for(year in 2010:2017){
#   
#   ca_wac <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "wac",
#       job_type = "JT01",
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "tract"
#     )
#   
#   for(county in county_neighbors$COUNTYFP){
#     
#      temp <-
#       getCensus(
#         name = "acs/acs1/subject",
#         vintage = year,
#         vars = c("S2301_C01_001E","S2301_C03_001E","S2301_C04_001E"),
#         region = paste0("county:",county),
#         regionin = "state:06"
#       ) %>%
#       mutate(
#         Population16andOlder = S2301_C01_001E,
#         PercEmployedResidents = S2301_C03_001E,
#         EmployedResidents = round( PercEmployedResidents/100*Population16andOlder),
#         Year = year,
#         Jobs = 
#           ca_wac %>% 
#           filter(substr(w_tract,3,5) == county) %>% 
#           pull(C000) %>% 
#           sum(na.rm=T),
#         County = county_neighbors[which(county_neighbors$COUNTYFP == county),]$NAME,
#       ) %>%
#       dplyr::select(
#         County,
#         Year,
#         Jobs,
#         EmployedResidents
#       )
#   
#     county_jer<- rbind(county_jer,temp)
#   }
# }
# 
# save(county_jer,file="C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/county_jer.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/county_jer.Rdata")

county_jer %>% 
  filter(County %in% c("San Joaquin","Stanislaus","Alameda","Sacramento","Fresno","Solano","Contra Costa")) %>% 
  ggplot(
    aes(
      x = Year,
      y = Jobs/EmployedResidents,
      colour = County
    )
  ) +
  geom_line()
```

$~$

The [Quarterly Workforce Indicators](https://www.census.gov/data/developers/data-sets/qwi.html) dataset also illustrates the number and average quarterly earnings of jobs in different sub-level NAICS industry sectors (228 total). The table below is sorted by sectors with the most jobs in SJC.

```{r qwi}
label_industry <-
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/label_industry.csv")

# qwi_sjc <- data.frame(matrix(ncol=5,nrow=0))
# colnames(qwi_sjc) <- c("year","industry","label","EmpS","EarnS")
# 
# for(years in 2010:2018){
#   qwi<-
#     getCensus(
#       name = "timeseries/qwi/sa",
#       region = "county:077",
#       regionin = "state:06",
#       vars = c("EmpS","EarnS","industry","ind_level"),
#       time = years
#     ) %>%
#     filter(ind_level == 4) %>%
#     mutate(
#       year = substr(time,1,4)
#     ) %>%
#     left_join(label_industry, by= "industry") %>%
#     group_by(year,industry,label) %>%
#     summarize(
#       EmpS = round(mean(as.numeric(EmpS), na.rm = TRUE),0),
#       EarnS = round(mean(as.numeric(EarnS), na.rm = TRUE),0)
#     ) %>%
#     filter(!is.na(EmpS) & EmpS != 0)
# 
#   qwi_sjc<-
#     bind_rows(qwi_sjc,qwi)
# }
# 
# save(qwi_sjc, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/qwi_sjc.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/qwi_sjc.Rdata")

qwi_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018) %>% 
  arrange(desc(EmpS)) %>% 
  transmute(
    Label = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Quarterly Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  qwi_sjc_18,
  booktabs = TRUE,
  caption = 'Job counts and earnings by NAICS industry sector for San Joaquin County 2018.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

$~$

### City-level Analysis

The Nature journal population projections from the previous section are not available at the City level; in this case we chose to assume that Stockton's missing data was proportional to the related data we had at the County level. Otherwise, to scale our analysis down to Stockton, we collected data at the block group level. The following block groups were manually selected to represent Stockton.

```{r bgs, fig.cap = "Block groups used to represent Stockton population estimates. The red outline is the official city boundary."}
stockton_boundary <- 
  places("CA", cb = TRUE) %>% 
  filter(NAME == "Stockton") 

stockton_boundary_buffer <-
  stockton_boundary %>% 
  st_transform(26910) %>% 
  st_buffer(1600) %>% 
  st_transform(st_crs(stockton_boundary))
  
# includes unincorporated areas on periphery that have addresses in Stockton, but removing Lodi and Manteca areas
stockton_bgs_full <- 
  block_groups("CA", cb = TRUE)[stockton_boundary_buffer,c("GEOID")] %>% 
  filter(!(GEOID %in% c("060770051351","060770040011","060770041061","060770041022")))

# stockton_bgs_minimal <- 
#   block_groups("CA", cb = TRUE)[stockton_boundary,c("GEOID")] %>% 
#   filter(!(GEOID %in% c("060770040011","060770039001","060770041061","060770039001","060770039002","060770051311","060770051351","060770041022","06077002701","060770036012","060770015002","060770017001","060770017003","060770017002","060770027011","060770027012","060770027013","060770027014","060770037001")))

stockton_tracts_full <-
  tracts("CA", cb = TRUE)[stockton_boundary_buffer,c("GEOID")] %>% 
  filter(!(GEOID %in% c("06077004001","06077004106","06077005135")))

# mapview(stockton_tracts_full) + mapview(stockton_boundary, alpha.regions = 0, color = "red", lwd = 4)

map = mapview(stockton_bgs_full$geometry) + mapview(stockton_boundary$geometry, alpha.regions = 0, color = "red", lwd = 4)
map@map
```

$~$

```{r stockton-pop-jobs}
pop_stockton <- data.frame(matrix(ncol=3,nrow=0))
colnames(pop_stockton) <- c("PopulationStockton","Population15andolder","year")

for(year in 2010:2018){

  temp <-
    getCensus(
      name = "acs/acs1",
      vintage = year,
      vars = c("B01003_001E"),
      region = "place:75000",
      regionin = "state:06"
    ) %>%
    mutate(
      PopulationStockton = B01003_001E,
      year = year
    ) %>%
    dplyr::select(
      PopulationStockton,
      year
    )

  pop_stockton<- rbind(pop_stockton,temp)

}

emp_stockton <- data.frame(matrix(ncol=2,nrow=0))
colnames(emp_stockton) <- c("EmployedResidents","year")

for(year in 2010:2018){ 

  temp <-
    getCensus(
      name = "acs/acs1/subject",
      vintage = year,
      vars = c("S2301_C01_001E","S2301_C03_001E","S2301_C04_001E"),
      region = "place:75000",
      regionin = "state:06"
    ) %>%
    mutate(
      Population16andOlder = S2301_C01_001E,
      PercEmployedResidents = S2301_C03_001E,
      EmployedResidents = PercEmployedResidents/100*Population16andOlder,
      UnemploymentRate = S2301_C04_001E,
      year = year
    ) %>%
    dplyr::select(
      Population16andOlder,
      PercEmployedResidents,
      EmployedResidents,
      UnemploymentRate,
      year
    )

  emp_stockton<- rbind(emp_stockton,temp)

}

pop_emp_stockton_w_projection <-
  pop_sjc_w_projection %>%
  left_join(pop_stockton, by = "year") %>% 
  left_join(emp_stockton, by = "year") %>%
  mutate(
    PercStockton = PopulationStockton/Population,
    PercStocktonAdult = Population16andOlder/PopulationStockton,
    PercStockton = ifelse(
      !is.na(PercStockton),
      PercStockton,
      lm(
        formula = `PercStockton`[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = `PercStockton`[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    PopulationStockton = Population * PercStockton,
    PopulationStockton15andOlder = Population15andOlder * PercStockton,
    PercEmployedResidents = ifelse(
      !is.na(PercEmployedResidents),
      PercEmployedResidents,
      lm(
        formula = `PercEmployedResidents`[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = `PercEmployedResidents`[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    EmployedResidents = ifelse(
      !is.na(EmployedResidents),
      EmployedResidents,
      PopulationStockton15andOlder*PercEmployedResidents/100
    )
  )

# stockton_wac <-
#   2010:2017 %>%
#   map_dfr(function(year){
#     ca_wac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "wac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     temp <-
#       stockton_bgs_full %>%
#       geo_join(ca_wac, "GEOID", "w_bg")
# 
#     return(temp)
#   })
# 
# save(stockton_wac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_wac.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_wac.Rdata")

jobs_stockton <-
  stockton_wac %>% 
  group_by(year) %>% 
  summarize(Jobs = sum(C000))

#Add 2018 jobs projection
jobs_stockton[9,1] <- 2018
jobs_stockton[9,2] <- 
  lm(formula = jobs_stockton$Jobs[1:8] ~ jobs_stockton$year[1:8])$coefficients[1]+
  lm(formula = jobs_stockton$Jobs[1:8] ~ jobs_stockton$year[1:8])$coefficients[2]*2018

pop_jobs_stockton_w_projection <-
  pop_emp_stockton_w_projection %>%
  left_join(jobs_stockton, by = "year") %>%
  mutate(
    ratio = ifelse(
      !is.na(Jobs),
      Jobs/EmployedResidents,
      lm(
        formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    Jobs = ifelse(!is.na(Jobs),Jobs,EmployedResidents*ratio)
  ) %>%
  transmute(
    Year = year,
    Population = PopulationStockton,
    Jobs = Jobs,
    `Employed Residents` = EmployedResidents,
    `J/ER Ratio` = ratio,
    `Percent Employed Residents` = PercEmployedResidents,
    `Percent Unemployment` = UnemploymentRate
  )

pop_jobs_stockton_w_projection_table <-
  pop_jobs_stockton_w_projection %>%
  transmute(
    Year = Year,
    Population = prettyNum(round(Population,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `Employed Residents` = prettyNum(round(`Employed Residents`,-3),big.mark=","),
    `J/ER Ratio` = round(`J/ER Ratio`,2),
    `Percent Employed Residents` = paste0(round(`Percent Employed Residents`),"%"),
    `Percent Unemployment` = ifelse(is.na(`Percent Unemployment`),"NA",paste0(round(`Percent Unemployment`),"%"))
  )

# save(pop_jobs_stockton_w_projection, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/pop_jobs_stockton_w_projection.Rdata")

kable(
  pop_jobs_stockton_w_projection_table, 
  booktabs = TRUE,
  caption = 'Historical population and job counts for Stockton 2010-2018, followed by projections to 2040.'
  ) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

Stockton's jobs to employed residents ratio trend for 2010-2018 is notable; while it has been higher overall than the County's J/ER ratio this decade, it has been trending slightly downwards where the County's has been trending upwards. One possible explanation would be that Stockton has received an influx of residents who are working outside of Stockton; perhaps such residents have been displaced further from their place of work, and have moved to Stockton where they could find more affordable housing. Further analysis would be necessary to test this explanation and others. It's also important to acknowledge that many good jobs held by Stockton residents may be just outside of official Stockton borders, in the industrial zones and neighboring cities, which still contribute to the local economy; that is why it's useful to look at both the city and county levels. But if this preliminary analysis is indicative of a growing imbalance, then Stockton should focus on aggressive strategies to reverse the trend and bring more quality jobs within its borders. 

```{r stockton-jer, fig.cap = "Historical jobs to employed residents ratio for Stockton 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_stockton_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `J/ER Ratio`), size=2, colour = "forest green") +
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  labs(title = "Stockton, CA")
```

$~$

```{r stockton-projection, fig.cap = "Historical population, employed residents, and jobs for Stockton 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_stockton_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `Employed Residents`/100000, colour = "Employed Residents"), size = 2) +
  geom_line(aes(y = Jobs/100000, colour = "Jobs"), size = 2) +
  geom_line(aes(y = Population/100000, colour = "Population"), size = 2) + 
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=2, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=2, angle = 90, size=4) +
  scale_colour_manual(values = c("purple","blue","red")) + 
  labs(title = "Stockton, CA", y = "Count (100,000s)", colour = "")
```

$~$

Estimation of the average earnings of Stockton jobs is not possible using the QWI data from the previous section, which is only available at the County level. However, using LODES data, we can recreate a table of job counts by top-level NAICS industry sector (20 total).

```{r stockton-naics}
# stockton_rac <-
#   2010:2017 %>%
#   map_dfr(function(year){
#     ca_rac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "rac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     temp <-
#       stockton_bgs_full %>%
#       geo_join(ca_rac, "GEOID", "h_bg")
# 
#     return(temp)
#   })
# 
# save(stockton_rac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_rac.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_rac.Rdata")

jobs_stockton_residents <-
  stockton_rac %>%
  group_by(year) %>% 
  summarize_at(
    vars(CNS01:CNS20),
    sum,
    na.rm=T
  ) %>% 
  st_set_geometry(NULL) %>%
  gather(
    -year,
    key = "code",
    value = "Jobs"
  ) %>% 
  mutate(
    industry =
      case_when(
        code == "CNS01" ~ "Agriculture, Forestry, Fishing and Hunting",
        code == "CNS02" ~ "Mining, Quarrying, and Oil and Gas Extraction",
        code == "CNS03" ~ "Utilities",
        code == "CNS04" ~ "Construction",
        code == "CNS05" ~ "Manufacturing",
        code == "CNS06" ~ "Wholesale Trade",
        code == "CNS07" ~ "Retail Trade",
        code == "CNS08" ~ "Transportation and Warehousing",
        code == "CNS09" ~ "Information",
        code == "CNS10" ~ "Finance and Insurance",
        code == "CNS11" ~ "Real Estate and Rental and Leasing",
        code == "CNS12" ~ "Professional, Scientific, and Technical Services",
        code == "CNS13" ~ "Management of Companies and Enterprises",
        code == "CNS14" ~ "Administrative and Support and Waste Management and Remediation Services",
        code == "CNS15" ~ "Educational Services",
        code == "CNS16" ~ "Health Care and Social Assistance",
        code == "CNS17" ~ "Arts, Entertainment, and Recreation",
        code == "CNS18" ~ "Accommodation and Food Services",
        code == "CNS20" ~ "Public Administration",
        code == "CNS19" ~ "Other Services"
      )
  ) %>% 
  dplyr::select(-code)

jobs_stockton_residents_17 <-
  jobs_stockton_residents %>% 
  filter(year == 2017) %>%
  dplyr::select(-year) %>%
  arrange(desc(Jobs)) %>% 
  transmute(
    `NAICS Industry` = industry, 
    Jobs = prettyNum(round(Jobs,-2),big.mark=",")
  ) 

kable(
  jobs_stockton_residents_17, 
  booktabs = TRUE,
  caption = 'Job counts by NAICS industry sector for Stockton 2017.'
  ) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

## Green Jobs

While there are many possible ways to identify "green jobs", this report uses the [Bureau of Labor Statistics Green Jobs Initiative](https://www.bls.gov/green/home.htm) classification of 333 NAICS industries which it has determined to potentially contain jobs that meet its definition of green jobs:

- Jobs in businesses that produce goods or provide services that benefit the environment or conserve natural resources.
- Jobs in which workers' duties involve making their establishment's production processes more environmentally friendly or use fewer natural resources.

Specifically, those 333 potential industries were classified into the following sub-categories:

- 58 in "Energy from renewable sources"
- 140 in "Energy efficiency"
- 124 in "Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse"
- 75 in "Natural resource conservation"
- 45 in "Environmental compliance, education and training, and public awareness"

The following six tables filter the full Quarterly Workforce Indicators dataset to just the BLS-classified sectors, as well as further filtering in these five sub-categories. The top green job sectors span agriculture, building trades, and scientific research. This analysis is at the County level because the QWI data is only available at that scale.

```{r sjc-jobs}
green_jobs_classification <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/green_jobs_classification.csv")

green_jobs_summary <-
  green_jobs_classification %>% 
  mutate(naics4digit = substr(`NAICS 2007`,1,4)) %>% 
  group_by(naics4digit) %>% 
  summarize(
    total = n(),
    green = sum(`BLS GGS in scope` =="Y"),
    green1 = sum(!is.na(`1. Energy from renewable sources`)),
    green2 = sum(!is.na(`2. Energy Efficiency`)),
    green3 = sum(!is.na(`3. Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse`)),
    green4 = sum(!is.na(`4. Natural resource conservation`)),
    green5 = sum(!is.na(`5. Environmental compliance, education and training, and public awareness`))
  )

green_jobs_summary <-
  green_jobs_summary %>% 
  mutate_at(vars("green","green1","green2","green3","green4","green5"), function(x){x/green_jobs_summary$total}) %>% 
  filter(green > 0.5)

green_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary$naics4digit) %>% 
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green job category` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

$~$

```{r sjc-jobs1}
green1_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green1>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Energy from renewable sources` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green1_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Energy from renewable sources" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs2}
green2_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green2>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Energy Efficiency` = label, 
    Jobs = prettyNum(EmpS,big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(EarnS,big.mark=","))
  ) 

kable(
  green2_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Energy efficiency" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs3}
green3_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green3>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green3_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs4}
green4_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green4>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Natural resource conservation` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green4_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Natural resource conservation" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs5}
green5_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green5>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Environmental compliance, education and training, and public awareness` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green5_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Environmental compliance, education and training, and public awareness" for San Joaquin County 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

## 2005-2016 GHG Inventory

The State of California Governor's Office of Planning and Research recommends that California local governments follow ICLEI's [Community Greenhouse Gas Emissions Protocol](http://icleiusa.org/) when undertaking their greenhouse gas emissions inventories. ICLEI helped to produce Stockton's most recent [GHG Inventory in 2016](https://drive.google.com/open?id=1Zbb6apJ1eAT0BgLPOmBE0IYkDKZooUhd) which was compared to the previous inventory produced by ICF for the 2005 baseline year. The results from that report are copied below.

```{r iclei}
iclei_2005_2016 <-
  data.frame(
    "Year" = c(2005,2016),
    "Transportation" = c(1308696,1344846.19),
    "Solid Waste" = c(65720,61175),
    "Water/Wastewater" = c(115511,321486.42),
    "Agriculture" = c(928,947.298),
    "Commercial Energy" = c(369354,192191),
    "Industrial Energy" = c(60802,746225.84),
    "Residential Energy" = c(345862,267466),
    "Fugitive Emissions" = c(113080,159578.1397)
  ) %>% 
  rename(
    `Solid Waste` = Solid.Waste,
    `Water/Wastewater` = Water.Wastewater,
    `Commercial Energy` = Commercial.Energy,
    `Industrial Energy` = Industrial.Energy,
    `Residential Energy` = Residential.Energy,
    `Fugitive Emissions` = Fugitive.Emissions
  )

iclei_2005_2016_plot <-
  iclei_2005_2016 %>% 
  gather(
    key = "Type",
    value = "tCO2e",
    -Year
  ) %>% 
  arrange(Year,desc(tCO2e))

iclei_2005_2016_table <-
  iclei_2005_2016 %>% 
  transmute(
    Year = Year,
    Transportation = prettyNum(round(Transportation,-3),big.mark = ","),
    `Solid Waste` = prettyNum(round(`Solid Waste`,-3),big.mark = ","),
    `Water/Wastewater` = prettyNum(round(`Water/Wastewater`,-3),big.mark = ","),
    Agriculture = prettyNum(round(Agriculture,-2),big.mark = ","),
    `Commercial Energy` = prettyNum(round(`Commercial Energy`,-3),big.mark = ","),
    `Industrial Energy` = prettyNum(round(`Industrial Energy`,-3),big.mark = ","),
    `Residential Energy` = prettyNum(round(`Residential Energy`,-3),big.mark = ","),
    `Fugitive Emissions` = prettyNum(round(`Fugitive Emissions`,-3),big.mark = ",")
  )

kable(
  iclei_2005_2016_table, 
  booktabs = TRUE, 
  caption = 'Inventory comparisons for Stockton 2005-2016, from ICLEI. All units are in tCO2e.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r iclei-graph, fig.cap = "Inventory comparisons for Stockton 2005-2016, from ICLEI."}
iclei_2005_2016_plot %>% 
  mutate(
    Year = factor(
      as.character(Year), 
      levels = 
        c(
          "2016",
          "2005"
        )
      ),
    Type = factor(
      Type,
      levels = 
        c(
          "Transportation",
          "Solid Waste",
          "Water/Wastewater",
          "Agriculture",
          "Commercial Energy",
          "Industrial Energy",
          "Residential Energy",
          "Fugitive Emissions"
        )
    )
  ) %>% 
  ggplot() +
  geom_bar(
    aes(
      fill = Type, 
      x = Year, 
      weight = `tCO2e`
    ),
    position = "stack"
  ) +
  coord_flip() +
  theme(legend.position = "bottom") +
  labs(title = "GHG Inventory Comparisons for Stockton, 2005-2016", x = "Year", y = "tCO2e")
```

$~$

It is not within the scope of this project to formally update the 2016 ICLEI GHG Inventory for 2018, which is best completed by ICLEI or another similar organization. In fact, many of the significant components of ICLEI's formal GHG analysis, like "Water Energy" for example, are simply based off of an interpolation of population changes, given the lack of official data -- in other words, it is similar to what we have already done to project GHGs to 2040. We believe the following three focus areas are essential:

1. Normalization of the emissions by the incremental unit of activity, which is usually population, to understand the baseline rate of GHG emissions per actor. Unless we intend to directly limit the number of actors, these activity emission rates are fundamentally the factors that determine how large Stockton's footprint is. The reduction of activity emissions rates therefore becomes the critical problem to solve, either through behavior change, technology, or other means. We have already normalized overall emission sectors by jobs and population, but to get to the level of concrete green economy strategies, we will need to disaggregate further by specific key activities. The next few sections pursue this goal, focusing on some of the largest emitting activities: passenger vehicle driving and building energy.
2. Focusing on activity emissions rates also requires having direct measurement data in those same activity sectors to be able to calibrate our rates. For the two sectors we will focus on in the subsequent sections, passenger vehicle driving and building energy, there are fortunately recent public data sources we can use to calibrate our baseline rates, and we can expect these data sources to be available in the future so we can check whether rates have fallen in the ways we will have been hoping for, given our various strategic interventions. Part of our contribution through this project is to prepare scripts that can more easily update measurements in the future as soon as new public data is available, so that feedback can be obtained as efficiently as possible. These scripts also essentially help to update the most significant components of an overall GHG inventory analysis.
3. Since the availability of direct measurement data is critical to both the updating of GHG inventories and the understanding of the efficacy of our investments, we should also seek to increase the availability of direct measurement data in the sectors in which it is less readily available. These areas include industrial energy consumption (which is often restricted because of the California Public Utilities Commission's 15/15 rule, which means that utilities cannot provide data at aggregations with fewer than 15 customers or one customer greater than 15% of usage), water consumption (given the existence of private water providers), and waste production specific to Stockton residents (given that data is collected at the landfill but isn't disaggregated by truck routes or individual properties). These are all areas with opportunity for novel data sharing agreements to be negotiated by the City (e.g. the [PG&E Green Communities Program](https://www.pge.com/includes/docs/pdfs/mybusiness/environment/whatyoucando/greencommunities/GreenCommunities_SummaryPlanningReports.pdf), which effectively will enlist PG&E to directly complete the 3 steps outlined here for Stockton's building energy sector), and these efforts will improve the overall green economy initiative.

The following table shows a preliminary normalization of the 2005 and 2016 GHG emissions by residents and jobs, using the following allocation:

- Residential Energy and Transportation were allocated entirely to residents
- Commercial Energy, Agriculture, and Fugitive Emissions were allocated entirely to jobs
- Solid Waste and Water/Wastewater were distributed proportionally between residents and jobs
- Industrial Energy was not included, given the significant difference in methodology between 2005 and 2016 as documented by ICLEI

```{r iclei-norm}
# ca_wac_2005 <- 
#   grab_lodes(
#     state = "ca",
#     year = 2005,
#     lodes_type = "wac",
#     job_type = "JT01",
#     segment = "S000",
#     state_part = "main",
#     agg_geo = "bg"
#   )
# save(ca_wac_2005, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac_2005.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac_2005.Rdata")

stockton_jobs_2005 <-
  stockton_bgs_full %>%
  geo_join(ca_wac_2005, "GEOID", "w_bg") %>% 
  pull(C000) %>% 
  sum(na.rm = TRUE)

iclei_2005_2016_normalized <- 
  iclei_2005_2016 %>% 
  transmute(
    Year = Year,
    `Total tCO2e` = `Residential Energy` + `Commercial Energy` + Agriculture + `Fugitive Emissions` + `Solid Waste` + `Water/Wastewater` + Transportation,
    Population = unlist(c(
      278515,
      pop_stockton[which(pop_stockton$year == 2016),"PopulationStockton"]
    )),
    Jobs = unlist(c(
      stockton_jobs_2005,
      jobs_stockton[which(jobs_stockton$year == 2016),"Jobs"] %>% st_set_geometry(NULL)
    )),
    PercResident = Population/(Population + Jobs),
    PercJob = Jobs/(Population + Jobs),
    `tCO2e per Resident` = (`Residential Energy` + Transportation + PercResident*(`Solid Waste` + `Water/Wastewater`))/Population,
    `tCO2e per Job` = (`Commercial Energy` + Agriculture + `Fugitive Emissions` + PercJob*(`Solid Waste` + `Water/Wastewater`))/Population
  ) %>% 
  dplyr::select(-PercResident,-PercJob)

iclei_2005_2016_normalized_table <-
  iclei_2005_2016_normalized %>% 
  mutate(
    `Total tCO2e` = prettyNum(round(`Total tCO2e`,-3),big.mark = ","),
    Population = prettyNum(round(Population,-3),big.mark = ","),
    Jobs = prettyNum(round(Jobs,-3),big.mark = ","),
    `tCO2e per Resident` = round(`tCO2e per Resident`,2),
    `tCO2e per Job` = round(`tCO2e per Job`,2)
  )

kable(
  iclei_2005_2016_normalized_table, 
  booktabs = TRUE, 
  caption = 'Inventory comparisons for Stockton 2005-2016, normalized by residents and jobs. Industrial emissions were removed for this table because of the differences in methodology between 2005 and 2016.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

Based on the allocation assumptions, it appears that emissions per resident has decreased by 3.8% between 2005-2016, while emissions per job has decreased by 23%. These are both good signs, though there are gaps in the GHG inventories. Next, it is useful to drill down into the sub-sectors to reveal deeper insights.

## Origin-Destination Commute Analysis

As seen in the previous section, transportation is the largest single contributor of GHG emissions in Stockton, [as is true for all of California](https://ww2.arb.ca.gov/ghg-inventory-data). Within this sector, passenger vehicle emissions are by far the largest portion, and these are relatively easy to relate to their direct proxy, vehicle miles traveled (VMT), and normalize by drivers to understand current driving behavior. Specifically, commutes (driving to work) are the largest share of passenger vehicle emissions (other driving to/from amenities will be analyzed separately), and we can access data as recent as 2017 to understand commute patterns of Stockton residents to different job destinations inside and outside of SJC. What we find is that VMT is significant, and significantly locked in to the nature of job opportunity in faraway locations like the Bay Area. This means that VMT reduction is a crucial component in any overall green economy strategy, and it can be tackled directly through transportation strategies like public transit and EV deployment, but also indirectly by attracting high-quality jobs to Stockton, which on average will shift workers from faraway jobs to local jobs, thereby reducing VMTs. A comprehensive origin-destination commute analysis, as performed below, helps us quantify total VMTs attributable to commuting as well as model the specific impacts of different direct or indirect VMT reduction strategies.

In this section, we first examine the distribution of job locations for SJC in comparison to neighboring counties, as well as Stockton in particular. The following section will then analyze vehicle miles traveled for these commute trips.

### County-level Analysis

Our key dataset is from [Longitudinal Employer-Household Dynamics Origin-Destination Employment Statistics](https://lehd.ces.census.gov/data/) (LODES), which can be downloaded by state and is available up to 2017. 

Some reported workplaces in LODES are as far away as Los Angeles County and are likely data errors (e.g. the company headquarters is in Los Angeles but the actual workplace is much closer, or the employee works from home). These workplaces are left in the datasets shown in this section, but are removed later when calculating VMTs.

The LODES dataset also disaggregates jobs by three age groups:

- Number of jobs of workers age 29 or younger
- Number of jobs for workers age 30 to 54
- Number of jobs for workers age 55 or older

It also disaggregates jobs by three wage tiers:

- Number of jobs with earnings $1250/month or less
- Number of jobs with earnings \$1251/month to $3333/month
- Number of jobs with earnings greater than $3333/month 

It also disaggregates jobs by three broad sectors:

- Number of jobs in Goods Producing industry sectors
- Number of jobs in Trade, Transportation, and Utilities industry sectors
- Number of jobs in All Other Services industry sectors

The following table shows the counts of jobs in these subcategories that are held by SJC residents traveling to a workplace in SJC or its top 14 contiguous neighboring counties. The percent jobs shown are percentages of SJC employed residents; so of all SJC employed residents, 48% work within SJC.

```{r sjc-lodes-w-top-counties-table}
# for(year in 2002:2017){
# 
#   ca_lodes <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "od",
#       job_type = "JT01", #Primary Jobs
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "tract"
#     )
# 
#   for(county in county_neighbors$COUNTYFP){
#     county_tracts <-
#       ca_tracts %>%
#       filter(COUNTYFP == county)
# 
#     county_lodes_h <-
#       ca_lodes[which(ca_lodes$h_tract %in% county_tracts$GEOID),]
# 
#     save(county_lodes_h, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract_noroute.Rdata"))
# 
#   }
# }

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_077_2017_tract_noroute.Rdata")

sjc_lodes_w_counties <- 
  county_lodes_h %>% 
  mutate(
    COUNTY = substr(w_tract,3,5)
  ) %>% 
  group_by(COUNTY) %>% 
  summarise_at(
    c("S000","SA01","SA02","SA03","SE01","SE02","SE03","SI01","SI02","SI03"), 
    sum,
    na.rm=T
  ) %>% 
  transmute(
    County = COUNTY,
    Jobs = S000,
    `Percent Jobs` = S000/sum(S000, na.rm=T),
    `Percent of jobs for workers age 29 or younger` = SA01/sum(SA01, na.rm=T),
    `Percent of jobs for workers age 30 to 54` = SA02/sum(SA02, na.rm=T),
    `Percent of jobs for workers age 55 or older` = SA03/sum(SA03, na.rm=T),
    `Percent of jobs with earnings $1250/month or less` = SE01/sum(SE01, na.rm=T),
    `Percent of jobs with earnings $1251/month to $3333/month` = SE02/sum(SE02, na.rm=T),
    `Percent of jobs with earnings greater than $3333/month` = SE03/sum(SE03, na.rm=T),
    `Percent of jobs in Goods Producing industry sectors` = SI01/sum(SI01, na.rm=T),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = SI02/sum(SI02, na.rm=T),
    `Percent of jobs in All Other Services industry sectors` = SI03/sum(SI03, na.rm=T)
  ) %>% 
  arrange(desc(Jobs))

sjc_lodes_w_top_counties <- 
  sjc_lodes_w_counties[1:19,] %>% 
  left_join(ca_counties %>% 
  dplyr::select(COUNTYFP, NAME), by = c("County" = "COUNTYFP")) %>% 
  dplyr::select(-County) %>%
  dplyr::select(NAME,everything()) %>% 
  rename(County = NAME) %>% 
  arrange(desc(Jobs)) %>% 
  filter(!County %in% c("Los Angeles","San Bernardino","Orange","San Diego")) %>% 
  st_as_sf()

sjc_lodes_w_top_counties_table <- 
  sjc_lodes_w_top_counties %>% 
  st_set_geometry(NULL) %>% 
  transmute(
    `County (where SJC residents work)` = County,
    `Jobs (held by SJC residents)` = prettyNum(round(Jobs,-2),big.mark=","),
    `Percent jobs (held by SJC residents)` = paste0(round(`Percent Jobs`*100),"%"),
    `Percent of jobs for workers age 29 or younger` = paste0(round(`Percent of jobs for workers age 29 or younger`*100),"%"),
    `Percent of jobs for workers age 30 to 54` = paste0(round(`Percent of jobs for workers age 30 to 54`*100),"%"),
    `Percent of jobs for workers age 55 or older` = paste0(round(`Percent of jobs for workers age 55 or older`*100),"%"),
    `Percent of jobs with earnings $1250/month or less` = paste0(round(`Percent of jobs with earnings $1250/month or less`*100),"%"),
    `Percent of jobs with earnings $1251/month to $3333/month` = paste0(round(`Percent of jobs with earnings $1251/month to $3333/month`*100),"%"),
    `Percent of jobs with earnings greater than $3333/month` = paste0(round(`Percent of jobs with earnings greater than $3333/month`*100),"%"),
    `Percent of jobs in Goods Producing industry sectors` = paste0(round(`Percent of jobs in Goods Producing industry sectors`*100),"%"),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = paste0(round(`Percent of jobs in Trade, Transportation, and Utilities industry sectors`*100),"%"),
    `Percent of jobs in All Other Services industry sectors` = paste0(round(`Percent of jobs in All Other Services industry sectors`*100),"%")
  )

kable(
  sjc_lodes_w_top_counties_table, 
  booktabs = TRUE, 
  caption = 'Top 15 counties where SJC residents work, including SJC. Los Angeles, San Bernardino, Orange, and San Diego Counties were removed. Data from LODES, 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The following table compares SJC with neighboring counties in terms of the percentage of jobs held by its residents that are "local", meaning within the same county. This figure mirrors Figure \@ref(fig: compare-jer), which showed J/ER ratio for the same counties, all stagnating or in decline. The figure below provides one contribution, which is declining local jobs for local residents, not just for SJC but for its neighboring counties.

```{r county-localjobs, fig.cap="Percent of county residents who work within their home county, 2002 to 2017. Data from LODES."}
county_localjobs <- NULL

for(year in 2002:2017){
  for(county in county_neighbors$COUNTYFP){
    load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract_noroute.Rdata"))
    
    county_lodes_w_counties <- 
      county_lodes_h %>% 
      mutate(
        COUNTY = substr(w_tract,3,5)
      ) %>%
      group_by(COUNTY) %>% 
      summarise_at(
        c("S000","SA01","SA02","SA03","SE01","SE02","SE03","SI01","SI02","SI03"), 
        sum,
        na.rm=T
      ) %>% 
      transmute(
        Year = year,
        County = COUNTY,
        Jobs = S000,
        `Percent Jobs` = S000/sum(S000, na.rm=T),
        `Percent of jobs for workers age 29 or younger` = SA01/sum(SA01, na.rm=T),
        `Percent of jobs for workers age 30 to 54` = SA02/sum(SA02, na.rm=T),
        `Percent of jobs for workers age 55 or older` = SA03/sum(SA03, na.rm=T),
        `Percent of jobs with earnings $1250/month or less` = SE01/sum(SE01, na.rm=T),
        `Percent of jobs with earnings $1251/month to $3333/month` = SE02/sum(SE02, na.rm=T),
        `Percent of jobs with earnings greater than $3333/month` = SE03/sum(SE03, na.rm=T),
        `Percent of jobs in Goods Producing industry sectors` = SI01/sum(SI01, na.rm=T),
        `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = SI02/sum(SI02, na.rm=T),
        `Percent of jobs in All Other Services industry sectors` = SI03/sum(SI03, na.rm=T)
      ) %>% 
      filter(County == county) %>% 
      mutate(County = county_neighbors[which(county_neighbors$COUNTYFP == county),]$NAME)
    
    county_localjobs <-
      county_localjobs %>% 
      rbind(
        county_lodes_w_counties
      )
  }
}

county_localjobs %>% 
  filter(County %in% c("San Joaquin","Alameda","Fresno","Stanislaus","Sacramento","Contra Costa")) %>%
  ggplot(
    aes(
      x = Year,
      y = `Percent Jobs`,
      colour = County
    )
  ) +
  geom_line()
```

$~$

### City-level Analysis

The following table shows the counts of jobs in these subcategories for the top 15 contiguous neighboring counties to Stockton, including SJC. Note that the jobs being counted are those held by Stockton residents who are traveling to a workplace in the listed regions. 41% of Stockton employed residents work within Stockton. These jobs could be considered valuable for avoiding the "brain drain" of local talent to other places, as well as for creating the smallest transportation footprint.

```{r stockton-lodes-w-top-counties-table}
# for(year in 2002:2017){
# 
#   ca_lodes <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "od",
#       job_type = "JT01", #Primary Jobs
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "bg"
#     )
# 
#     stockton_lodes_h <-
#       ca_lodes[which(ca_lodes$h_bg %in% stockton_bgs_full$GEOID),]
# 
#     save(stockton_lodes_h, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,"_tract_noroute.Rdata"))
# 
# }

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017_tract_noroute.Rdata")

stockton_lodes_w_counties <- 
  stockton_lodes_h %>% 
  mutate(
    Workplace = ifelse(
      w_bg %in% stockton_bgs_full$GEOID,
      "75000",
      substr(w_bg,3,5)
    )
  ) %>% 
  group_by(Workplace) %>% 
  summarise_at(
    c("S000","SA01","SA02","SA03","SE01","SE02","SE03","SI01","SI02","SI03"), 
    sum,
    na.rm=T
  ) %>% 
  transmute(
    Workplace = Workplace,
    Jobs = S000,
    `Percent Jobs` = S000/sum(S000, na.rm=T),
    `Percent of jobs for workers age 29 or younger` = SA01/sum(SA01, na.rm=T),
    `Percent of jobs for workers age 30 to 54` = SA02/sum(SA02, na.rm=T),
    `Percent of jobs for workers age 55 or older` = SA03/sum(SA03, na.rm=T),
    `Percent of jobs with earnings $1250/month or less` = SE01/sum(SE01, na.rm=T),
    `Percent of jobs with earnings $1251/month to $3333/month` = SE02/sum(SE02, na.rm=T),
    `Percent of jobs with earnings greater than $3333/month` = SE03/sum(SE03, na.rm=T),
    `Percent of jobs in Goods Producing industry sectors` = SI01/sum(SI01, na.rm=T),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = SI02/sum(SI02, na.rm=T),
    `Percent of jobs in All Other Services industry sectors` = SI03/sum(SI03, na.rm=T)
  ) %>%  
  arrange(desc(Jobs))

#merge county shapefile with stockton geometry
ca_counties_and_stockton <-
  ca_counties %>% 
  dplyr::select(COUNTYFP, NAME) %>% 
  rbind(
    stockton_boundary %>% 
      mutate(
        COUNTYFP = PLACEFP
      ) %>% 
      dplyr::select(COUNTYFP, NAME)
  )

ca_counties_and_stockton[which(ca_counties_and_stockton$COUNTYFP == "077"),] <-
  st_difference(
    ca_counties_and_stockton[which(ca_counties_and_stockton$COUNTYFP == "077"),],
    ca_counties_and_stockton[which(ca_counties_and_stockton$NAME == "Stockton"),]
  ) %>% 
  dplyr::select(COUNTYFP,NAME)

ca_counties_and_stockton[which(ca_counties_and_stockton$COUNTYFP == "077"),]$NAME <-
  "San Joaquin (not including Stockton)"

stockton_lodes_w_top_counties <- 
  stockton_lodes_w_counties[1:19,] %>% 
  left_join(ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME), by = c("Workplace" = "COUNTYFP")) %>% 
  dplyr::select(-Workplace) %>%
  dplyr::select(NAME,everything()) %>% 
  rename(County = NAME) %>% 
  arrange(desc(Jobs)) %>% 
  filter(!County %in% c("Los Angeles","San Bernardino","Orange","San Diego")) %>% 
  st_as_sf()

stockton_lodes_w_top_counties_table <- 
  stockton_lodes_w_top_counties %>% 
  st_set_geometry(NULL) %>% 
  transmute(
    `Workplace (where Stockton residents work)` = County,
    `Jobs (held by Stockton residents)` = prettyNum(round(Jobs,-2),big.mark=","),
    `Percent jobs (held by Stockton residents)` = paste0(round(`Percent Jobs`*100),"%"),
    `Percent of jobs for workers age 29 or younger` = paste0(round(`Percent of jobs for workers age 29 or younger`*100),"%"),
    `Percent of jobs for workers age 30 to 54` = paste0(round(`Percent of jobs for workers age 30 to 54`*100),"%"),
    `Percent of jobs for workers age 55 or older` = paste0(round(`Percent of jobs for workers age 55 or older`*100),"%"),
    `Percent of jobs with earnings $1250/month or less` = paste0(round(`Percent of jobs with earnings $1250/month or less`*100),"%"),
    `Percent of jobs with earnings $1251/month to $3333/month` = paste0(round(`Percent of jobs with earnings $1251/month to $3333/month`*100),"%"),
    `Percent of jobs with earnings greater than $3333/month` = paste0(round(`Percent of jobs with earnings greater than $3333/month`*100),"%"),
    `Percent of jobs in Goods Producing industry sectors` = paste0(round(`Percent of jobs in Goods Producing industry sectors`*100),"%"),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = paste0(round(`Percent of jobs in Trade, Transportation, and Utilities industry sectors`*100),"%"),
    `Percent of jobs in All Other Services industry sectors` = paste0(round(`Percent of jobs in All Other Services industry sectors`*100),"%")
  )

kable(
  stockton_lodes_w_top_counties_table, 
  booktabs = TRUE, 
  caption = 'Top 15 workplaces where Stockton residents work. Includes Stockton as a workplace destination separate from the rest of SJC. All other listed workplaces are counties. Los Angeles, San Bernardino, Orange, and San Diego Counties were removed. Data from LODES, 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The following maps help to visualize the specific distribution of Stockton residents' jobs in the categories of age, earnings, and industry sector. 

37% of younger (under 29) Stockton employed residents work within Stockton, and another 15% work outside of Stockton but within SJC. Beyond that, there are higher concentrations of these younger workers in Sacramento and Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-youth, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of overall jobs for Stockton workers age 29 or younger located in workplace. Data from LODES, 2017."}
map = mapview(stockton_lodes_w_top_counties[-c(1,2),], zcol = "Percent of jobs for workers age 29 or younger", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>for workers age</br>29 or younger')

map@map
```

$~$

46% of lower-wage (less than $1,250/month) Stockton employed residents work within Stockton, and another 13% work outside of Stockton but within SJC. Beyond that, there is a higher concentration of these lower-wage workers in Sacramento County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-lowinc, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of overall jobs for Stockton workers with earnings $1250/month or less located in workplace. Data from LODES, 2017."}
map = mapview(stockton_lodes_w_top_counties[-c(1,2),], zcol = "Percent of jobs with earnings $1250/month or less", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>with earnings</br>$1250/month or less')

map@map
```

$~$

38% of higher-wage (greater than $3,333/month) Stockton employed residents work within Stockton, and another 12% work outside of Stockton but within SJC. Note these percentages are lower than the percentages of lower-wage jobs that remain local. Beyond that, there is a higher concentration of these high-wage workers in Alameda County compared to other neighboring counties. Perhaps targeted marketing of businesses that are providing these higher-wage jobs in Alameda County to move to Stockton could be an effective investment.

```{r stockton-lodes-w-top-counties-highinc, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of overall jobs for Stockton residents with earnings greater than $3333/month located in workplace. Data from LODES, 2017."}
map = mapview(stockton_lodes_w_top_counties[-c(1,2),], zcol = "Percent of jobs with earnings greater than $3333/month", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>with earnings</br>greater than</br>$3333/month')

map@map
```

$~$

30% of Stockton employed residents in Goods Producing industry sectors work within Stockton, and another 23% (a notably high percentage) work outside of Stockton but within SJC. Beyond that, there is a higher concentration of these high-wage workers in Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-goods, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of jobs for Stockton residents in Goods Producing industry sectors located in workplace. Data from LODES, 2017."}
map = mapview(stockton_lodes_w_top_counties[-c(1,2),], zcol = "Percent of jobs in Goods Producing industry sectors", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>in Goods Producing</br>industry sectors')

map@map
```

$~$

33% of Stockton employed residents in Trade, Transportation, and Utilities industry sectors work within Stockton, and another 18% work outside of Stockton but within SJC. Beyond that, there are higher concentrations of these high-wage workers in Sacramento and Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-trade, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of jobs for Stockton residents in Trade, Transportation, and Utilities industry sectors located in workplace. Data from LODES, 2017."}
map = mapview(stockton_lodes_w_top_counties[-c(1,2),], zcol = "Percent of jobs in Trade, Transportation, and Utilities industry sectors", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>in Trade, Transportation,</br>and Utilities</br>industry sectors')

map@map
```

$~$

48% (a notably high percentage) of Stockton employed residents in All Other Services industry sectors work within Stockton, and another 10% work outside of Stockton but within SJC. Beyond that, there is a higher concentrations of these high-wage workers in Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-services, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of jobs for Stockton residents in All Other Services industry sectors located in workplace. Data from LODES, 2017."}
map = mapview(stockton_lodes_w_top_counties[-c(1,2),], zcol = "Percent of jobs in All Other Services industry sectors", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>in All Other Services</br>industry sectors')

map@map
```

$~$

While LODES origin-destination data doesn't provide job types at a granularity lower than the three broad industry sector categories in the previous three maps, one possible assumption to make is that the distribution of NAICS industry sectors in a destination block group, which is available through the separate Workplace Area Characteristics dataset from LODES, is the same distribution for specifically Stockton residents who work in that block group. Using this assumption, we created estimates of the locations of specific types of industries and wage levels for Stockton employed residents.

The percentages in the table below should be interpreted as the % of overall jobs held by Stockton residents of that industry sector and wage tier that are based in San Joaquin County (the remainder being based in other counties). Particularly notable here are the low-percentage estimates of high-wage jobs in sectors generally related to the "knowledge economy": Finance and Insurance (38%), Information (28%), and Professional, Scientific, and Technical Services (19%). Also notable is the low percentage of high-wage jobs in Construction (35%), which may include specialized building trades such as solar installation. These percentages are relative to an overall 64% of high-wage jobs being based in SJC, which suggests that the best jobs in these notable industries are significantly underrepresented in the local economy.

```{r stockton-lodes-w-sjc-detail-table}
# ca_wac <-
#   2010:2017 %>%
#   map_dfr(function(year){
#     ca_wac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "wac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     return(ca_wac)
#   })
# 
# save(ca_wac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017_tract_noroute.Rdata")

stockton_lodes_h_join_wac <- 
  stockton_lodes_h %>% 
  dplyr::select(-c(year,state)) %>% 
  left_join(
    ca_wac %>% 
      filter(year == 2017), 
    by = "w_bg"
  )

stockton_lodes_h_join_wac_normalize <-
  stockton_lodes_h_join_wac %>% 
  mutate(
    goodsproducing = CNS01+CNS02+CNS04+CNS05,
    tradetransportutil = CNS03+CNS06+CNS07+CNS08,
    services = CNS09+CNS10+CNS11+CNS12+CNS13+CNS14+CNS15+CNS16+CNS17+CNS18+CNS19+CNS20
  ) %>% 
  mutate_at(
    .vars = vars(CNS01,CNS02,CNS04,CNS05),
    .funs = list(~ SI01*./goodsproducing)
  ) %>% 
  mutate_at(
    .vars = vars(CNS03,CNS06,CNS07,CNS08),
    .funs = list(~ SI02*./tradetransportutil)
  ) %>%
  mutate_at(
    .vars = vars(CNS09:CNS20),
    .funs = list(~ SI03*./services)
  ) %>% 
  dplyr::select(-c(SA01:SA03,C000:CE03,CR01:CFS05),SE01,SE02,SE03) %>% 
  mutate(low=SE01,mid=SE02,high=SE03) %>% 
  gather(key = "type", value, low:high) %>% 
  mutate_at(
    .vars = vars(CNS01:CNS20),
    .funs = list(~ ./S000*value)
  ) %>% 
  gather(key = "type2", value2, CNS01:CNS20) %>% 
  unite(temp,type,type2) %>% 
  spread(temp,value2) %>% 
  filter(value > 0) %>% 
  dplyr::select(-value)

stockton_lodes_w_counties_detail<-
  stockton_lodes_h_join_wac_normalize %>%
  mutate(
    Workplace = ifelse(
      w_bg %in% stockton_bgs_full$GEOID,
      "75000",
      substr(w_bg,3,5)
    )
  ) %>%
  group_by(Workplace) %>%
  summarise_at(
    vars(S000,SE01,SE02,SE03,high_CNS01:mid_CNS20),
    sum, 
    na.rm=T
  ) %>%
  mutate_at(
    .vars = vars(high_CNS01:mid_CNS20),
    .funs = list(~ round(.,0))
  )

stockton_lodes_w_sjc_detail <-
  rbind(
    stockton_lodes_w_counties_detail[which(stockton_lodes_w_counties_detail$Workplace == "75000"),-1],
    stockton_lodes_w_counties_detail[,-1] %>% 
    colSums()
  ) %>% 
  t() %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  mutate(
    perc = round(V1/V2*100,0),
    rowname = 
      case_when(
        rowname == "SE01" ~ "low_Total",
        rowname == "SE02" ~ "mid_Total",
        rowname == "SE03" ~ "high_Total",
        TRUE ~ rowname
      )
  ) %>% 
  dplyr::select(-V1,-V2) %>% 
  filter(!rowname %in% c("S000")) %>% 
  separate(
    rowname,
    into = c("wage","industry"),
    sep = "_"
  ) %>% 
  mutate(
    industry =
      case_when(
        industry == "CNS01" ~ "Agriculture, Forestry, Fishing and Hunting",
        industry == "CNS02" ~ "Mining, Quarrying, and Oil and Gas Extraction",
        industry == "CNS03" ~ "Utilities",
        industry == "CNS04" ~ "Construction",
        industry == "CNS05" ~ "Manufacturing",
        industry == "CNS06" ~ "Wholesale Trade",
        industry == "CNS07" ~ "Retail Trade",
        industry == "CNS08" ~ "Transportation and Warehousing",
        industry == "CNS09" ~ "Information",
        industry == "CNS10" ~ "Finance and Insurance",
        industry == "CNS11" ~ "Real Estate and Rental and Leasing",
        industry == "CNS12" ~ "Professional, Scientific, and Technical Services",
        industry == "CNS13" ~ "Management of Companies and Enterprises",
        industry == "CNS14" ~ "Administrative and Support and Waste Management and Remediation Services",
        industry == "CNS15" ~ "Educational Services",
        industry == "CNS16" ~ "Health Care and Social Assistance",
        industry == "CNS17" ~ "Arts, Entertainment, and Recreation",
        industry == "CNS18" ~ "Accommodation and Food Services",
        industry == "CNS20" ~ "Public Administration",
        industry == "CNS19" ~ "Other Services",
        TRUE ~ industry
      )
  ) %>% 
  spread(wage,perc) %>% 
  dplyr::select(
    `NAICS Industry` = industry,
    `% Stockton Jobs in Stockton with earnings $1250/month or less` = low,
    `% Stockton Jobs in Stockton with earnings $1251/month to $3333/month` = mid,
    `% Stockton Jobs in Stockton with earnings greater than $3333/month` = high
  )

stockton_lodes_w_sjc_detail_table <-
  rbind(
    stockton_lodes_w_sjc_detail[which(stockton_lodes_w_sjc_detail$`NAICS Industry`=="Total"),],
    stockton_lodes_w_sjc_detail[which(stockton_lodes_w_sjc_detail$`NAICS Industry`!="Total"),]
  ) %>% 
  mutate_at(
    .vars = vars(-`NAICS Industry`),
    .funs = list(~ paste0(.,"%"))
  )

kable(
  stockton_lodes_w_sjc_detail_table, 
  booktabs = TRUE, 
  caption = 'Percent of Stockton employed residents working in Stockton, by NAICS industry and wage tier. Data from LODES, 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The following maps highlight where some of these "underrepresented" jobs are distributed throughout the top counties where Stockton residents work.

```{r stockton-lodes-w-construction-high, fig.cap = "Top 10 counties where Stockton residents work, not including jobs in Stockton - number of high-wage jobs in Construction. Amount in Stockton: 900. Data from LODES, 2017."}
stockton_lodes_w_construction_high <-
  ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME) %>% 
  left_join(stockton_lodes_w_counties, by = c("COUNTYFP" = "Workplace")) %>% 
  left_join(stockton_lodes_w_counties_detail, by = c("COUNTYFP" = "Workplace")) %>% 
  dplyr::select(-COUNTYFP) %>%
  filter(!NAME %in% c("Stockton","Los Angeles","San Bernardino","Orange","San Diego","Riverside")) %>% 
  filter(!is.na(Jobs)) %>% 
  arrange(desc(Jobs)) %>% 
  dplyr::select(
    County = NAME,
    `Number of High-wage Construction jobs` = high_CNS04
  )

map = mapview(stockton_lodes_w_construction_high[1:10,], zcol = "Number of High-wage Construction jobs", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Number of</br>High-wage</br>Construction jobs')

map@map
```

$~$

```{r stockton-lodes-w-scientific-high, fig.cap = "Top 10 counties where Stockton residents work, not including jobs in Stockton - number of high-wage jobs in Professional, Scientific, and Technical Services. Amount in Stockton: 400. Data from LODES, 2017."}
stockton_lodes_w_scientific_high <-
  ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME) %>% 
  left_join(stockton_lodes_w_counties, by = c("COUNTYFP" = "Workplace")) %>% 
  left_join(stockton_lodes_w_counties_detail, by = c("COUNTYFP" = "Workplace")) %>% 
  dplyr::select(-COUNTYFP) %>%
  filter(!NAME %in% c("Stockton","Los Angeles","San Bernardino","Orange","San Diego","Riverside")) %>% 
  filter(!is.na(Jobs)) %>% 
  arrange(desc(Jobs)) %>% 
  dplyr::select(
    County = NAME,
    `Number of Professional, Scientific, and Technical Services jobs` = high_CNS12
  )

map = mapview(stockton_lodes_w_scientific_high[1:10,], zcol = "Number of Professional, Scientific, and Technical Services jobs", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Number of</br>Professional,</br>Scientific,</br>and Technical</br>Services jobs')

map@map
```

$~$

Note that for high-wage jobs in Professional, Scientific, and Technical Services, San Joaquin County isn't even the top employer of Stockton residents. 

## Commute Vehicle Miles Traveled

Building off the Origin-Destination Commute Analysis from the previous section, we isolated every unique pair of SJC or Stockton home block groups and work block groups and used the [Open Source Routing Machine](http://project-osrm.org/) to compute a distance (in miles) and duration (and hours) for a one-way trip. This analysis, combined with some estimates of mode choice (single-occupancy vehicle vs. carpool vs. other), we created estimates of vehicle miles traveled for a certain number of jobs and were able to see how see how SJC and Stockton residents have changed their driving behavior over time, and how that behavior has compared to neighboring counties. Finally, we used VMT to estimate the GHG footprint of commuting for Stockton residents. 

Our analysis in this section focuses on destinations with average commute times of less than 3 hours, which eliminates the unrealistic commutes while preserving more than 90% of reported commutes. We suspect that many of the other commutes with purported destinations like Los Angeles County are erroneously reported, and the actual workplace location is unavailable to us. Note, however, that it could be true that some workers commute to southern California, though not every weekday, and it also could be true to some workers commute by flight, which presents its own distinct and potentially significant GHG analysis which is outside the scope of this report.

### County-level Analysis

The following table shows commute data for SJC residents from 2011 to 2017, including estimates of the number of total jobs held by residents, the number of those jobs that are car-dependent, and the number of those jobs that are carpooled (according to ACS). The routing analysis provides distances between each origin and destination, which are totaled up to person miles traveled. The conversion to vehicle miles traveled is based on the following assumptions:

- For each origin-destination block group pair, we used ACS 1-yr 2017 data on commute mode by travel time for the origin block group to estimate a share of travelers commuting by single occupancy vehicle and by carpooling, and applied this factor to the count of jobs from LODES to estimate a total number of vehicle trips and vehicle mildes traveled (VMT).
- For carpool trips, we counted 2-person carpools as 1 vehicle for every 2 jobs, and 3-or-more-person carpools as 1 vehicle for every 3 jobs.

```{r county-commute-vmt-tractmode-table}
# for(year in 2011:2017){
#   for(county in c("013")){
# 
#     print(paste0(county,"-",year))
# 
#     ca_lodes <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "od",
#         job_type = "JT01", #Primary Jobs
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "tract"
#       )
#     
#     save(ca_lodes, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/ca_lodes_",year,"_tract.Rdata"))
# 
#     county_tracts <-
#       ca_tracts %>%
#       filter(COUNTYFP == county)
# 
#     county_lodes_h <-
#       ca_lodes[which(ca_lodes$h_tract %in% county_tracts$GEOID),]
# 
#     county_lodes_h_origin_centroids <-
#       st_centroid(ca_tracts[which(ca_tracts$GEOID %in% county_lodes_h$h_tract),])
# 
#     county_lodes_h_dest_centroids <-
#       st_centroid(ca_tracts[which(ca_tracts$GEOID %in% county_lodes_h$w_tract),])
# 
#     route <-
#       1:nrow(county_lodes_h) %>%
#       map_dfr(function(row){
#         print(row)
#         route <- osrmRoute(
#           src = county_lodes_h_origin_centroids[which(county_lodes_h_origin_centroids$GEOID %in% county_lodes_h[row,"h_tract"]),],
#           dst = county_lodes_h_dest_centroids[which(county_lodes_h_dest_centroids$GEOID %in% county_lodes_h[row,"w_tract"]),],
#           overview = FALSE
#         ) %>%
#           as.list() %>%
#           as.data.frame()
#         if(is_empty(route)){
#           return(
#             data.frame(
#               duration = NA,
#               distance = NA
#             )
#           )
#         } else {return(route)}
#       })
# 
#     county_lodes_h_route <-
#       county_lodes_h %>%
#       cbind(route)
# 
#     county_lodes_h_filter <-
#       county_lodes_h_route %>%
#       filter(duration < 180)
# 
#     save(county_lodes_h_route,county_lodes_h_filter, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract.Rdata"))
#   }
# }

# county_commute_vmt_tractmode <- NULL
# 
# for(year in 2011:2017){
#   for(county in c("013")){
#     print(paste0(year,"-",county))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract.Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs5_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#       getCensus(
#         name = "acs/acs5",
#         vintage = year,
#         region = "tract:*",
#         regionin = paste0("state:06+county:",county),
#         vars = "group(B08134)"
#       ) %>%
#       mutate(tract = paste0(state,county,tract)) %>%
#       select_if(!names(.) %in% c("GEO_ID","state","county","NAME")) %>%
#       dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#       gather(
#         key = "variable",
#         value = "estimate",
#         -tract
#       ) %>%
#       mutate(
#         label = acs_vars$label[match(variable,acs_vars$name)],
#         time = # This extracts only the time information from our label.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   max(unlist(gregexpr('!!',x)))+2
#                 )
#               }
#             ),
#             nchar(label)
#           ),
#         mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#                 )
#               }
#             ),
#             lapply(
#               label,
#               function(x){
#                 max(unlist(gregexpr('!!',x)))-1
#               }
#             )
#           )
#       ) %>%
#       filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#       filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#       dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(tract,time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   county_lodes_h_mode <-
#     county_lodes_h_filter %>%
#     transmute(
#       residence = h_tract,
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           tract,
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("residence" = "tract", "tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     county_commute_vmt_tractmode <-
#       rbind(county_commute_vmt_tractmode,
#         data.frame(
#           Year = year,
#           County = county,
#           person_miles = sum(county_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(county_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(county_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(county_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(county_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(county_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# 
#     save(county_commute_vmt_tractmode,file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")
#   }
# }
#
# county_commute_vmt_countymode <- NULL
# 
# for(year in 2011:2017){
#   for(county in c("013")){
# 
#     print(paste0(year,"-",county))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract.Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#     getCensus(
#       name = "acs/acs1",
#       vintage = year,
#       region = paste0("county:",county),
#       regionin = "state:06",
#       vars = "group(B08134)"
#     ) %>%
#     select_if(!names(.) %in% c("GEO_ID","state","NAME")) %>%
#     dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#     gather(
#       key = "variable",
#       value = "estimate",
#       -county
#     ) %>%
#     mutate(
#       label = acs_vars$label[match(variable,acs_vars$name)],
#       time = # This extracts only the time information from our label.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 max(unlist(gregexpr('!!',x)))+2
#               )
#             }
#           ),
#           nchar(label)
#         ),
#       mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#               )
#             }
#           ),
#           lapply(
#             label,
#             function(x){
#               max(unlist(gregexpr('!!',x)))-1
#             }
#           )
#         )
#     ) %>%
#     filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#     filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#     dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   county_lodes_h_mode <-
#     county_lodes_h_filter %>%
#     transmute(
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     county_commute_vmt_countymode <-
#       rbind(county_commute_vmt_countymode,
#         data.frame(
#           Year = year,
#           County = county,
#           person_miles = sum(county_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(county_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(county_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(county_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(county_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(county_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
#   }
# }
# 
# save(county_commute_vmt_countymode, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_countymode.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_countymode.Rdata")
# 
# county_commute_vmt_countymode %>% 
#   filter(jobs_car != 0) %>% 
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs,
#       colour = County
#     )
#   ) +
#   geom_line()
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_countymode.Rdata")
# 
# county_commute_vmt_compare <-
#   rbind(
#     county_commute_vmt_tractmode %>% 
#       mutate(type = "tract"),
#     county_commute_vmt_countymode %>% 
#       mutate(type = "county")
#   )
# 
# county_commute_vmt_compare %>% 
#   filter(jobs_car != 0) %>% 
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs,
#       linetype = type,
#       colour = County
#     )
#   ) +
#   geom_line()

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")

county_commute_vmt_tractmode_table <-
  county_commute_vmt_tractmode %>% 
  filter(County == "077") %>%
  left_join(county_neighbors, by = c("County" = "COUNTYFP")) %>% 
  transmute(
    Year = Year,
    `Jobs held by SJC residents` = prettyNum(round(jobs,-3),big.mark=","),
    `Car-dependent jobs` = prettyNum(round(jobs_car,-3),big.mark=","),
    `Carpooled jobs` = prettyNum(round(jobs_carpool,-3),big.mark=","),
    `Vehicles driven by SJC residents` = prettyNum(round(vehicles,-3),big.mark=","),
    `Person miles traveled` = prettyNum(round(person_miles,-4),big.mark=","),
    `Vehicle miles traveled` = prettyNum(round(vmt,-4),big.mark=",")
  )

kable(
  county_commute_vmt_tractmode_table,
  booktabs = TRUE,
  caption = 'Commute data for SJC residents, 2011 to 2017. Data from LODES.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

The following figure shows one-way commute VMT/job for SJC and its neighboring counties from 2011 to 2017. Note that this VMT/job ratio divides VMTs equally among all car-dependent jobs, leaving out non-car-dependent jobs (never more than 10% of jobs, as can be seen in the previous table).

SJC is at the top of the figure, 25 miles/job in 2017, vying with Stanislaus County to have the highest average commute distance per car-dependent worker.

```{r county-commute-vmt-tractmode-graph, fig.cap="One-way commute miles per car-dependent worker by county, 2011 to 2017. Data from LODES."}
county_commute_vmt_tractmode %>% 
  left_join(county_neighbors, by = c("County" = "COUNTYFP")) %>% 
  ggplot(
    aes(
      x = Year,
      y = vmt/jobs_car,
      colour = NAME
    )
  ) +
  geom_line() + 
  labs(y = "One-way commute VMT per\ncar-dependent worker") + 
  scale_color_discrete(name = "County")
```

$~$

One of the possible contributions to an increasing VMT/job isn't necessarily further away jobs but less carpooling to get to those jobs. The following figure shows that the percent of car-dependent SJC workers who carpool has declined from 2015 to 2017, similar to Stanislaus and Sacramento County.

```{r county-modeshare, fig.cap="Percent of car-dependent commuters traveling by carpool, by county, 2011 to 2017. Data from LODES and ACS."}
# county_modeshare <- NULL
# 
# for(year in 2011:2017){
#   for(county in county_neighbors$COUNTYFP){
#     
#     print(paste0(year,"-",county))
#     
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_",year,".Rdata"))
#     
#     travel_time_mode <-
#     getCensus(
#       name = "acs/acs1",
#       vintage = year,
#       region = paste0("county:",county),
#       regionin = "state:06",
#       vars = "group(B08134)"
#     ) %>%
#     select_if(!names(.) %in% c("GEO_ID","state","NAME")) %>%
#     dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#     gather(
#       key = "variable",
#       value = "estimate",
#       -county
#     ) %>%
#     mutate(
#       label = acs_vars$label[match(variable,acs_vars$name)],
#       time = # This extracts only the time information from our label.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 max(unlist(gregexpr('!!',x)))+2
#               )
#             }
#           ),
#           nchar(label)
#         ),
#       mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#               )
#             }
#           ),
#           lapply(
#             label,
#             function(x){
#               max(unlist(gregexpr('!!',x)))-1
#             }
#           )
#         )
#     ) %>%
#     filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#     filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#     dplyr::select(-variable,-label)
#     
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>% 
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
#     
#     county_modeshare <-
#       county_modeshare %>% 
#       rbind(
#         data.frame(
#           year = year,
#           county = county,
#           jobs = travel_time_mode_summary$jobs,
#           perc_jobs_car = travel_time_mode_summary$perc_jobs_car,
#           perc_jobs_carpool = travel_time_mode_summary$perc_jobs_carpool,
#           perc_vehicle = travel_time_mode_summary$perc_vehicle
#         )
#       )
#   }
# }
# 
# save(county_modeshare, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_modeshare.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_modeshare.Rdata")
# 
# county_modeshare %>% 
#   filter(county %in% c("077","001","013","067","099")) %>% 
#   filter(jobs != 0) %>% 
#   left_join(county_neighbors, by = c("county" = "COUNTYFP")) %>% 
#   ggplot(
#     aes(
#       x = year,
#       y = perc_jobs_carpool/perc_jobs_car*100,
#       colour = NAME
#     )
#   ) +
#   geom_line() +
#   labs(x = "Year", y = "% Car-dependent workers who carpool") + 
#   scale_color_discrete(name = "County")

county_commute_vmt_tractmode %>% 
  left_join(county_neighbors, by = c("County" = "COUNTYFP")) %>% 
  ggplot(
    aes(
      x = Year,
      y = jobs_carpool/jobs_car,
      colour = NAME
    )
  ) +
  geom_line() + 
  labs(y = "% Car-dependent workers who carpool") + 
  scale_color_discrete(name = "County")
```

$~$

### City-level Analysis

The following graph shows the distribution of workplaces by distance from home for Stockton residents.

```{r stockton-commute-vmt-distribution-2017, fig.cap="Distribution of workplaces by distance from home for Stockton employed residents. Trips greater than 3 hours are removed. Data from LODES, 2017."}
# for(year in 2011:2017){
#   
#   print(year)
#   
#   ca_lodes <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "od",
#       job_type = "JT01", #Primary Jobs
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "bg"
#     )
#   
#   stockton_lodes_h <-
#     ca_lodes[which(ca_lodes$h_bg %in% stockton_bgs_full$GEOID),]
#   
#   stockton_lodes_h_origin_centroids <-
#     st_centroid(ca_bgs[which(ca_bgs$GEOID %in% stockton_lodes_h$h_bg),])
#   
#   stockton_lodes_h_dest_centroids <-
#     st_centroid(ca_bgs[which(ca_bgs$GEOID %in% stockton_lodes_h$w_bg),])
#   
#   route <-
#     1:nrow(stockton_lodes_h) %>%
#     map_dfr(function(row){
#       print(row)
#       route <- osrmRoute(
#         src = stockton_lodes_h_origin_centroids[which(stockton_lodes_h_origin_centroids$GEOID %in% stockton_lodes_h[row,"h_bg"]),],
#         dst = stockton_lodes_h_dest_centroids[which(stockton_lodes_h_dest_centroids$GEOID %in% stockton_lodes_h[row,"w_bg"]),],
#         overview = FALSE
#       ) %>%
#         as.list() %>%
#         as.data.frame()
#       if(is_empty(route)){
#         return(
#           data.frame(
#             duration = NA,
#             distance = NA
#           )
#         )
#       } else {return(route)}
#     })
#   
#   stockton_lodes_h_route <-
#     stockton_lodes_h %>%
#     cbind(route)
#   
#   stockton_lodes_h_filter <-
#     stockton_lodes_h_route %>%
#     filter(duration < 180)
#   
#   save(stockton_lodes_h_route,stockton_lodes_h_filter, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,".Rdata"))
# }

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017_tract.Rdata")

ggplot(
  stockton_lodes_h_filter, 
  aes(
    x = as.numeric(distance)/1.60934, 
    weight = S000
  )
) +
  geom_histogram(binwidth = 5) +
  labs(title = "Workplace Commute Distance to Work for Stockton Employed Residents", x = "Commute Distance to Work, Miles", y = "Number of Residents")
```

$~$

The map below demonstrates the extent of geographic spread of Stockton residents across the greater Northern California region, potentially on a day-to-day basis. Most of the tracts shown have only a handful of estimated Stockton workers, but interesting concentrations of workers can be seen by zooming in and hovering over areas like the East Bay.

```{r stockton-jobs-map, fig.cap="Tracts where Stockton residents work - number of jobs. Data from LODES, 2017."}
stockton_jobs_map <-
  stockton_lodes_h_filter %>% 
  group_by(w_tract) %>% 
  summarize(
    `Jobs held by Stockton residents` = sum(S000, na.rm=T)
  ) %>% 
  left_join(ca_tracts, by = c("w_tract" = "GEOID")) %>%
  st_as_sf()

map = mapview(stockton_jobs_map, zcol = "Jobs held by Stockton residents", col.regions = colorRampPalette(c("snow", "black", "grey")), map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Jobs held by</br>Stockton residents')

map@map
```

$~$

The previous map can be considered in combination with the map below, which essentially shows the average distance in miles traveled one-way by Stockton workers to those tracts. Evidently, workers traveling to further-away tracts are responsible for a disproportionate share of the transportation emissions compared to other Stockton workers.

```{r stockton-commute-avg, fig.cap="Tracts where Stockton residents work - average commute time, in hours. Data from LODES, 2017."}
stockton_commute_avg <-
  stockton_lodes_h_filter %>% 
  group_by(w_tract) %>% 
  summarize(
    `Average Commute Time, Hours` = mean(duration, na.rm=T)
  ) %>% 
  left_join(ca_tracts, by = c("w_tract" = "GEOID")) %>%
  st_as_sf()

map = mapview(stockton_commute_avg, zcol = "Average Commute Time, Hours", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Average Commute</br>Time, Hours')

map@map
```

$~$

Similar to the county-level analysis, we calculated the change in VMT/job over time, which might give more important relative insight given the many assumptions that go into the specific quantity of VMTs in any given year.

```{r stockton-commute-vmt-table}
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")

stockton_commute_vmt_tractmode_table <-
  stockton_commute_vmt_tractmode %>% 
  transmute(
    Year = Year,
    `Commute One-Way VMT` = prettyNum(round(vmt,-3), big.mark=","),
    `Workers` = prettyNum(round(jobs,-3), big.mark=","),
    `One-Way VMT/Workers` = round(vmt/jobs_car,1),
    `% Car-Dependent Workers who Carpool` = paste0(round(jobs_carpool/jobs_car*100,1),"%")
  )

kable(
  stockton_commute_vmt_tractmode_table,
  booktabs = TRUE,
  caption = 'Stockton commute one-way VMT from 2011-2017. Data from LODES and ACS 1-yr.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The average one-way commute trip for the Stockton worker appears to have increased by 13% over the last 6 years. This could be explained by existing residents changing to jobs that are further and further away from home, where better employment opportunities can be found, and by new residents moving to Stockton to find affordable housing but retaining their faraway jobs.

The following figure compares Stockton and SJC VMT/job. The trends are similar, though Stockton residents commute less distance than SJC residents overall.

```{r stockton-commute-vmt-tractmode, fig.cap="One-way commute miles per car-dependent worker in Stockton vs. SJC, 2011 to 2017. Data from LODES."}
# stockton_commute_vmt_bgmode <- NULL
# 
# for(year in 2011:2017){
#     print(year)
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,".Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs5_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#       getCensus(
#         name = "acs/acs5",
#         vintage = ifelse(
#           year < 2013,
#           2013,
#           year
#         ),
#         region = "block group:*",
#         regionin = "state:06+county:077",
#         vars = "group(B08134)"
#       ) %>%
#       mutate(bg = paste0(state,county,tract,block_group)) %>%
#       select_if(!names(.) %in% c("GEO_ID","state","county","tract","block_group","NAME")) %>%
#       dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#       gather(
#         key = "variable",
#         value = "estimate",
#         -bg
#       ) %>%
#       mutate(
#         label = acs_vars$label[match(variable,acs_vars$name)],
#         time = # This extracts only the time information from our label.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   max(unlist(gregexpr('!!',x)))+2
#                 )
#               }
#             ),
#             nchar(label)
#           ),
#         mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#                 )
#               }
#             ),
#             lapply(
#               label,
#               function(x){
#                 max(unlist(gregexpr('!!',x)))-1
#               }
#             )
#           )
#       ) %>%
#       filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#       filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#       dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(bg,time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   stockton_lodes_h_mode <-
#     stockton_lodes_h_filter %>%
#     transmute(
#       residence = h_bg,
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           bg,
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("residence" = "bg", "tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     stockton_commute_vmt_bgmode <-
#       rbind(stockton_commute_vmt_bgmode,
#         data.frame(
#           Year = year,
#           person_miles = sum(stockton_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(stockton_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(stockton_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(stockton_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(stockton_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(stockton_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# 
#     save(stockton_commute_vmt_bgmode,file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_bgmode.Rdata")
# }
#
# stockton_commute_vmt_tractmode <- NULL
# 
# for(year in 2011:2017){
#     print(year)
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,"_tract.Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs5_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#       getCensus(
#         name = "acs/acs5",
#         vintage = year,
#         region = "tract:*",
#         regionin = "state:06+county:077",
#         vars = "group(B08134)"
#       ) %>%
#       mutate(tract = paste0(state,county,tract)) %>%
#       select_if(!names(.) %in% c("GEO_ID","state","county","NAME")) %>%
#       dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#       gather(
#         key = "variable",
#         value = "estimate",
#         -tract
#       ) %>%
#       mutate(
#         label = acs_vars$label[match(variable,acs_vars$name)],
#         time = # This extracts only the time information from our label.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   max(unlist(gregexpr('!!',x)))+2
#                 )
#               }
#             ),
#             nchar(label)
#           ),
#         mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#                 )
#               }
#             ),
#             lapply(
#               label,
#               function(x){
#                 max(unlist(gregexpr('!!',x)))-1
#               }
#             )
#           )
#       ) %>%
#       filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#       filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#       dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(tract,time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   stockton_lodes_h_mode <-
#     stockton_lodes_h_filter %>%
#     transmute(
#       residence = h_tract,
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           tract,
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("residence" = "tract", "tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     stockton_commute_vmt_tractmode <-
#       rbind(stockton_commute_vmt_tractmode,
#         data.frame(
#           Year = year,
#           person_miles = sum(stockton_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(stockton_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(stockton_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(stockton_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(stockton_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(stockton_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# 
#     save(stockton_commute_vmt_tractmode,file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")
# }
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")
# 
# stockton_commute_vmt_tractmode %>%
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs
#     )
#   ) +
#   geom_line()
# 
# stockton_commute_vmt_countymode <- NULL
# 
# for(year in 2011:2017){
# 
#   print(year)
# 
#   load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,"_tract.Rdata"))
# 
#   load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_",year,".Rdata"))
# 
#   travel_time_mode <-
#     getCensus(
#       name = "acs/acs1",
#       vintage = year,
#       region = "county:077",
#       regionin = "state:06",
#       vars = "group(B08134)"
#     ) %>%
#     select_if(!names(.) %in% c("GEO_ID","state","NAME")) %>%
#     dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#     gather(
#       key = "variable",
#       value = "estimate",
#       -county
#     ) %>%
#     mutate(
#       label = acs_vars$label[match(variable,acs_vars$name)],
#       time = # This extracts only the time information from our label.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 max(unlist(gregexpr('!!',x)))+2
#               )
#             }
#           ),
#           nchar(label)
#         ),
#       mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#               )
#             }
#           ),
#           lapply(
#             label,
#             function(x){
#               max(unlist(gregexpr('!!',x)))-1
#             }
#           )
#         )
#     ) %>%
#     filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#     filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#     dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   stockton_lodes_h_mode <-
#     stockton_lodes_h_filter %>%
#     transmute(
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     stockton_commute_vmt_countymode <-
#       rbind(stockton_commute_vmt_countymode,
#         data.frame(
#           Year = year,
#           person_miles = sum(stockton_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(stockton_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(stockton_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(stockton_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(stockton_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(stockton_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# }
# 
# save(stockton_commute_vmt_countymode, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_countymode.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_countymode.Rdata")
# 
# stockton_commute_vmt_countymode %>%
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs
#     )
#   ) +
#   geom_line()
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_bgmode.Rdata")
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_countymode.Rdata")
# 
# stockton_commute_vmt_compare <-
#   rbind(
#     stockton_commute_vmt_bgmode %>% 
#       mutate(mode = "block group"),
#     stockton_commute_vmt_tractmode %>% 
#       mutate(mode = "tract"),
#     stockton_commute_vmt_countymode %>% 
#       mutate(mode = "county")
#   )
# 
# stockton_commute_vmt_compare %>%
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs,
#       linetype = mode
#     )
#   ) +
#   geom_line()

county_commute_vmt_tractmode %>% 
  filter(County == "077") %>% 
  ggplot(
    aes(
      x = Year,
      y = vmt/jobs_car,
      linetype = "SJC"
    )
  ) +
  geom_line() + 
  geom_line(
    data = stockton_commute_vmt_tractmode,
    aes(
      x = Year,
      y = vmt/jobs_car,
      linetype = "Stockton"
    )
  ) +
  labs(y = "One-way commute miles\nper car-dependent worker", linetype = "Group")
```

$~$

The following figure compares the percent of car-dependent workers who carpool in Stockton and SJC. Stockton workers overall are more likely to carpool than SJC workers overall, but the trends are again similar between Stockton and SJC, with a decline in carpooling in the last two years of data.

```{r stockton-county-commute-vmt-compare, fig.cap="Percent of car-dependent commuters traveling by carpool, Stockton vs. SJC, 2011 to 2017. Data from LODES and ACS."}
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")

stockton_county_commute_vmt_compare <-
  rbind(
    county_commute_vmt_tractmode %>% 
      filter(County == "077") %>% 
      dplyr::select(-County) %>% 
      mutate(type = "SJC"), 
    stockton_commute_vmt_tractmode %>% 
      mutate(type = "Stockton")
  )

stockton_county_commute_vmt_compare %>%
  ggplot(
    aes(
      x = Year,
      y = jobs_carpool/jobs_car*100,
      linetype = type
    )
  ) +
  geom_line() +
  labs(y = "% Car-dependent workers who carpool", linetype = "Group")
```

$~$

We estimated the total and average GHG emissions for Stockton workers commuting to each of the top 15 counties (filtering out counties further than 3 hours away). We made the following assumptions:

- For daily VMT, each vehicle was assumed to take 2 one-way trips.
- To convert daily VMT to annual VMT, the same annualization factor was used as ICLEI: 369.39. The factor appears to account for both expected reductions in VMT because of sick days, as well as expected increases in VMT because of chained trips.
- All vehicles were assumed to be passenger vehicles with an average mpg of 29.2 in 2017 and CO2e emissions of 303 g/mi (0.000334 tCO2e/mi), using data from the [EPA Automotive Trends Report](https://www.epa.gov/automotive-trends/explore-automotive-trends-data). Disregarding SUVs and trucks has the effect of underestimating emissions. 

The following table is sorted by total annual GHG from transportation.

```{r ghg}
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017.Rdata")

stockton_lodes_h_counties_ghg <- 
  stockton_lodes_h_mode %>%
  st_set_geometry(NULL) %>% 
  mutate(
    Workplace = ifelse(
      workplace %in% stockton_bgs_full$GEOID,
      "75000",
      substr(workplace,3,5)
    )
  ) %>%
  group_by(Workplace) %>%
  summarise_at(
    vars(jobs,person_miles,person_hours,vehicles,vmt),
    sum, na.rm=T
  ) %>% 
  mutate(
    perc_jobs = jobs/sum(jobs),
    annual_vmt = vmt*2*369.39,
    annual_ghg = annual_vmt*0.000334,
    perc_ghg = annual_ghg/sum(annual_ghg),
    avg_ghg = annual_ghg/jobs
  ) %>% 
  left_join(ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME), by = c("Workplace" = "COUNTYFP")) %>% 
  dplyr::select(-Workplace) %>%
  dplyr::select(NAME,everything()) %>% 
  st_as_sf() %>% 
  arrange(desc(annual_ghg))
  
stockton_lodes_h_counties_ghg_table <- 
  stockton_lodes_h_counties_ghg[1:15,] %>%
  transmute(
    `Workplace (where Stockton residents work)` = NAME,
    `Jobs (held by Stockton residents)` = prettyNum(round(jobs,-2),big.mark=","),
    `Percent Jobs` = paste0(round(perc_jobs*100),"%"),
    `VMT (millions)` = prettyNum(round(annual_vmt/1000000),big.mark=","),
    `Total Annual GHG (tCO2e)` = prettyNum(round(annual_ghg,-3),big.mark=","),
    `Percent Annual GHG` = paste0(round(perc_ghg*100),"%"),
    `Average Annual GHG/worker (tCO2e)` = round(avg_ghg,1)
  )

kable(
  stockton_lodes_h_counties_ghg_table %>% st_set_geometry(NULL),
  booktabs = TRUE,
  caption = 'Top 15 workplaces where Stockton residents work, GHG emissions from transportation. Includes Stockton as a workplace destination separate from the rest of SJC. All other listed workplaces are counties. Los Angeles, San Bernardino, Orange, and San Diego Counties were removed. Data from LODES, 2017.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

According to the table above, 59% percent of Stockton residents work in San Joaquin County and collectively contribute 18% of all commute GHGs. The next 14 counties comprise another 38% of Stockton residents, but they collectively contribute 76% of all commute GHGs. This significant difference comes down to difference in average commute distance to each county, which is directly related to average GHG emissions per worker. In a later section, we will explore opportunities to stimulate local job creation so that some of these long-distance commutes can be converted into local commutes, reducing both the toll on the environment and the tolls on health and well-being for Stockton residents.

```{r ghg-map-2, fig.cap="Top 15 Counties where Stockton residents work - annual GHG emissions from driving. Data from LODES, 2017."}
map = mapview(stockton_lodes_h_counties_ghg[1:15,], zcol = "annual_ghg", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Total Annual</br>GHG (tCO2e)')

map@map
```

$~$

## Non-commute Vehicle Miles Traveled

## Energy

After transportation, buildings are the next largest source of emissions based on the ICLEI GHG inventories. Our best source of energy data is from [PG&E's Energy Data Request Program](https://pge-energydatarequest.com/public_datasets), which provides total customers, total kWh of electricity, and total therms of gas usage per zipcode per month dating back to 2013. We used the following zip code tabulation areas (ZCTAs), close proxies of customer zip codes, to represent Stockton.

```{r zcta, fig.cap = "Zip code tabulation areas used to represent Stockton population estimates. The red outline is the official city boundary."}
zcta <- zctas(starts_with="95") %>% 
  mutate(ZCTA5CE10 = as.numeric(ZCTA5CE10))
# zips_stockton <- st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ZipCodes/ZipCodes.shp") %>% st_transform(st_crs(zcta)) #this was downloaded from Stockton GIS site to do a quick visual check of the difference between ZCTA and zip code. We determined they were pretty much the same.

stockton_boundary_influence <- st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/SpheresOfInfluence/SpheresOfInfluence.shp", quiet = TRUE) %>% 
  filter(SPHERE == "STOCKTON") %>% 
  st_transform(st_crs(zcta)) #stockton boundary is legit but really spotty, so i prefer using sphere of influence from the County GIS page.

#2 of the 3 shapes are tiny little triangles to get rid of.
stockton_boundary_influence <- stockton_boundary_influence[1,] 

zcta_stockton <- zcta[stockton_boundary_influence,] %>% 
  filter(!ZCTA5CE10 %in% c("95242","95240","95336","95330")) %>% 
  dplyr::select(ZCTA5CE10) %>% 
  rename(ZIPCODE = ZCTA5CE10) %>% 
  mutate(ZIPCODE = as.numeric(ZIPCODE))
  #these are some extraneous zip codes that just barely touch the sphere of influence that i manually decided to remove.
# zcta_stockton <- zcta[which(zcta$ZCTA5CE10 %in% st_centroid(zcta)[stockton_boundary_influence,]$ZCTA5CE10),] #this would be the go-to script to do a location by centroid within, but it's not as useful in this specific case.

map = mapview(zcta_stockton$geometry) + mapview(stockton_boundary$geometry, alpha.regions = 0, color = "red", lwd = 4)

map@map
```

$~$

PG&E's data had some minor formatting errors that were manually corrected:

- For 2014 Q3 Gas, fields "Total Therms" and "Average Therms" renamed to match the fields in all other datasets.
- For 2017 Q4 Electricity and 2017 Q4 Gas, duplicate September values were removed.

Also, because of privacy regulations, the PG&E data has many gaps in industrial and agricultural energy usage. Even though industrial energy usage may be a significant contributor to emissions, as the ICLEI report suggests, without more consistent data we decided to leave industrial energy analysis out of our report. 

After downloading and aggregating the PG&E residential and commercial data by month and year, we converted electricity and gas energy usage to tCO2e. For gas, we converted therms to tCO2e based a factor from the [U.S. Energy Information Administration](https://www.eia.gov/environment/emissions/co2_vol_mass.php) (assuming that PG&E's natural gas emits at this rate, and that it doesn’t change from year to year). For electricity, we converted kWh to tCO2e for the appropriate year using the table provided by PG&E in their [2019 Corporate Responsibility Report](http://www.pgecorp.com/corp_responsibility/reports/2019/en02_climate_change.html), under the table titled "Benchmarking Greenhouse Gas Emissions for Delivered Electricity". Because the latest emissions data is 210 lbs CO2 per MWh for 2017, and SB 100 signed into law September 2018 requires state energy agencies to adopt a 100 percent clean energy by 2045 planning goal, we assume the emissions factor will decrease by 7.5 lbs CO2 per MWh each year, resulting in a value of 202.5 for 2018.

```{r summary-TCO2E-average-table}
#Note: Elec- Industrial mostly 0's, 95206 suddenly shows up with ~70 customers in 2014 Q3/Q4, 2015 Q1, 2016 M2/M3, 2018 M6/M9

pge_elec_emissions_factor <-
  data.frame(
    year = c(2013:2018,2020,2025,2030,2035,2040),
    factor = c(427,434.92,404.51,293.67,210,202.5,187.5,150,112.5,75,37.5)
  )
# 
# pge_data <-
#   2013:2018 %>% # Supply a list of years, 2013 to 2018. Recall the syntax for a list of numbers from past assignments.
#   map_dfr(function(year){ # This is another variation of map() that automatically binds rows together into a dataframe (what we used rbindlist() in the past for), assuming you’re working with dataframes. Otherwise it works exactly the same way as map().
# 
#     factor <- pge_elec_emissions_factor$factor[match(year,pge_elec_emissions_factor$year)] # You will want to use match() to get the correct emissions factor from the lookup table you made in the previous chunk. Refer back to the lines where we used match() on acs_vars in the past for the correct syntax.
# 
#     1:4 %>% # Look closely at the PG&E datasets and you’ll see that the data is organized by quarter, and we’ll need to refer to the quarter in the filename when we load CSVs. Supply a list of quarters here.
#       map_dfr(function(quarter){
# 
#         c("Electric","Gas") %>% # The datasets are either for Electricity or Gas. Look carefully at how these are written in the filenames, and supply a c() with both strings here.
#           map_dfr(function(type){
# 
#             filename <-
#               paste0(
#                 "F:/Data Library/PG&E/PGE_",
#                 year,
#                 "_Q",
#                 quarter,
#                 "_",
#                 type,
#                 "UsageByZip.csv"
#               )
# 
#             data <- # This will load the CSV and then manipulate
#               read_csv(filename) %>%
#               rename_all(toupper) %>% # This is part of cleaning the messy CSVs, since sometimes the field names were lowercase and sometimes they were uppercase. This makes them all uppercase so there is no issue referring to them below.
#               filter(ZIPCODE %in% zcta_stockton$ZIPCODE) %>%
#               mutate(
#                 CUSTOMERCLASS =
#                   case_when(
#                     CUSTOMERCLASS == "Elec- Residential" ~ "ER",
#                     CUSTOMERCLASS == "Gas- Residential" ~ "GR",
#                     CUSTOMERCLASS == "Elec- Commercial" ~ "EC",
#                     CUSTOMERCLASS == "Elec- Industrial" ~ "EI",
#                     CUSTOMERCLASS == "Elec- Agricultural" ~ "EA",
#                     TRUE ~ "GC"
#                   ),
#                 TOTALKBTU =
#                   ifelse(
#                     substr(CUSTOMERCLASS,1,1) == "E",
#                     TOTALKWH*3.4121416331,
#                     TOTALTHM*99.9761
#                   ),
#                 TOTALTCO2E =
#                   ifelse(
#                     substr(CUSTOMERCLASS,1,1) == "E",
#                     TOTALKWH*factor/1000*0.000453592,
#                     TOTALTHM*0.00531
#                   )
#               ) %>%
#               dplyr::select(
#                 ZIPCODE,
#                 YEAR,
#                 MONTH,
#                 CUSTOMERCLASS,
#                 TOTALKBTU,
#                 TOTALTCO2E,
#                 TOTALCUSTOMERS
#               )
# 
#           })
# 
#       })
# 
#   }) %>%
#   mutate(
#     KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS,
#     TCO2EPERCUST = TOTALTCO2E/TOTALCUSTOMERS
#   )
# 
# save(pge_data, file= "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_pge.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_pge.Rdata")

summary_TCO2E_average <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA")) %>%
  mutate(
    ENERGYTYPE = substr(CUSTOMERCLASS,1,1)
  ) %>% 
  group_by(ZIPCODE, ENERGYTYPE, YEAR) %>%
  summarize(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALTCO2E = sum(TOTALTCO2E, na.rm=T), 
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  group_by(ENERGYTYPE, YEAR) %>%
  summarize_at(
    vars(TOTALKBTU,TOTALTCO2E,TOTALCUSTOMERS),
    sum,
    na.rm=T
  ) %>% 
  ungroup()

summary_TCO2E_average_table <-
  summary_TCO2E_average %>% 
  arrange(YEAR) %>% 
  transmute(
    Year = YEAR,
    `Energy Type` = 
      ifelse(
        ENERGYTYPE == "E",
        "Electricity",
        "Gas"
      ),
    `Total Annual Customers` = prettyNum(round(TOTALCUSTOMERS,-3), big.mark=","),
    `Total GBTU` = prettyNum(round(TOTALKBTU/1000000,-2), big.mark=","),
    `Total tCO2e` = prettyNum(round(TOTALTCO2E,-3), big.mark=",")
  )

kable(
  summary_TCO2E_average_table,
  booktabs = TRUE,
  caption = 'Stockton annual residential and commercial energy usage, 2013 to 2018. Data from PG&E.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

The graphs below illustrate that total energy usage (in kBTU) for electricity and gas has stayed roughly level across the last six years, but given that electricity has become cleaner through renewable power sources, the overall carbon footprint of electricity has decreased dramatically in comparison to gas.

```{r summary-kBTU-average, fig.cap="Stockton annual residential and commercial energy usage, 2013 to 2018, in kBTU. Data from PG&E."}
ggplot(
  summary_TCO2E_average, 
  aes(
    x = as.factor(YEAR), 
    y = TOTALKBTU/1000000
  )
) + 
  geom_bar(stat = "identity", aes(fill = ENERGYTYPE), position = "dodge") + 
  labs(x = "Year", y = "GBTU", title = "Stockton Annual Energy Usage, 2013 to 2018") + 
  scale_fill_discrete(name="Energy Type",labels = c("Electricity","Gas"))
```

$~$

```{r summary-TCO2E-average, fig.cap="Stockton annual residential and commercial energy usage, 2013 to 2018, in tCO2e. Data from PG&E."}
ggplot(
  summary_TCO2E_average, 
  aes(
    x = as.factor(YEAR), 
    y = TOTALTCO2E
  )
) + 
  geom_bar(stat = "identity", aes(fill = ENERGYTYPE), position = "dodge") + 
  labs(x = "Year", y = "tCO2e", title = "Stockton Annual Energy Usage, 2013 to 2018") + 
  scale_fill_discrete(name="Energy Type",labels = c("Electricity","Gas"))
```

$~$

The following graph plots monthly tCO2e for electricity vs. gas. The peaks in gas usage occur in January, corresponding to heating load, and the peaks in electricity usage occur in July, corresponding to cooling load, and overall decreasing as previously noted. As we'll explore in a later section, electrification of air and water heating in buildings may be a particularly effective strategy to shift the peak gas consumption to less carbon-intensive electricity loads.

```{r summary-TCO2E-monthly, fig.cap = "Stockton monthly residential and commercial energy usage, 2013 to 2018, in tCO2e. Data from PG&E."}
summary_TCO2E_monthly <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA")) %>%
  mutate(
    ENERGYTYPE = substr(CUSTOMERCLASS,1,1),
    MONTH = paste0(as.character(YEAR),substr(as.character(round(MONTH/100,2)),2,4))
  ) %>% 
  group_by(MONTH, ENERGYTYPE) %>%
  summarize_at(
    vars(TOTALKBTU,TOTALTCO2E,TOTALCUSTOMERS),
    sum,
    na.rm=T
  ) %>% 
  ungroup() %>% 
  mutate(
    MONTH =
      as.Date(
        paste0(
          gsub(
            "\\.",
            "\\/",
            ifelse(
              nchar(MONTH) == 6,
              paste0(MONTH,"0"),
              MONTH
            )
          ),
          "/01"
        )
      )
  )

ggplot(
  summary_TCO2E_monthly, 
  aes(
    x = MONTH, 
  )
) + 
  geom_line(
    aes(
      y = TOTALTCO2E,
      color = ENERGYTYPE
    )
  ) + 
  labs(x = "Month", y = "tCO2e", title = "Stockton Monthly Energy Usage, 2013 to 2018") + 
  scale_color_manual(
    name= "Energy Type",
    values = c("blue","red"),
    labels = c("Electricity","Gas")
  ) +
  scale_x_date(
    name = 'Year', 
    date_breaks = '1 year',
    date_labels = '%Y'
  )
```

$~$

Note that heating and cooling loads, which appear to contribute to significant seasonal variation within years, is also heavily dependent on the specific weather in any given year, typically measured in heating degree days (HDDs) and cooling degree days (CDDs). A more accurate comparison of annual energy consumption would control for change in HDDs and CDDs year-to-year; a more accurate forecasting of energy consumption into the future would also factor in climate model predictions of future HDDs and CDDs.

We used the [Cal-Adapt Degree Day tool](https://cal-adapt.org/tools/degree-days) to collect HDDs and CDDs for Stockton from 2010 to 2018, and on to 2040, using the average simulation (CanESM2) under the Representative Concentration Pathway (RCP) 4.5 scenario (in which global GHG emissions peak around 2040, then decline). The graph below shows the data from Cal-Adapt, as well as linear trendlines, with a clear overall upwards trend for CDDs (meaning that temperatures are rising and more cooling power is needed), and a clear overall downwards trend for HDDs. 

```{r hdd-cdd, fig.cap="Stockton heating and cooling degree days under RCP 4.5 scenario, 2010 to 2040. Data from Cal-Adapt."}
hdd <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/hdd.csv") %>% 
  transmute(
    YEAR = year,
    hdd = degree_days
  )
cdd <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/cdd.csv") %>% 
  filter(model == "CanESM2") %>% 
  transmute(
    YEAR = year,
    cdd = degree_days
  )

hdd %>% 
  filter(YEAR >= 2010 & YEAR <=2040) %>% 
  left_join(cdd, by = "YEAR") %>% 
  ggplot(
    aes(
      x = YEAR
    )
  ) + 
  geom_line(
    aes(
      y = hdd,
      colour = "Heating",
      linetype = "Cal-Adapt"
    )
  ) +
  geom_smooth(
    aes(
      y = hdd,
      colour = "Heating",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_line(
    aes(
      y = cdd,
      colour = "Cooling",
      linetype = "Cal-Adapt"
    )
  ) +
  geom_smooth(
    aes(
      y = cdd,
      colour = "Cooling",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Historical\n", color = "dark grey", x=2018, y=2600, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=2600, angle = 90, size=4) +
  scale_colour_manual(values = c("red","blue")) + 
  scale_linetype_manual(values = c("solid","dotted")) +
  labs(title = "Stockton Heating and Cooling Degree Days", y = "Degree Days", colour = "")
```

$~$

The following table shows historical 2013-2018 annual energy usage per capita (residents for residential energy, jobs for commercial energy) per degree day (HDDs for gas, CDDs for electricity), and the graph that follows shows these four energy use factors with downward trends. This may be through a combination of changing building energy efficiency as well as changing building utilization (e.g. more or less space per occupant), though we don't have the data to be able to separate these two factors.

```{r summary-TCO2E-norm-all}
summary_TCO2E_norm <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA")) %>%
  group_by(ZIPCODE, CUSTOMERCLASS, YEAR) %>%
  summarize(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALTCO2E = sum(TOTALTCO2E, na.rm=T), 
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  group_by(CUSTOMERCLASS, YEAR) %>%
  summarize_at(
    vars(TOTALKBTU,TOTALTCO2E,TOTALCUSTOMERS),
    sum,
    na.rm=T
  ) %>% 
  left_join(hdd, by = "YEAR") %>% 
  left_join(cdd, by = "YEAR") %>% 
  left_join(pop_stockton, by = c("YEAR" = "year")) %>% 
  left_join(jobs_stockton, by = c("YEAR" = "year"))

summary_TCO2E_norm_ER <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "ER") %>% 
  mutate(
    KBTU_res_cdd =
      TOTALKBTU/PopulationStockton/cdd,
    TCO2E_res_cdd = 
      TOTALTCO2E/PopulationStockton/cdd
  )

summary_TCO2E_norm_GR <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "GR") %>% 
  mutate(
    KBTU_res_hdd =
      TOTALKBTU/PopulationStockton/hdd,
    TCO2E_res_hdd = 
      TOTALTCO2E/PopulationStockton/hdd
  )

summary_TCO2E_norm_EC <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "EC") %>% 
  mutate(
    KBTU_job_cdd =
      TOTALKBTU/Jobs/cdd,
    TCO2E_job_cdd = 
      TOTALTCO2E/Jobs/cdd
  )

summary_TCO2E_norm_GC <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "GC") %>% 
  mutate(
    KBTU_job_hdd =
      TOTALKBTU/Jobs/hdd,
    TCO2E_job_hdd = 
      TOTALTCO2E/Jobs/hdd
  )

summary_TCO2E_norm_all <-
  summary_TCO2E_norm_ER %>% 
  ungroup() %>% 
  transmute(
    Year = YEAR,
    `Heating Degree Days` = prettyNum(round(hdd,-2),big.mark=","),
    `Cooling Degree Days` = prettyNum(round(cdd,-2),big.mark=","),
    Residents = prettyNum(round(PopulationStockton,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `Residential Electricity, kBTU/resident/CDD` = round(KBTU_res_cdd,1)
  ) %>% 
  mutate(
    `Residential Gas, kBTU/resident/HDD` = round(summary_TCO2E_norm_GR$KBTU_res_hdd,1),
    `Commercial Electricity, kBTU/job/CDD` = round(summary_TCO2E_norm_EC$KBTU_job_cdd,1),
    `Commercial Gas, kBTU/job/HDD` = round(summary_TCO2E_norm_GC$KBTU_job_hdd,1)
  )
  
kable(
  summary_TCO2E_norm_all,
  booktabs = TRUE,
  caption = 'Stockton annual energy use per capita per degree-day, 2013 to 2018.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

```{r summary-TCO2E-norm-all-graph, fig.cap="Stockton annual energy use per capita per degree-day, 2013 to 2018."}
summary_TCO2E_norm_all %>%
  ggplot(
    aes(
      x = Year
    )
  ) +
  geom_line(
    aes(
      y = `Residential Electricity, kBTU/resident/CDD`,
      colour = "Residential Electricity\n(kBTU/resident/CDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Residential Electricity, kBTU/resident/CDD`,
      colour = "Residential Electricity\n(kBTU/resident/CDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  )+
  geom_line(
    aes(
      y = `Residential Gas, kBTU/resident/HDD`,
      colour = "Residential Gas\n(kBTU/resident/HDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Residential Gas, kBTU/resident/HDD`,
      colour = "Residential Gas\n(kBTU/resident/HDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_line(
    aes(
      y = `Commercial Electricity, kBTU/job/CDD`,
      colour = "Commercial Electricity\n(kBTU/job/CDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Commercial Electricity, kBTU/job/CDD`,
      colour = "Commercial Electricity\n(kBTU/job/CDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_line(
    aes(
      y = `Commercial Gas, kBTU/job/HDD`,
      colour = "Commercial Gas\n(kBTU/job/HDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Commercial Gas, kBTU/job/HDD`,
      colour = "Commercial Gas\n(kBTU/job/HDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  scale_colour_manual(values = c("red","blue","orange", "green")) +
  scale_linetype_manual(values = c("solid","dotted")) +
  labs(title = "Stockton Energy Use per Capita per Degree-Day", y = "kBTU/cap/degree-day", colour = "Energy Factor", linetype = "Data Type")
```

$~$

A full forecast of energy usage will also depend on predicted changes in resident and job populations, which will lead to more buildings and more energy used in buildings, predicted changes in building energy efficiency and utilization, predicted changes in weather, and many other factors that are outside the scope of this analysis. One last available dataset to incorporate into our understanding of energy use relates to buildings.

## Buildings

2018 data from the local County Assessor's Office includes property use type and total building square footage for every parcel in Stockton. Because the assessor's record of total building square footage is of poor quality, we chose to instead use [Microsoft's U.S. Building Footprint Data](https://github.com/microsoft/USBuildingFootprints), joined each building footprint to a parcel (thereby also assigning a residential or commercial type based on the zoning of the parcel), and multiplied this footprint area by number of stories, which came either from the assessor's record or from the Microsoft data. This dataset may still contain significant errors (e.g. mixed use parcels are mis-identified, the stories record may be incorrect, Microsoft's building footprints may be incorrect, etc.), but we decided it was the best representation of total building square footage in Stockton. 

The following maps show the density of residents per acre across Stockton, followed by the density of jobs per acre of commercials buildings, at the block group level. Residential population was obtained from ACS 2017 5-yr data, and job count was obtained from LODES 2017.

```{r residential-density, fig.cap="Stockton residents per 1,000 sqft of residential building area, per block group."}
pge_stockton_filtered <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA") & (YEAR == 2018)) %>%
  dplyr::select(-YEAR,-TOTALTCO2E,-TCO2EPERCUST)

zips_spread <- 
  pge_stockton_filtered %>% 
  group_by(ZIPCODE, CUSTOMERCLASS) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  mutate(KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS) %>% 
  gather(key = "type", value, TOTALKBTU:KBTUPERCUST) %>% 
  unite(temp,CUSTOMERCLASS,type) %>% 
  spread(temp,value) 

#next, since the previous line fully disaggregates by type AND class, but i also consider it valuable to disaggregate by type OR class individually on their own, i do a second and third spread. all of these "spreads" will be joined back to an original in the final step.
zips_spread_2 <- 
  pge_stockton_filtered %>% 
  group_by(ZIPCODE, CUSTOMERCLASS) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  ungroup() %>% 
  mutate(ENERGYTYPE = substr(CUSTOMERCLASS,1,1)) %>% 
  dplyr::select(-CUSTOMERCLASS) %>% 
  group_by(ZIPCODE, ENERGYTYPE) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = sum(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  mutate(KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS) %>% 
  gather(key = "type", value, TOTALKBTU:KBTUPERCUST) %>% 
  unite(temp,ENERGYTYPE,type) %>% 
  spread(temp,value)

#note that when combining into SECTOR, say electricity and gas for commercial, the summary function for TOTALCUSTOMERS switches to max(), with the reasoning that many of these commercial customers have both electricity and gas, so we would assume that the correct total # of customers is closer to the max of either, than to add them together (which presumes that there are no overlapping electricity and gas customers).
zips_spread_3 <- 
  pge_stockton_filtered %>%
  group_by(ZIPCODE, CUSTOMERCLASS) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  ungroup() %>% 
  mutate(SECTOR = substr(CUSTOMERCLASS,2,2)) %>% 
  dplyr::select(-CUSTOMERCLASS) %>% 
  group_by(ZIPCODE, SECTOR) %>% 
  summarise(TOTALKBTU = sum(TOTALKBTU, na.rm=T),
            TOTALCUSTOMERS = max(TOTALCUSTOMERS, na.rm=T)) %>% 
  mutate(KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS) %>% 
  gather(key = "type", value, TOTALKBTU:KBTUPERCUST) %>% 
  unite(temp,SECTOR,type) %>% 
  spread(temp,value)

#the final step here is to get the actual total totals for kbtu and TCO2E indicators, and then join all the "subtotals" from the previous 3 spreads.
zips_total <- 
  pge_stockton_filtered %>% 
  group_by(ZIPCODE) %>% 
  summarize(TOTALKBTU = sum(TOTALKBTU, na.rm=T)) %>% 
  left_join(zips_spread_3, by = "ZIPCODE") %>% 
  mutate(TOTALCUSTOMERS = R_TOTALCUSTOMERS + C_TOTALCUSTOMERS) %>% 
  left_join(zips_spread_2, by = "ZIPCODE") %>% 
  left_join(zips_spread, by = "ZIPCODE")

#join this massive summary back to the zcta geometries
zcta_stockton_joined <- 
  zcta_stockton %>% 
  left_join(zips_total, by="ZIPCODE")

#below I've brought in all the code from stockton_bldg.R, but it can all be skipped by going to the load() of stockton_bldg.Rdata at the bottom. Kevin, whatever refinements you've made, go ahead and make them here.

# sjc_bldg <- 
#   read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/ca_06077_footprints.csv") %>% 
#   st_as_sf(wkt = "WKT") %>% 
#   st_set_crs(4326) %>% 
#   st_transform(st_crs(zcta_stockton)) %>% 
#   mutate(id = row_number())
# 
# stockton_bldg <- 
#   sjc_bldg[which(sjc_bldg$id %in% st_centroid(sjc_bldg)[stockton_boundary_influence,]$id),]
# 
# sjc_parcels <- 
#   st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Parcels/Parcels.shp") %>% 
#   st_transform(st_crs(zcta_stockton)) %>% 
#   st_make_valid()
# 
# save(sjc_parcels, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Parcels/sjc_parcels.Rdata")
# 
# stockton_parcels <- 
#   sjc_parcels[stockton_boundary_influence,]
# 
# bldg_parcel_join <- 
#   st_join(st_centroid(stockton_bldg), stockton_parcels) %>%
#   dplyr::select(APN, id, STAREA__) %>% 
#   rename(area = STAREA__) %>% 
#   st_set_geometry(NULL)
# 
# sjc_zoning <- 
#   st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Zoning/Zoning.shp") %>% 
#   st_transform(st_crs(zcta_stockton)) %>% 
#   filter(ZNLABEL != "STOCKTON")
# 
# stockton_zoning <- 
#   st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Stockton_Zoning/Zoning.shp") %>% 
#   st_transform(st_crs(zcta_stockton))
# 
# bldg_zoning_join <- 
#   st_join(st_centroid(stockton_bldg), stockton_zoning) %>% 
#   dplyr::select(ZONE, id) %>% 
#   st_set_geometry(NULL)
# 
# bldg_zoning_join_uninc <- 
#   st_join(st_centroid(stockton_bldg), sjc_zoning) %>% 
#   dplyr::select(ZNCODE, id) %>% 
#   st_set_geometry(NULL)
# 
# bldg_zoning_join %<>% 
#   merge(bldg_zoning_join_uninc) %>% 
#   mutate(ZONE = ifelse(is.na(ZONE),as.character(ZNCODE),as.character(ZONE))) %>% 
#   dplyr::select(ZONE, id)
# 
# sjc_bgs <- 
#   block_groups("California", "San Joaquin County")
# 
# stockton_bgs <- 
#   sjc_bgs[stockton_boundary_influence,]
# 
# bldg_bg_join <- 
#   st_join(st_centroid(stockton_bldg), stockton_bgs) %>% 
#   dplyr::select(GEOID, id) %>% 
#   st_set_geometry(NULL)
# 
# bldg_zcta_join <- 
#   st_join(st_centroid(stockton_bldg), zcta_stockton) %>% 
#   dplyr::select(ZIPCODE, id) %>% 
#   st_set_geometry(NULL)
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/tax_sjc.Rdata")
# 
# tax_sjc <- 
#   tax_sjc %>% 
#   mutate(APN = as.numeric(apn)) %>% 
#   st_set_geometry(NULL)
# 
# stockton_bldg_final <-
#   stockton_bldg %>%
#   left_join(bldg_parcel_join, by="id") %>%
#   left_join(bldg_zoning_join, by="id") %>%
#   left_join(bldg_bg_join, by="id") %>%
#   left_join(bldg_zcta_join, by="id") %>%
#   left_join(tax_sjc, by="APN") %>%
#   mutate( # the following takes the bldg data, computes bldgground (ground footprint, where the factor conversion is sqm to sqft) and bldgtot (total sqft).
#     bldgground = as.numeric(st_area(WKT))*10.7639,
#     bldgtot =
#       ifelse(
#         is.na(stories),
#         bldgground,
#         bldgground*stories
#       ),
#     ZIPCODE = as.numeric(ZIPCODE),
#     ZONING = 
#       case_when(
#         substr(ZONE,1,1) == "R" ~ "R",
#         substr(ZONE,1,2) == "(R" ~ "R",
#         substr(ZONE,1,1) %in% c("C","P","M","U") ~ "C", 
#         substr(ZONE,1,2) %in% c("(C","(P") ~ "C",
#         TRUE ~ "O"
#       )
#   )
# 
# save(stockton_bldg_final, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_bldg.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_bldg.Rdata")
# 
# stockton_bldg_17 <- 
#   readOGR(dsn = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/Stockton2017", layer = "Stockton") %>% 
#   st_as_sf() %>% 
#   st_transform(st_crs(stockton_bldg_final))
# 
# save(stockton_bldg_17, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/stockton_bldg_17.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/stockton_bldg_17.Rdata")

# # match height from 2017 data
# bldg_join <-
#   stockton_bldg_final %>%
#   st_join(
#     stockton_bldg_17 %>%
#       st_transform(26910) %>%
#       st_buffer(-1) %>%
#       st_transform(st_crs(stockton_bldg_final))
#   ) %>%
#   group_by(id) %>%
#   summarize(
#     Height = mean(Height,na.rm=T)
#   ) %>%
#   left_join(stockton_bldg_final %>% st_set_geometry(NULL),by="id")
# 
# bldg_join <-
#   bldg_join %>% 
#   mutate(
#     stories_by_height =
#       case_when(
#         GEOID == "060770039001" ~ 1, #Naval base
#         is.na(Height) & is.na(stories) ~ 1,
#         is.na(Height) ~ round(stories),
#         !is.na(stories) ~ round(stories),
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==1),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==1),]$Height) ~ 1,
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==2),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==2),]$Height) ~ 2,
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==3),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==3),]$Height) ~ 3,
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==4),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==4),]$Height) ~ 4,
#         TRUE ~ round(Height/5)
#       ),
#     bldg_tot =
#       bldgground*stories_by_height
#   )
# # 6033 unmatched when using -1m buffer. #2637 of those did not have assessor stories data, set to 1F. Of other 3396, 2090 1F, 1248 2F, 58 3F.
# # 70757 had both 2017 heights and assessor stories data, go with assessor stories data. 51676 had assessor stories = 1, kept at 1F. 18974 had assessor stories = 2, kept at 2F. 107 had assessor stories > 2, set to 2.5F.
# # mean height for assessor 1F: 11.30, sd 1.63. mean height for assessor 2F: 13.98, sd 2.25. mean height for assessor 3F: 15.39, sd 2.99. mean height for assessor 4F: 14.42, sd 5.35.
# # 24660 had no assessor stories data but had 2017 heights, use mean + 1 sd from above as thresholds. 1F: 12.92. 2F: 16.23. 3F: 18.38. 4F: 19.77
# # 15991 1F, 5642 2F, 908 3F, 1512 4F, 541 5F, 29 6F, 12 7F, 15 8F, 4 9F, 5 10F, 1 12F.
# 
# save(bldg_join, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/bldg_join.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/bldg_join.Rdata")

bg_bldg <-
  bldg_join %>% 
  st_set_geometry(NULL) %>% 
  group_by(GEOID, ZONING) %>% 
  summarize(
    numbldg = n(),
    bldgtot = sum(bldgtot, na.rm=T)
  ) %>% 
  ungroup() %>% 
  left_join(stockton_bgs_full, by = "GEOID") %>% 
  st_as_sf() %>% 
  filter(!is.na(st_dimension(.)))

#res/sqft per block group
bg_pop <-
  getCensus(
    name = "acs/acs5",
    vintage = 2017, # satellite imagery is from around 2014/2015
    vars = c("B01003_001E"),
    region = "block group:*",
    regionin = "state:06+county:077"
  ) %>%
  transmute(
    GEOID = paste0(state,county,tract,block_group),
    pop = B01003_001E
  )

bg_bldg_norm_r <-
  bg_bldg %>% 
  filter(ZONING == "R") %>% 
  left_join(bg_pop, by = "GEOID") %>% 
  mutate(
    `Residents per 1,000 sqft` = pop/bldgtot*1000,
    residential_density = bldgtot/(as.numeric(st_area(.))/4046.86)
  )

map = mapview(bg_bldg_norm_r,zcol=c("residential_density"), legend = TRUE, layer.name = "Residential</br>density</br>per acre")

map@map
```

$~$

```{r commercial-density, fig.cap="Stockton jobs per 1,000 sqft of commercial building area, per block group."}
# bldg_norm_r <-
#   bg_bldg %>% 
#   filter(ZONING == "R") %>% 
#   left_join(bg_pop, by = "GEOID") %>% 
#   summarize(
#     pop = sum(pop, na.rm=T),
#     bldgtot = sum(bldgtot, na.rm=T)
#   ) %>% 
#   mutate(`Residents/1000sqft` = pop/bldgtot*1000)
# 
# bldg_norm_c <-
#   bg_bldg %>% 
#   filter(ZONING == "C") %>% 
#   left_join(
#     stockton_wac %>% 
#       filter(year == 2017) %>% 
#       dplyr::select(jobs = C000, GEOID), 
#     by = "GEOID"
#   ) %>% 
#   summarize(
#     jobs = sum(jobs, na.rm=T),
#     bldgtot = sum(bldgtot, na.rm=T)
#   ) %>% 
#   mutate(`Jobs/1000sqft` = jobs/bldgtot*1000)

bg_bldg_norm_c <-
  bg_bldg %>% 
  filter(ZONING == "C") %>% 
  left_join(
    stockton_wac %>% 
      as.data.frame() %>% 
      filter(year == 2015) %>% 
      dplyr::select(jobs=C000,GEOID), 
    by = "GEOID"
  ) %>% 
  mutate(
    `Jobs per 1,000 sqft` = jobs/bldgtot*1000,
    commercial_density = bldgtot/(as.numeric(st_area(.))/4046.86)
  ) %>% 
  filter(!GEOID %in% c("060770039001","060770039002"))

map = mapview(bg_bldg_norm_c,zcol=c("commercial_density"), legend = TRUE, layer.name = "Commercial</br>density</br>per acre")

map@map
```

$~$

Because we do not have robust historical building datasets, we cannot analyze the change in building square footages over time. For forecasting, we assumed an overall fixed building utilization estimate of 1.7 residents per 1000 sqft of residential buildings, and 1.3 jobs per 1000 sqft of commercial buildings. In the intervention stage, if we expect a strategy would change building utilization, we would make a reduction in energy consumption relative to these baseline utilization rates.

As one last couple of building-specific analyses, we aggregated building square footage information up to the zipcode level and compared with energy usage data to see residential and commercial building energy efficiency at a recent snapshot of time, spatially distributed across Stockton.

```{r res-customer, fig.cap="Stockton residential kBTU per sqft of residential building area, per zip code."}
#disaggregating by zipcode and zoning type of the buildings to get summaries of # of buildings, total ground footprint, and total bldg sqft. the filter removes NAs in the data, which could be missing zones in specific zipcodes.
zcta_bldg_spread <- 
  stockton_bldg_final %>% 
  st_set_geometry(NULL) %>% 
  group_by(ZIPCODE, ZONING) %>% 
  summarise(
    NUMBLDG = n(),
    TOTSQFTGROUND = sum(bldgground, na.rm=T),
    TOTSQFT = sum(bldgtot, na.rm=T)
  ) %>% 
  filter(!is.na(ZIPCODE) & !is.na(ZONING)) %>% 
  gather(key, value, NUMBLDG:TOTSQFT) %>% 
  unite(temp,ZONING,key) %>% 
  spread(temp,value)

#summarize totals by zipcode, then join the zoning-specific subtotals to it.
zcta_bldg_summary <-
  stockton_bldg_final %>% 
  st_set_geometry(NULL) %>% 
  group_by(ZIPCODE) %>% 
  summarise(
    NUMBLDG = n(),
    TOTSQFTGROUND = sum(bldgground, na.rm=T),
    TOTSQFT = sum(bldgtot, na.rm=T)
  ) %>% 
  left_join(zcta_bldg_spread, by = "ZIPCODE")

zcta_bldg_stockton_joined <- 
  zcta_stockton_joined %>% 
  filter(ZIPCODE != 95211) %>% 
  left_join(zcta_bldg_summary, by = "ZIPCODE") %>% 
  mutate(
    ER_KBTUperSQFT = ER_TOTALKBTU/R_TOTSQFT, 
    GR_KBTUperSQFT = GR_TOTALKBTU/R_TOTSQFT, 
    EC_KBTUperSQFT = EC_TOTALKBTU/C_TOTSQFT, 
    GC_KBTUperSQFT = GC_TOTALKBTU/C_TOTSQFT, 
    R_KBTUperSQFT = R_TOTALKBTU/R_TOTSQFT, 
    C_KBTUperSQFT = C_TOTALKBTU/C_TOTSQFT, 
    E_KBTUperSQFT = E_TOTALKBTU/TOTSQFT, 
    G_KBTUperSQFT = G_TOTALKBTU/TOTSQFT, 
    KBTUperSQFT = TOTALKBTU/TOTSQFT
  )

map = mapview(zcta_bldg_stockton_joined, zcol=c("R_KBTUPERCUST"), legend = TRUE, layer.name = "kBTU per customer,</br>Residential")

map@map
```

$~$

```{r comm-customer, fig.cap="Stockton commercial kBTU per sqft of commercial building area, per zip code."}
map = mapview(zcta_bldg_stockton_joined, zcol=c("C_KBTUPERCUST"), legend = TRUE, layer.name = "kBTU per customer,</br>Commercial")

map@map
```

$~$

```{r zcta-bldg-stockton-table}
zcta_bldg_stockton_summary <- 
  zcta_bldg_stockton_joined %>% 
  st_set_geometry(NULL) %>% 
  summarise_at(
    c(
      "NUMBLDG", 
      "R_NUMBLDG", 
      "C_NUMBLDG",
      "TOTSQFTGROUND",
      "TOTSQFT",
      "R_TOTSQFT",
      "C_TOTSQFT",
      "R_TOTSQFTGROUND",
      "C_TOTSQFTGROUND",
      "TOTALKBTU",
      "E_TOTALKBTU",
      "G_TOTALKBTU",
      "R_TOTALKBTU",
      "C_TOTALKBTU", 
      "ER_TOTALKBTU", 
      "GR_TOTALKBTU", 
      "EC_TOTALKBTU", 
      "GC_TOTALKBTU"
    ), sum, na.rm=T
  ) %>% 
  mutate(
    ER_KBTUperSQFT = ER_TOTALKBTU/R_TOTSQFT, 
    GR_KBTUperSQFT = GR_TOTALKBTU/R_TOTSQFT, 
    EC_KBTUperSQFT = EC_TOTALKBTU/C_TOTSQFT, 
    GC_KBTUperSQFT = GC_TOTALKBTU/C_TOTSQFT, 
    R_KBTUperSQFT = R_TOTALKBTU/R_TOTSQFT, 
    C_KBTUperSQFT = C_TOTALKBTU/C_TOTSQFT, 
    E_KBTUperSQFT = E_TOTALKBTU/TOTSQFT, 
    G_KBTUperSQFT = G_TOTALKBTU/TOTSQFT, 
    KBTUperSQFT = TOTALKBTU/TOTSQFT,
  )

zcta_bldg_stockton_table <-
  data.frame(
    Type = c(
      "Residential Electricity",
      "Residential Gas",
      "Commercial Electricity",
      "Commercial Gas",
      "Residential Total",
      "Commercial Total",
      "Electricity Total",
      "Gas Total",
      "Total"
    ),
    Bldg = c(
      NA,
      NA,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_NUMBLDG,
      zcta_bldg_stockton_summary$C_NUMBLDG,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_NUMBLDG+zcta_bldg_stockton_summary$C_NUMBLDG
    ),
    Footprint = c(
      NA,
      NA,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFTGROUND,
      zcta_bldg_stockton_summary$C_TOTSQFTGROUND,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFTGROUND+zcta_bldg_stockton_summary$C_TOTSQFTGROUND
    ),
    sqft = c(
      NA,
      NA,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFT,
      zcta_bldg_stockton_summary$C_TOTSQFT,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFT+zcta_bldg_stockton_summary$C_TOTSQFT
    ),
    kbtu = c(
      zcta_bldg_stockton_summary$ER_TOTALKBTU,
      zcta_bldg_stockton_summary$GR_TOTALKBTU,
      zcta_bldg_stockton_summary$EC_TOTALKBTU,
      zcta_bldg_stockton_summary$GC_TOTALKBTU,
      zcta_bldg_stockton_summary$R_TOTALKBTU,
      zcta_bldg_stockton_summary$C_TOTALKBTU,
      zcta_bldg_stockton_summary$E_TOTALKBTU,
      zcta_bldg_stockton_summary$G_TOTALKBTU,
      zcta_bldg_stockton_summary$TOTALKBTU
    ),
    kbtusqft = c(
      zcta_bldg_stockton_summary$ER_KBTUperSQFT,
      zcta_bldg_stockton_summary$GR_KBTUperSQFT,
      zcta_bldg_stockton_summary$EC_KBTUperSQFT,
      zcta_bldg_stockton_summary$GC_KBTUperSQFT,
      zcta_bldg_stockton_summary$R_KBTUperSQFT,
      zcta_bldg_stockton_summary$C_KBTUperSQFT,
      zcta_bldg_stockton_summary$E_KBTUperSQFT,
      zcta_bldg_stockton_summary$G_KBTUperSQFT,
      zcta_bldg_stockton_summary$TOTALKBTU/(zcta_bldg_stockton_summary$R_TOTSQFT+zcta_bldg_stockton_summary$C_TOTSQFT)
    )
  ) %>% 
  transmute(
    Type = Type,
    `Number of Buildings` = 
      ifelse(
        is.na(Bldg),
        "",
        prettyNum(round(Bldg,-3),big.mark = ",")
      ),
    `Total Footprint` =
      ifelse(
        is.na(Footprint),
        "",
        prettyNum(round(Footprint,-6),big.mark = ",")
      ),
    `Total Sqft` =
      ifelse(
        is.na(sqft),
        "",
        prettyNum(round(sqft,-6),big.mark = ",")
      ),
    `Total kBTU` = prettyNum(round(kbtu,-7),big.mark = ","),
    `kBTU/sqft` = prettyNum(round(kbtusqft),big.mark = ",")
  )

kable(
  zcta_bldg_stockton_table, 
  booktabs = TRUE,
  caption = 'Summary of Building count, size, and energy usage for residential/commercial and electricity/gas. Data from PG&E, 2018.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

## GHG Forecast

For our "business as usual" forecast of GHG emissions through 2040, and for our subsequent exploration of intervention strategies, we will focus on the following sectors for which we have used available data to refine our models: transportation, commercial energy, and residential energy. These sectors represented 58% of ICLEI's modeled emissions in 2016. The other sectors, particularly industrial energy which comprised 24% of 2016 emissions, are also significant opportunities for GHG reductions, but are outside of the scope of this analysis without better data.

Our simplified model of transportation emissions assumes that commute one-way vehicle miles traveled per worker is on a linear trend based on recent data. Otherwise, our forecasts of growth in the number of employed residents drives changes in VMT and thus transportation emissions. Other "business as usual" factors, like a forecasted adoption of EVs, are not considered in this analysis.

Our simplified model of energy emissions will assume that building square footage increases with population and job growth through fixed ratios, and an underlying energy use factor for commercial and residential electricity and gas will follow the same trends as the last six years through 2040. Otherwise, a basic climate change model of heating and cooling degree days will drive additional changes in the forecasts.

In summary, the following assumptions go into inputs for the forecasts, which are also shown in the table below:

- From Section 2.1, we derived future population, employed resident, and job forecasts, specifically for the years 2020, 2025, 2030, 2035, and 2040.
- From Section 2.5, we derived commute one-way VMT/workers for 2011-2017. The table below projects this trend to 2040.
- From Section 2.5, we derived simplified aggregate vehicle emission rates for San Joaquin County through 2040.
- From Section 2.7, we derived a linear forecast of PG&E's electricity emissions factor which runs from 2017's data point towards a 2045 target of 100% clean energy.
- From Section 2.7, we derived linear forecasts of heating and cooling degree days through 2040 from Cal-Adapt's HDD and CDD projections.
- From Section 2.7, we derived linear forecasts of energy use per capita per degree-day through 2040. For Commercial Gas, we leveled out the forecast at 1 kBTU/job/HDD from 2035 on.

```{r ghg-forecast-prep}
summary_TCO2E_norm_projection <-
  summary_TCO2E_norm_all

summary_TCO2E_norm_projection[7:11,1] <- c(2020,2025,2030,2035,2040)

ghg_forecast_prep <-
  summary_TCO2E_norm_projection %>% 
  dplyr::select(-`Heating Degree Days`,-`Cooling Degree Days`,-Residents,-Jobs) %>% 
  mutate(
    `Residential Electricity, kBTU/resident/CDD` =
      ifelse(
        Year < 2020,
        `Residential Electricity, kBTU/resident/CDD`,
        lm(
          `Residential Electricity, kBTU/resident/CDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Residential Electricity, kBTU/resident/CDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Residential Gas, kBTU/resident/HDD` =
      ifelse(
        Year < 2020,
        `Residential Gas, kBTU/resident/HDD`,
        lm(
          `Residential Gas, kBTU/resident/HDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Residential Gas, kBTU/resident/HDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Commercial Electricity, kBTU/job/CDD` =
      ifelse(
        Year < 2020,
        `Commercial Electricity, kBTU/job/CDD`,
        lm(
          `Commercial Electricity, kBTU/job/CDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Commercial Electricity, kBTU/job/CDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Commercial Gas, kBTU/job/HDD` =
      ifelse(
        Year < 2020,
        `Commercial Gas, kBTU/job/HDD`,
        lm(
          `Commercial Gas, kBTU/job/HDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Commercial Gas, kBTU/job/HDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Commercial Gas, kBTU/job/HDD` =
      ifelse(
        `Commercial Gas, kBTU/job/HDD` < 1,
        1,
        `Commercial Gas, kBTU/job/HDD`
      )
  ) %>% 
  left_join(hdd, by = c("Year" = "YEAR")) %>% 
  left_join(cdd, by = c("Year" = "YEAR")) %>% 
  left_join(pop_jobs_stockton_w_projection %>% dplyr::select(Year, Population, `Employed Residents`, Jobs), by = "Year") %>% 
  left_join(stockton_commute_vmt_tractmode %>% dplyr::select(Year, vmt, jobs_car), by = "Year") %>% 
  mutate(
    vmtperjob = vmt/jobs_car
  ) %>% 
  dplyr::select(-vmt,-jobs_car) %>% 
  mutate(
    vmtperjob =
      ifelse(
        Year < 2018,
        vmtperjob,
        lm(
          vmtperjob[1:5] ~ Year[1:5]
        )$coefficients[1]+
          lm(
            vmtperjob[1:5] ~ Year[1:5]
          )$coefficients[2]*Year
      )
  ) %>% 
  left_join(pge_elec_emissions_factor, by = c("Year" = "year"))

ghg_forecast_table_prep <-
  ghg_forecast_prep %>% 
  transmute(
    Year = Year,
    Population = prettyNum(round(Population,-3),big.mark=","),
    `Employed Residents` = prettyNum(round(`Employed Residents`,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `One-way Commute VMT per Car-dependent Worker` = round(vmtperjob),
    `PG&E Electricity Emissions Factor` = round(factor),
    `Heating Degree Days` = hdd,
    `Cooling Degree Days` = cdd,
    `Residential Electricity, kBTU/resident/CDD` = round(`Residential Electricity, kBTU/resident/CDD`,1),
    `Residential Gas, kBTU/resident/HDD` = round(`Residential Gas, kBTU/resident/HDD`,1),
    `Commercial Electricity, kBTU/job/CDD` = round(`Commercial Electricity, kBTU/job/CDD`,1),
    `Commercial Gas, kBTU/job/HDD` = round(`Commercial Gas, kBTU/job/HDD`,1)
  )

kable(
  ghg_forecast_table_prep,
  booktabs = TRUE,
  caption = 'Input assumptions for GHG forecast to 2040.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

The input assumptions above result in the following GHG forecasts.

```{r ghg-forecast}
ghg_forecast <-
  ghg_forecast_prep %>% 
  transmute(
    Year = Year,
    transport = vmtperjob * `Employed Residents` *2*369.39*0.000334,
    residential = `Residential Electricity, kBTU/resident/CDD`*Population*cdd*2.9307e-7*0.000453592 + `Residential Gas, kBTU/resident/HDD`*Population*hdd/99.9761*0.00531,
    commercial = `Commercial Electricity, kBTU/job/CDD`*Jobs*cdd*2.9307e-7*0.000453592 + `Commercial Gas, kBTU/job/HDD`*Jobs*hdd/99.9761*0.00531
  )

ghg_forecast_table <-
  ghg_forecast %>% 
  transmute(
    Year=Year,
    `Transportation tCO2` = prettyNum(round(transport,-4),big.mark=","),
    `Residential Building tCO2` = prettyNum(round(residential,-3),big.mark=","),
    `Commercial Building tCO2` = prettyNum(round(commercial,-3),big.mark=",")
  )

kable(
  ghg_forecast_table,
  booktabs = TRUE,
  caption = 'GHG forecast to 2040.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

The general insight is that transportation emissions are expected to increase while building emissions are expected to decrease.

Many differences in inputs exist between this analysis and ICLEI's 2016 GHG Inventory, including the following:

- ICLEI's VMT data came from a source that was only available at the SJC level and was scaled down to Stockton by population, whereas our VMT data is based on the routed distance of LODES origin-destinations. The difference these methods results in is significant (2.5 billion vs. 1.5 billion annual VMTs) and should be investigated in further work. Our Transportation tCO2 number is only for passenger commuters, whereas ICLEI's number includes many other modes.
- ICLEI's electricity and gas data was obtained directly from PG&E, while ours was downloaded at the zip code level from their public data portal. Since our zip codes include many parcels outside of the Stockton city boundary, it's likely our consumption is for a larger population. As for commercial energy, ICLEI's commercial data was combined with industrial data, while ours is separated, so that could explain why our commercial consumption numbers our lower.

The assumptions built into these forecasts are necessarily simplistic given the scope of this analysis. In particular, linear trendlines should be refined into nonlinear functions given a better understanding of growth limits for each of the domains. It's also worth noting that some trends based on the past few years, like the desirable decline in building emissions, may be heavily influenced by active strategic policymaking, the kind which this report is meant to guide for the future. That means that "business as usual" is not necessarily "doing nothing" but "successfully continuing to implement progressive policies" (e.g. PG&E successfully meeting its aggressive decarbonization strategies).

# Overview of Green Economy Strategies

This chapter provides a survey of green economy strategies that have been implemented, or are being considered, in cities and regions across the U.S. and beyond. It is organized by overall strategy domain (with explanations for why the domain is chosen) and by specific strategy (where cities with similar examples as the primary case study are grouped together). In Appendix A, this list is re-organized by city or region.

The following chapter will revisit each strategy domain with a focus on specific strategies that can be technically evaluated using the quantitative approach that has been developed in Chapter 2, and that may be applicable to Stockton. While this deeper analysis cannot be applied to all the strategies researched in this chapter, we believe the handful that are detailed are good starting points for Stockton's green economy initiative in the 2020s.

## Building Utilization

Building Utilization refers to the amount of building space used per person throughout their daily activities. Specific types of building energy uses like heating and cooling are proportional to space use, and strategies to reduce the amount of space required per person, whether at home or at work, that do not sacrifice comfort can be effective ways to reduce emissions. However, the more profound impact of space efficiency is the densification of all urban activities, which may have an even greater emissions impact by reducing travel distances, as well as many potential social co-benefits. 

### Revise zoning codes in medium to large cities to facilitate upzoning
| Location | Oregon |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | HB 2001 legalizes the development of duplexes on residential land currently zoned for single-family housing in all communities of 10,000 or more. It also allows for the construction of three- to four-unit homes on single family-zoned land in cities of 25,000 or more. |
| Links | [Oregon Legislative Assembly](https://olis.leg.state.or.us/liz/2019R1/Downloads/MeasureDocument/HB2001/B-Engrossed) |
| Implementation Costs | N/A |
| Impact Factor | Fiscally, [50% of Oregon households](https://www.oregon.gov/OHA/PH/ABOUT/Documents/indicators/rentburden.pdf) are rent burdened while [23%](https://nlihc.org/sites/default/files/SHP_OR.pdf) of renter households are extremely low income. These individuals will likely see the biggest impact. However, the law applies to cities of over 10,000. As of the 2010 Census, 2,208,732 Oregonians, which constitute 57.65% of the state’s population, live in such communities. |
| Scalable Potential | According to tax assessor records, `r bldg_join %>% filter(type==10) %>% nrow()` parcels have detached single-family residences. It is not yet clear what the impact of upzoning change is on actual development in other cities over multiple years, but these parcels could be potential candidates for suburban infill development. |
| Similar | [Minneapolis 2040](https://minneapolis2040.com/)<br>[California SB50 (did not pass)](https://leginfo.legislature.ca.gov/faces/billTextClient.xhtml?bill_id=201920200SB50) |

### Eliminate minimum parking
| Location | Buffalo, NY |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | Developers are no longer required to build a certain number of parking spaces for commercial or residential projects, regardless of whether or not there are mass transit options nearby or if the tenants even need them. |
| Links | [Buffalo Green Code Land Use Plan](http://www.oneregionforward.org/plan/the-buffalo-green-code-draft-land-use-plan/) |
| Implementation Costs | N/A |
| Impact Factor | 28% of land area in Buffalo’s city center is devoted to parking but only 63% of parking spaces are occupied on an average weekday. |
| Scalable Potential | According to [Stockton’s zoning ordinance](http://qcode.us/codes/stockton/view.php?topic=16-3-16_64-16_64_040&frames=on), large shopping centers must build 1 parking space per 250 square feet of retail space. [Anecdotal evidence](https://stocktoncitylimits.com/2013/12/31/why-are-stocktons-parking-lots-so-big-and-empty/) suggests that this is too much space, even during peak hours. Similarly inefficient standards include that colleges and universities must have 1 parking space per classroom plus 0.75 spaces per student. |
| Similar | [Minneapolis 2040](https://minneapolis2040.com/)<br>[San Francisco, CA](https://usa.streetsblog.org/2018/12/17/san-francisco-eliminates-parking-minimums/)<br>[Hartford, CT](https://usa.streetsblog.org/2017/12/13/hartford-eliminates-parking-minimums-citywide/)

### Encourage accessory dwelling units
| Location | California |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | The 2019 California state legislative cycle resulted in some progressive accessory dwelling unit (ADU) laws that, among other changes, supercede local to allow ADUs to be built on every single family parcel. Counties and cities in the Bay Area are in the process of updating their local ADU ordinances as well as offering many proactive resources to encourage ADU development and streamline the permitting process. |
| Links | [San Mateo County, CA](https://secondunitcentersmc.org)<br>[Napa and Sonoma County, CA](https://napasonomaadu.org)<br>[San Jose, CA](https://www.sanjoseca.gov/business/development-services-permit-center/accessory-dwelling-units-adus) |
| Implementation Costs | N/A |
| Impact Factor | Aggregating single unit detached and attached, California has [8,451,340 units](https://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?src=CF). |
| Scalable Potential | Because this is a statewide bill, Stockton is currently eligible. It is mostly a matter of encouraging the construction of ADUs on a municipal level. Aggregating single unit detached and attached, Stockton has [69,524 single units](https://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?src=CF) detached and attached. |
| Similar | [Seattle, WA](https://www.seattle.gov/Documents/Departments/Council/MAIN_ADU_FEIS_2018.pdf) |

### Encourage micro-units
| Location | San Francisco, CA |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | In 2011, SFHAC worked with District 8 Supervisor Scott Wiener to pass legislation that allows for the construction of micro-units, also known as “efficiency dwelling units.” The legislation allows for units as small as 220 square feet comprised of 150 square feet of living space, plus a bathroom and kitchen. |
| Links | [San Francisco Planning](https://sfplanning.org/sites/default/files/documents/legis/code-summaries/120996_Cap_on_Efficiency_Dwelling_Units.pdf) |
| Implementation Costs | N/A |
| Impact Factor | Assuming this will be in San Francisco and one will pay 30% of their income on the unit at the suggested price of $1,400, this could impact 69.5% of San Francisco households. |
| Scalable Potential | Assuming the same development costs and that one will pay 30% of their income on the unit, then this could impact 48.68% of Stockton households. Assuming the same development costs and that one will not save 20% of their income (as recommended) but instead spends it on housing e.g. 50% of their income goes towards housing, then this could impact 62.30% of Stockton households. |
| Similar | [ShareNYC](https://www1.nyc.gov/site/hpd/about/projects-detail.page?project=ShareNYC)<br>[Vancouver, Canada](https://guidelines.vancouver.ca/D015.pdf) |

### Provide a density bonus for affordable housing
| Location | San Francisco, CA |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | The 100% Affordable Housing Bonus Program, passed in 2016, provides a 30-foot height bonus for housing developments that completely consist of affordable housing for low- or very low-income households. |
| Links | [HOME-SF](https://sfplanning.org/home-sf) |
| Implementation Costs | N/A |
| Impact Factor | Technically affordable housing is for those with the median income or below. For San Francisco, this would then apply to 442,181 individuals. |
| Scalable Potential | There are currently 155,248 individuals living below the median income in Stockton. |
| Similar |  |

## Building Energy

This domain covers all strategies that reduce the amount of energy use in buildings, which tend to be concentrated in heating or cooling loads but also include lighting and other plug loads. This domain also includes localized power generation and storage, as well as electrification strategies that switch gas use to electricity use where the electricity grid has fewer emissions.

### Set energy savings standards on all public buildings and provide financial and technical assistance for commercial private sector energy savings
| Location | Milwaukee, WI |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | Using a five-pronged strategy, the City of Milwaukee has: (1) Established efficiency targets (20% reduction over a decade in participating buildings); (2) Offered incentives and financing through leveraging private capital to supply upfront funding for improvements and collects payments through a voluntary municipal special charge; (3) Set a 20% reduction target in government buildings
Provides training to support building owner and occupant actions; and (4) Provided technical services to identify energy efficient equipment and train workforce to support building operations.
 |
| Links | [Better Buildings Challenge](https://city.milwaukee.gov/bbc) |
| Implementation Costs | [Originally a $750,000 grant](https://city.milwaukee.gov/bbc/History) |
| Impact Factor | The [program](https://city.milwaukee.gov/bbc) affected 133 buildings, totaling 14,660,008 square feet, and led to $2,418,061 in annual savings. |
| Scalable Potential | N/A |
| Similar |  |

### Revise energy standards for public buildings and create a fund to implement energy savings product 
| Location | Belgrade, Serbia |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | Collaborating with the Building Efficiency Accelerator, Belgrade has developed a fund that combines city, state, and national financing streams to help finance energy efficiency projects throughout the city. It also has revised energy efficiency standards for all newly constructed public buildings.
 |
| Links | [Building Performance Institute Europe](http://bpie.eu/wp-content/uploads/2018/07/Read-the-full-report-here.pdf) |
| Implementation Costs | Low Renovation: €1.5bn<br>
Medium Renovation: €4.8bn<br>
High Renovation: €9bn<br>
District Heating Renovation Scenario: €2.6bn<br>
 |
| Impact Factor | Convert table |
| Scalable Potential | N/A |
| Similar |  |

### Enable property-assessed clean energy (PACE) financing
| Location | Hartford, CT |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | A private company in Hartford operating a mixed-use housing and retail space privately financed $1 million energy renovation project and paid back the loan through property tax reassessment. Greenworks Lending provided the upfront capital for rooftop solar, fuel cell energy storage, and installation of microgrid. The loan was repaid as a line item assessment of the property tax bill. 
 |
| Links | [Better Buildings Initiative](https://betterbuildingsinitiative.energy.gov/implementation-models/commercial-pace-financing-microgrid-mixed-use-building) |
| Implementation Costs | $1 million
 |
| Impact Factor | Year 1: $316,927 |
| Scalable Potential | N/A |
| Similar |  |

### Use green infrastructure to improve stormwater management
| Location | San Francisco, CA |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | Green Infrastructure is a method of reducing stormwater and pollution burden from stormwater systems. It does this through the creation of micro urban watersheds that has the potential to decrease erosion, improve air quality, increase land value, and reduce urban heat effects (thereby also reducing cooling loads). 
 |
| Links | [Green Infrastructure Projects](https://sfwater.org/modules/showdocument.aspx?documentid=13249)<br>
[Cost-Benefit Analysis of similar project](https://static1.squarespace.com/static/561dcdc6e4b039470e9afc00/t/5d435f106f6e7a0001f5b304/1564696351697/HuntsPoint_EarthEconomics_062719-1.pdf)|
| Implementation Costs | Contingent upon site. See table here.
 |
| Impact Factor | See table above. Also see tables here. |
| Scalable Potential | Can’t quantify, but Stockton groundwater, where much of the water supply comes from, is polluted by agricultural run-off. |
| Similar |  |

### Provide consumer-oriented programs to incentivize energy efficiency retrofits and appliance improvements
| Location | Los Angeles, CA |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | The Los Angeles Department of Water & Power runs multiple energy efficiency programs in three broad categories. Mass market programs generally serve residential customers and encourage them to upgrade to energy efficient appliances, with a few exceptions. Commercial, industrial, and institutional (CII) programs generally serve large nonresidential customers and range in scope from simple lighting upgrades to entire building overhauls. Lastly, cross-cutting programs serve a wide variety of customer types and employ broad strategies for achieving energy savings (e.g., planting street trees, informing updates to building codes, customer outreach, etc.). 
 |
| Links | [Economic Benefits of Energy Efficiency Programs: A Case Study of Investments by the Los Angeles Department of Water & Power](https://innovation.luskin.ucla.edu/wp-content/uploads/2019/03/Economic_Benefits_of_Energy_Efficiency_Programs.pdf) |
| Implementation Costs | See table.
 |
| Impact Factor | See table. |
| Scalable Potential | See Chapter 4. |
| Similar |  |

## Employment Growth

This domain covers strategies with the outcome of increasing the employment rate for the resident population, such as job training. While this strategy domain generally is not restricted to “green” strategies and can include employment strategies that provide broad economic benefits to Stockton, this report ultimately will focus on “green jobs” in particular. In addition, any strategies that increase employment opportunity and employment wages can increase the purchasing power of households, enabling them to invest in many of the other GHG reduction strategies considered in this report.

### Provide training and coaching for low-income workers, rather than unemployed workers
| Location | Dayton, OH |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | The Workforce Advancement and Support Center (WASC) offered participating workers intensive employment retention and advancement services, including career coaching and access to skills training. It also offered them easier access to work support, in an effort to increase their incomes in the short run and help stabilize their employment. The program was found to be most effective in cities with the lowest baseline of work support. 
 |
| Links | [Strategies to Help Low-Wage Workers Advance](https://www.mdrc.org/sites/default/files/full_627.pdf) |
| Implementation Costs | Based on a [NY program](http://www.nyc.gov/html/sbs/downloads/pdf/presentation_wasc.pdf), start-up costs of \$615,000 plus three years of \$1.85 million each.
 |
| Impact Factor | [Bridgeport and Dayton](https://www.mdrc.org/sites/default/files/full_627.pdf) experienced 16% increased participation in education and training. Dayton experienced 8% increase in earnings by Year 3.
 |
| Scalable Potential | N/A |
| Similar | San Diego, CA<br>
Bridgeport, CT |

### Provide green-oriented job training and education pathways
| Location | Los Angeles, CA |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | Los Angeles Trade and Technical College’s Weatherization and Energy Efficiency Education Program is a career-focused education training program designed to integrate industry awareness, academic remediation, and basic skills attainment. The framework includes: (1) Industry and sector-wide occupational mapping; (2) Career ladder mapping for weatherization occupations and occupations in the construction sector; (3) Developing competency frameworks in which skills are identified for target occupations; and (4) Curriculum that integrates and contextualizes soft skills, core academic skills, and technical skills. |
| Links | [Making Green Work](https://ellabakercenter.org/sites/default/files/downloads/making-green-work.pdf) |
| Implementation Costs | N/A
 |
| Impact Factor | A [Richmond program](http://www.ci.richmond.ca.us/1243/RichmondBUILD) yielded a 90% job placement rate (average starting wage rate at $15/hr). 30% of participants have a history with the legal system, and there are 35 available seats in each class. |
| Scalable Potential | Brownfields clean-up in Stockton |
| Similar | [Richmond, CA](http://www.ci.richmond.ca.us/1243/RichmondBUILD) |

### Create a scholarship fund for students wishing to pursue eco-conscious careers
| Location | N/A |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | San Joaquin Delta Community College does not require that you have a GED or High School diploma to attend. However, if you do not have a GED/High School Diploma, you are not eligible for federally funded student aid. Tuition is $46.00 per unit, which may represent a barrier for some students. If a fund were created that did not require GED/High School Diploma eligibility for financial aid and was targeted towards those pursuing environmentally-oriented careers, then it would incentivize more to pursue those careers. |
| Links | [Low-Skill Workers’ Access to Quality Green Jobs](https://www.urban.org/sites/default/files/publication/32921/412096-Low-Skill-Workers-Access-to-Quality-Green-Jobs.PDF) |
| Implementation Costs | Contingent upon demand for eco-conscious jobs
 |
| Impact Factor | Contingent upon demand for eco-conscious jobs |
| Scalable Potential | San Joaquin Delta College or Stockton Scholars |
| Similar | Green Workforce Development Jobs at similar municipalities |

### Offer continued training and support post-employment
| Location | New York, NY |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | WorkAdvance is a sector-based workforce development model that continues training and support post-employment. The developers of the program focused on sectors with strong demand for entry-level and middle-skill employees and relatively short training time. For this program, they focused on transportation & manufacturing, IT, environmental remediation, and healthcare. The program itself has five components including: (1) Intensive screening of program applicants for motivation and readiness; (2) Sector appropriate pre-employment and career readiness, including orientation to the sector and career advancement coaching; (3) Sector-specific occupational skills training aligned with employer needs and leading to certifications that are in demand in the regional labor market; (4) Sector-specific job development and placement services based on strong relationships with employers; and (5) Post-employment retention and advancement services, including ongoing contact, coaching, skills training, and rapid reemployment help if needed. |
| Links | [Implementing the WorkAdvance Model](https://www.mdrc.org/sites/default/files/WorkAdvance_2016_PolicyBrief.pdf)<br>
[MDRC Analysis](https://www.mdrc.org/sites/default/files/2016_Workadvance_Final_Web.pdf) |
| Implementation Costs | See table.
 |
| Impact Factor | See table. |
| Scalable Potential | According to the 2013-2017 ACS, the number of individuals that are high school graduates/possess a GED or have less than a high school education are 75,717. |
| Similar |  |

## Local Jobs

This domain includes strategies with the outcome of increasing the number of jobs based in Stockton. This is distinct from the previous section because local job creation may be attracting companies and workers who aren’t necessarily Stockton residents, so as to increase the jobs to employed residents ratio.

### Offer job creation tax credit
| Location | N/A |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | Taxpayers with 20 or fewer employees at the end of the preceding taxable year may qualify for a nonrefundable new jobs credit against the personal income tax and corporation franchise and income taxes for each new qualified employee that is hired. It is equal to $3,000 for each net increase in qualified full-time employees from the previous taxable year. There have been several proposals for implementing a similar system with local corporate taxes. |
| Links | [NCSL](https://www.ncsl.org/research/financial-services-and-commerce/job-creation-tax-credits.aspx#California) |
| Implementation Costs | Depends on the size of tax credit expansion |
| Impact Factor | [Estimates](https://digitalcommons.ilr.cornell.edu/cgi/viewcontent.cgi?article=1356&context=cahrswp) suggest that the tax credit creates between 0.13 and 0.3 new jobs at participating firms, primarily for workers 25 and younger. Many of these workers, however, would have been hired without the credit. It is likely that as firm size grows, economies of scale will allow job creation to increase exponentially as the marginal cost of adding an additional employee decreases. |
| Scalable Potential | In CA it is only applicable to firms with 20 or fewer employees (see Sec. 23623, California Rev. & Tax. Code). As of 2018, the [Stockton-Lodi MSA](https://www.labormarketinfo.edd.ca.gov/LMID/Size_of_Business_Data.html) has 2132 business with other 20 employees, 159,052 employees in those businesses, and payrolls equal to $1,830,930,000. |
| Similar |  |

### Encourage mortgage refinancing
| Location | N/A |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | Mortgage refinancing encourages consumers to take out a new loan to take advantage of lower interest rates. This creates a wealth effect whereby they develop greater disposable income. From a Keynesian perspective, this leads to more consumer spending in the local economy. The corollary to this is that growth in aggregate demand leads to job growth, or at least stability. HUD has a class on First-Time Homebuyer Education and Counseling. |
| Links | [Regional Heterogeneity and the Refinancing Channel of Monetary Policy](http://economics.mit.edu/files/15731)<br>
[Low Interest Rates Boost Household Consumption](https://voxeu.org/article/low-interest-rates-can-boost-households-consumption) |
| Implementation Costs | N/A |
| Impact Factor | One program has been a HUD first-time home buyer program. The results can be found here. |
| Scalable Potential | According to [Zillow](https://www.zillow.com/stockton-ca/home-values/), 1.1% of Stockton homes are delinquent on their mortgages while 6.6% of homes have negative equity. |
| Similar |  |

### Develop public employment program
| Location | N/A |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | A public employment program places unemployed, willing-to-work, workers in in-demand jobs across the community.
In post-Keynesian thought, the job creation element of a public employment program is two-fold. On one hand, you are giving participants a job. On the other hand, their increase in discretionary income leads to greater aggregate spending and by extension, an increase demand for employment in sectors where money is being spent. Additionally, due to macroeconomic overemployment, it is important to target such a program to those who experience structural unemployment, not frictional. |
| Links | [General Equilibrium Effects of (Improving) Public Employment Programs: Experimental Evidence](https://www.nber.org/papers/w23838.pdf)<br>
[Labor Market Considerations for a National Job Guarantee](https://www.brookings.edu/wp-content/uploads/2018/12/JobGuarantee_FP_web_20190206.pdf) |
| Implementation Costs | See table. |
| Impact Factor | Assuming that there wouldn’t be a resulting increase in labor force participation (unlikely), this could impact 18,541. Keep in mind that this would mean exceeding full employment. |
| Scalable Potential | According to CAP data, the ratio of children under 5 to available childcare slots in Stockton is 6.5. This would necessitate growth in the childcare industry. The Old Age Dependency ratio is 20.3, suggesting that the demand for healthcare services will rise in Stockton, even though there is a statewide shortage of healthcare workers. Most theorized public employment programs, particularly those that occur on a federal level, do mention the importance of building/rebuilding infrastructure. |
| Similar |  |

### Provide state tax credits to investors in early-stage high-tech companies
| Location | Nebraska |
|----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Details | By making these credits refundable, the State of Nebraska Angel Investment Tax Credit has effectively subsidized the angel investment. If a qualified investor makes a qualified investment of \$100,000 in a Nebraska start-up company, and receives Nebraska’s 40% angel investment credit, that investor would receive \$40,000 in cash (in reduced taxes or direct payment) from the state. |
| Links | [Tax Credit Program Report](https://nebraskalegislature.gov/FloorDocs/105/PDF/Agencies/Economic_Development__Department_of/161_20171114-090352.pdf) |
| Implementation Costs | Between 2011 and 2016:<br>
Investments: \$54,884,750<br>
Investments (#): 614<br>
Investment (mean): \$89,389<br>
Credits: \$19,156,848<br>
Credits: 614<br>
Credits (mean): \$31,200<br>
Note certain businesses received multiple credits.
 |
| Impact Factor | Of the 50 businesses that responded to the follow-up survey, 35 reported that they created new jobs, 12 reported they did not, and 3 did not respond. The average number of new jobs created was 11.5. |
| Scalable Potential | Stockton has 15,215 businesses with 19 employees or fewer, that employ a total of 55,345 individuals. They are broken down into the following industries: |
| Similar |  |

# Analysis of Green Economy Strategies

While the previous chapter is presented as a broad overview of different green economy strategies from locations across the U.S. and other countries, this chapter hand-picks a limited subset of strategies to examine in greater detail. These strategies are selected because of their ability to be modeled using the same framework as developed in Chapter 2, as well as their identification as practical options for Stockton by Stockton stakeholders. After a description of how the strategies will be quantitatively evaluated within our existing GHG framework, the following sections are once again organized by domain of green economy strategies. Each section introduces key model assumptions, and then a specific set of recommended strategies are modeled in terms of their possible impact on GHG reduction and economic benefits. Where possible, short-term and operational costs are also estimated.

## Methodology

Chapter 2's baseline assessment has already set up the framework for how we will evaluate the effectiveness of any green economy strategies we might consider. Whatever the strategy may be, it would need to have a predicted effect on one of the variable inputs in our GHG model. The following diagram shows those variables highlighted in yellow, and their business-as-usual trends as up/down arrows.

```{r diagram, fig.cap="GHG model diagram."}
include_graphics("images/diagram.jpg")
```

- Employment % was observed in ACS data as the ratio between employed residents and population 16 and older. Using a simple linear assumption, the employment rate increases to 72% in 2040. As a point of comparison, the U.S. 2018 employment rate was ~ 70%. To maintain even this "business as usual" trend may depend on aggressive strategies like workforce training and education initiatives. Otherwise, this is considered a variable with such strategies as possible drivers of change. Note that employment rate affects the number of employed residents, which particularly affects VMTs in the GHG model.
- Jobs to Employed Residents Ratio is different from employment strategies as it can also include attracting workers who are not Stockton residents to commute to Stockton. Economic development strategies to attract new businesses would be an example of a type of strategy that influences the GHG model through this variable. J/ER  affects the number of jobs in Stockton, which particularly affects commercial building emissions in the GHG model. If those local jobs are increasingly held by Stockton residents, it also implies that VMTs have reduced.
- Commute One-Way Vehicle Miles Traveled is modeled using the LODES origin-destination data, so any predictions of changes in the distribution and concentration of jobs would affect this variable. Other transportation strategies such as increasing carpooling or transit would also affect this variable.
- Vehicle Emission Rates
- Building Utilization and Building Energy Efficiency are built into the variables of Energy Use per Capita per Degree Day as "hidden variables" that can't easily be isolated without more data, but any strategies directed at reducing the amount of floor space per capita, or increasing floor area ratio on sites, or retrofitting buildings can be predicted as affecting Building Utilization or Building Energy Efficiency, which in turn would proportionally affect Energy Use per Capita.
- Energy Emission Rates also affect the ultimate emissions estimated out of some amount of energy use. We have already incorporated PG&E's target to steadily eliminate the emissions associated with electricity use. Strategies that shift energy use from gas to electricity would result in quantitative changes that take place roughly at this point in the model.

## Building Utilization

As seen in Table \@ref(tab:stockton-pop-jobs), Stockton's population is estimated to grow from 315,000 in 2020 to 339,000 in 2040, and Stockton's job count is estimated to grow from 125,000 in 2020 to 151,000 in 2040. The roughly 24,000 new residents and 26,000 jobs will of course have some baseline amount of energy use that can't be avoided, but the particular ways in which buildings provide for their needs can be made more energy-efficient through specific strategies. This section will focus on ways to reduce the amount of space required per person, which primarily affects energy usage because less heating, cooling, lighting, and plug load is required. Less space per person implies a more dense urban form, which also brings transportation benefits, which we account for elsewhere in the model.

### Case Study: Missing Middle Housing in Minneapolis, MN

### Case Study: Accessory Dwelling Units in the Bay Area, CA

The 2019 California state legislative cycle resulted in some progressive accessory dwelling unit (ADU) laws that, among other changes, supercede local control to allow ADUs to be built on every single-family parcel.

In San Mateo County, CA, many public- and private-led initiatives have been working to reduce policy, information, and construction barriers to the development of ADUs. At the County Housing Department level, the [Second Unit Resource Center](https://secondunitcentersmc.org/) provides information to homeowners, including a cost calculator and an idea book. This type of landing page for the public has been replicated in [Napa and Sonoma County](https://napasonomaadu.org/). The Housing Endowment and Regional Trust (HEART) in SMC is in the midst of its [Green and Liviable ADU Resource Program](https://heartofsmcadu.org/), which has commissioned a local architecture firm to produce ADU plans that will be made free of charge to homeowners, and potentially pre-approved by specific jurisdictions.

San Jose, CA is leading the Bay Area in streamlining its local [ADU permitting process](https://www.sanjoseca.gov/business/development-services-permit-center/accessory-dwelling-units-adus) through the organization of ADU Tuesdays which feature express review service, a Universal Checklist, and a program for ADU designers and builders to get their plans pre-approved by the City.

The benefits of ADUs from a building energy perspective primarily has to do with reduced energy use per person due to a higher building utilization, or smaller building footprint per inhabitant. Other benefits may include the reduction of sprawl development which reduces vehicle miles traveled to work or to other amenities.

### Strategy: Infill Growth

## Building Energy

### Case Study: Energy Efficiency Programs in Los Angeles County, CA

[Economic Benefits of Energy Efficiency Programs: A Case Study of Investments by the Los Angeles
Department of Water & Power](https://innovation.luskin.ucla.edu/wp-content/uploads/2019/03/Economic_Benefits_of_Energy_Efficiency_Programs.pdf) by the UCLA Luskin Center estimates the economic benefits of LADWP's energy efficiency programs through the metrics of number of jobs, value added (e.g. income for workers, profits for businesses, and taxes for local government), and labor income. 

The report notes that for every dollar invested by LADWP ($123M for FY 2016-17:
- $0.53 in energy cost savings for customers per year (for the lifetime of the measure). Much of these energy cost savings then get reinvested back in the local economy.
- $0.43 co-invested by local businesses and households (total \$53M for FY 2016-17) through financial inventive programs which require participants to provide matching funds for their energy efficient purchase or upgrade.
- $1.36 value added (labor income, profits, and taxes)
- For every $1M dollars of LADWP investment, 13.5 FTE job-years in LA County are supported (1658 total).

One of the limitations of the study is described as follows: "... the ultimate merit of each program should not be solely evaluated in terms of jobs or wealth generation. When making investment decisions, utilities must consider a number of factors, including statuary compliance, grid reliability, costs for ratepayers, greenhouse gas (GHG) emissions reductions, and associated improvements in air quality. Programs that have a low employment or value added multiplier may perform better according to other co-benefits, such as reducing pollution and improving associated environmental health outcomes. Broader analysis of the many co-benefits associated with energy efficiency programs is another worthy task for future research."

Along these lines, we were particularly interested evaluating these programs in terms of net economic cost for GHGs saved, or $/tCO2e, similar to [Climate Smart San Jose](https://www.sanjoseca.gov/your-government/environment/climate-smart-san-jos). In the Luskin report, estimates of energy savings were only given as a 1-yr amount from FY 2016-17 in kWh. It is unclear in each example what combination of electricity and gas savings this entails, and no indication is given of the likely duration of these energy savings, which would be dependent on many factors including the lifetime of the appliance/product. The economic figures, such as the numbers presented above, also come with many model limitations which are described in the report, but appear to be interpretable as the net present value of all total impacts to be realized at some point in the future. Given these interpretations, we estimated net economic cost as investment (by LADWP and co-investors) minus value added to economy and net present value of energy savings. The lifetime of the measure was generally assumed to be 10 years, with the exception of the Refigerator Turn-In & Recycle program which was assumed to be 2.5 years (the amount of time a homeowner may keep using an old fridge instead of retiring it). A 3% real discount rate was applied in the NPV calculations. Total tCO2e reduction was estimated by assuming the annual kWh savings could be realized in PG&E's territory from 2020 onward for the lifetime of the measure, factoring in the emissions factors used in this report. 

```{r luskin}
luskin <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/luskin.csv") %>% 
  mutate(
    npv = 
      map2(energysavings, lifetime, function(x, y){
        ifelse(
          is.na(x) | is.na(y),
          return(0),
          return(as.numeric(NPV(x, rep(x,y), 1:y, 0.03, plot = FALSE)))
        )
      }) %>% unlist(),
    netcost =
      funding+coinvestment-npv-valueadded,
    costperkwh =
      netcost/(kwh*(lifetime+1)),
    tco2e = 
      map2(kwh, lifetime, function(x, y){
        ifelse(
          is.na(x) | is.na(y),
          return(0),
          return(sum(rep(x,y+1)*((25:(25-y))*7.5/1000*0.000453592)))
        )
      }) %>% unlist(),
    costpertco2e = 
      netcost/tco2e
  )

luskin_table <-
  luskin %>% 
  filter(!is.na(costperkwh)) %>% 
  arrange(costpertco2e) %>% 
  transmute(
    Program = program,
    `Intervention Type` = type,
    `Original LADWP Investment` = paste0("$",prettyNum(round(funding,-3),big.mark=",")),
    `Net Lifetime Cost` = 
      ifelse(
        netcost<0,
        paste0("-$",prettyNum(round(-netcost,-3),big.mark=",")),
        paste0("$",prettyNum(round(netcost,-3),big.mark=","))
      ),
    `Lifetime tCO2e Reduction` = prettyNum(round(tco2e,-2),big.mark=","),
    `$/tCO2e` = 
      ifelse(
        netcost<0,
        paste0("-$",prettyNum(round(-costpertco2e,-2),big.mark=",")),
        paste0("$",prettyNum(round(costpertco2e,-2),big.mark=","))
      )
  )

kable(
  luskin_table,
  booktabs = TRUE,
  caption = 'Analysis of net cost per tCO2e saved over lifetime of LADWP energy efficiency programs. Data, Luskin 2019.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

Almost all the programs studied in the Luskin report have a negative net cost per tCO2e, meaning they provide a net economic benefit (note that this is not profit solely recuperated to the original investors, but distributed throughout the economy). Programs should ultimately be evaluated based on the feasibility of the original government investment, the $/tCO2e, and the total tCO2e reduction that can be achieved through the measure.

### Strategy: Solar Installations

According to [Project Drawdown](https://www.drawdown.org/solutions/electricity-generation/rooftop-solar), Rooftop Solar is the 10th most impactful carbon reduction strategy globally.

PG&E has minimum energy bill requirement, so a 90% solar offset is ideal.

### Strategy: Energy Storage

From an emissions standpoint, energy storage solutions primarily provide benefit through demand response capabilities, as is discussed below. Energy storage also has the co-benefit of providing resilience during power shut-off situations. 

### Strategy: Electrification

Building electrification refers generally to the conversion of building systems and appliances that are powered directly by fossil fuels into alternative systems and appliances that are powered by electricity, which is becoming increasingly low-carbon. The primary opportunities for electrification are in suburban areas with old homes that have water and space heating powered by natural gas. Household heating fuel type in Stockton from 2018 ACS 1-Yr data is shown below.

```{r fuel}
# acs_vars <-
#   listCensusMetadata(
#     name = "2018/acs/acs1",
#     type = "variables"
#   )
# 
# save(acs_vars, file="C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_2018.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_2018.Rdata")

heating_fuel <-
  getCensus(
    name = "acs/acs1",
    vintage = 2018,
    vars = "group(B25040)",
    region = "place:75000",
    regionin = "state:06"
  ) %>% 
  select_if(!names(.) %in% c("GEO_ID","state","place","NAME")) %>%
  dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
  gather(
    key = "variable",
    value = "estimate"
  ) %>%
  mutate(
    label = acs_vars$label[match(variable,acs_vars$name)]
  ) %>% 
  transmute(
    `Heating Fuel Type` = 
      substr(
        label,
        lapply(
          label, function(x){
            max(unlist(gregexpr('!!',x)))+2
          }
        ),
        nchar(label)
      ),
    `Number of Households` = estimate,
    `Percent of Households` = paste0(round(estimate/95557*100,2),"%")
  )

kable(
  heating_fuel,
  booktabs = TRUE,
  caption = 'Heating fuel type for Stockton households. Data from ACS 1-yr, 2018.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

The 65% of households with "Utility gas" represent the opportunity to replace space heating systems with electric alternatives like heat pumps, moving those households over to the "Electricity" category currently at 32%. The other households using other fuels like kerosene or biomass represent a very small number, but targeting these households may be particularly important because of the extra cost-effectiveness of electrification, and the likely co-benefits of improving health outcomes for a relatively more low-income and rural population. The California Public Utilities Commission is in the process of piloting projects to "[Identify Disadvantaged Communities in the San Joaquin Valley and Analyze Economically Feasible Options to Increase Access to Affordable Energy in those Disadvantaged Communities](http://docs.cpuc.ca.gov/PublishedDocs/Efile/G000/M199/K979/199979978.PDF)". Unfortunately, at least [one pilot in California City](https://www.socalgas.com/1443741594585/Exhibit-5---SoCalGas-Pilot-Project-Proposal-for-California-City--Revised-.pdf) is moving forward with natural gas infrastructure, seemingly because of bureaucratic issues related to the electricity alternative. We would recommend that the City of Stockton stay actively involved in this CPUC project by providing comments on the upcoming phases and advocating for further pilo ts in Stockton and its peripheral rural areas to involve electrification. 

The Rocky Mountain Institute produced a report in 2018 titled ["The Economics of Electrifying Buildings"](https://rmi.org/insight/the-economics-of-electrifying-buildings/). This report includes Oakland as the most geographically proximate case study with estimates of average annual tCO2e reduction and net $ savings for every household that converts under different initial conditions, which will be modeled for Stockton. Their overall recommendations include:

- **Prioritize rapid electrification of buildings currently using propane and heating oil**. This is more relevant in East Coast case studies, but the possible benefits to Stockton were described above.
- **Stop supporting the expansion of the natural gas distribution system, including for new homes**. Our model will consider the impacts of policies to ban natural gas in new buildings. It will be important to learn from the experience of the City of Berkeley which voted to ban natural gas in new buildings in 2019 but is currently [facing a lawsuit](https://www.npr.org/2019/11/21/781874235/california-restaurant-industry-group-sues-berkeley-over-natural-gas-ban) from the California Restaurant Association.
- **Bundle demand flexibility programs, new rate designs, and energy efficiency with electrification initiatives**. Stockton should particularly focus on incentives for both creating the local skilled workforce of HVAC contractors, as well as rebates for homeowners. RMI notes: "Heat pump water heaters make up less than 1% of water heater sales today, and their unsubsidized purchase prices are two or more times those of natural gas water heaters. Given the current immaturity of the market for these products, and the potential for significant economies of scale with increasing market share, their costs are likely to decline in the future. The National Renewable Energy Laboratory's (NREL's) Electrification Futures Study projects cost declines of 20-38% for air-source heat pumps and 42-48% for heat pump water heaters by 2050. Likewise, in regions where contractors are currently unfamiliar with heat pump products, increasing scale and familiarity may reduce installation costs in the future." Electrification of specific high-consumption appliances like water and space heaters also may be combined with "smart appliance" capabilities that enable demand response, discussed next.

The following are case studies of electrification incentive programs from other cities. It is notable that none were found that specifically focus on workforce training, which is an opportunity for Stockton to differentiate itself.

- [Sacramento Municipal Utility District](https://www.smud.org/en) has an All-Electric Smart Home Program, part of the SMUD Smart Home Program, in which participating homeowners receive the financial incentives for single and multi-family homes shown in the table below. The minimum requirements include: all electric appliances and mechanical systems; no gas line in the home; and no gas service at the property. The public-private partnership has reached more than 1,000 homes and is expected to reach 2,000 by the end of the year.

```{r smud}
smud <-
  data.frame(
    Type = c("Single-family unit","Multi-family unit"),
    `Standard Incentive` = c("$4,000","$1,250"),
    `Induction cooking appliance bonus` = c("$1,000","$500"),
    `Total possible incentives` = c("$5,000","$1,750")
  ) %>% 
  rename(
    `Standard incentive` = Standard.Incentive,
    `Induction cooking appliance bonus` = Induction.cooking.appliance.bonus,
    `Total possible incentives` = Total.possible.incentives
  )

kable(
  smud,
  booktabs = TRUE,
  caption = 'Financial incentives for single-family and multi-family homes in the SMUD All-Electric Smart Home Program.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

- [MassCEC](https://www.masscec.com/installer-resources-air-source-heat-pumps) provides incentives for residential installation of whole-home air-source heat pumps. Pilot funding for the project is still being allocated so the number of affected homes is not yet recorded. Incentives are based on income category: For >120% of state median income, \$2,500; for 80-120%, \$3,750; for <80% or affordable housing, \$5,000.
- [City of Palo Alto Utilities](https://cityofpaloalto.org/gov/depts/utl/residents/save_energy_n_water/rebates/heat_pump_water_heater/pilot_program_details.asp) offers rebates with the following eligibility requirements: To participate in the program, you must be a CPAU customer replacing a gas or electric water heater or installing a HPHW in a new or remodeled home; The HPHW must abide by the technical specifications listed by CPAU or must be on the list of Energy Star certified HPHWs.

### Strategy: Demand Response

DR load reductions are of short duration and are made either the day before or the day of a DR program event. In contrast to energy efficiency and traditional time-of-use measures, DR represents the "need of the hour"- the critical period when businesses can mitigate adverse pricing or power system conditions. For instance, DR is most likely to be requested for a few hours between 12 P.M. and 6 P.M., on a hot summer afternoon, when electric demand is generally highest. The figure below illustrates the performance for an example facility participating in a DR event during the period between 2 P.M. and 6 P.M.

Company-led initiatives: PG&E documented pilots with [Community Medical Centers](https://www.pge.com/includes/docs/pdfs/mybusiness/energysavingsrebates/demandresponse/cs/HealthCare_CommunityMedicalCenters_DR_CaseStudy.pdf) in 2006. The centers identified these measures for the summer's first DR event:

- Raise chiller temperature 5 degrees F
- Shut down the redundant chiller water loop
- Shut off redundant water pumps
- Shut down some visitor elevators
- Use EMS systems to turn off 50% of non-essential lights
- Shut off booster pumps for outdoor watering
- Shut off one boiler in order to turn off associated fans
- Turn off cooking equipment and serve cold food (sandwiches and salads) in the Visitor Cafeteria

The largest hospital, whose typical summer peak demand is between 4578 kW and 4664 kW, dropped more than 500 kW over two to six hour periods on three event days.

A private company, [OhmConnect](https://www.ohmconnect.com/how-it-works/impact), allows individual residential customers to also participate in DR. Stockton could explore cleantech competition in this space or supplementary programs for existing services, such as a focus on introducing more "smart appliances" into the market that can more easily participate in DR. The greatest impact is likely in targeting specific large employers for customized DR programs and rewarding/recognizing them for program outcomes, thereby positioning the local economy as a champion and leader in active energy emissions reduction.

## Employment Growth

### Strategy: Job Training

## Local Jobs

### Case Study: Clusters and Anchors in Pittsburgh, PA

### Strategy: R&D Business Growth

## Vehicle Miles Traveled

### Case Study: Direct Connect in Pinellas County, FL

The Pinellas Suncoast Transit Authority (PSTA), in Pinellas County, FL, was the first transit agency in the US to sign a service provision agreement with a transportation network company (TNC) to offer joint first/last-mile service subsidized by public dollars. PSTA's "Direct Connect" pilot allows riders to get to and from bus stops in a taxi, wheelchair-accessible vehicle (WAV), or Uber TNC vehicle at a subsidized rate. From August 2017 to March 2018, Uber trips taken via the service (beginning or ending within 800 feet of eight pilot transit stops) were subsidized on average from $7.64 to \$2.64 per ride. The Shared Use Mobility Center conducted a [program evaluation](https://learn.sharedusemobilitycenter.org/wp-content/uploads/SUMC_CaseStudy_Final3_06.21.19-1.pdf) in 2019 and outlined key lessons learned, including:

- The importance of leadersihp within the transit agency, and the strong coordination of key staff members in charge of the project.
- Heavy investment in public outreach about the program.
- A common contract for multiple potential TNCs to compete within the program.
- Negotiating greater data sharing from the TNC and direct investment in other forms of program data, such as user surveys.
- Identifying clear performance goals to monitor over the project.
- Refining the financial model and preparing for greater subsidy costs as TNC business models evolve.

### Strategy: Public Transit

In 2019, San Joaquin Regional Transit District released its [Short Range Transit Plan](http://sanjoaquinrtd.com/wp-content/uploads/2019/02/SRTP-2018-Update_FINAL.pdf) for 18/19-27/28. Generally, RTD suffered service reductions after the financial recession but is expecting to be able to regain ground and expand service during this next phase. There are currently 128 active vehicles and 203 employees. Proposed Bus Rapid Transit (BRT) lines throughout Stockton include CO2 reduction projections. For new service, the capital cost of a new vehicle is about \$1M, and capital infrastructure costs are about \$500K per stop, and annual operating costs are \$600-800M per vehicle.

In June of 2018, RTD formed a partnership with PG&E to conduct an electric vehicle pilot to support RTD's long-term electric transportation needs with chargers and infrastructure improvements. This pilot will be a test case for PG&E's new FleetReady program, which supports electric charging for customers with medium-duty, heavy-duty, and off-road fleets. For this new pilot, PG&E will test how smart charging and battery storage can lower operating costs and maximize efficiencies. As RTD transitions to an electric fleet, it will need to purchase electric station infrastructure for the RTC.

RTD has also piloted a variety of mobility management services which act as alternatives to fixed-line service, and expects to expand these, including:

- RTD Go! On July 10, 2017, RTD Go-in partnership with Uber and Journey Via Gurney (JVG)-replaced the former General Public Dial-A-Ride service that operated countywide with a primary focus in rural areas. RTD Go provides public transit connectivity to residents of rural areas of the county where traditional bus service is not practical. This program extends service hours beyond fixed-route hours and offers an innovative mobility option to the public. By partnering with transportation network company Uber, RTD Go provides on-demand transportation that is subsidized 50%, up to \$5 per trip. For customers with physical disabilities or other limitations, RTD Go partnered with accessible service provider, JVG, to provide transportation at a \$10 flat fare per trip.
- When designing Commuter routes, RTD evaluates the origins and destinations using data from SJCOG's Dibs (formerly Commute Connection) program and current and potential employers. There are emerging needs for the creation of corridor service with multiple trips between Stockton, Lodi, and downtown Sacramento-initially with weekday service, expanding to a seven-days-a-week operation. Additionally, with weekend service to Dublin/Pleasanton BART Station, there is a need to expand the Commuter route to provide better connectivity to Manteca, Escalon, and Ripon.

Local public transit improvements will be modeled as reductions on local amenity VMT, while specific proposed commuter routes will be modeled as reductions on commute VMT.

### Strategy: Employer-based Transportation Management

## Vehicle Emissions

### Strategy: Electric Vehicle Program

# Conclusion

# Appendix A: Index of Case Studies by Place

**Arizona**

- Engage automobile manufacturers as stakeholders in the EV market

**Austin, TX**

- Partner with transportation network companies (TNCs) to offer first/last mile discount programs for transit riders

**Belgrade, Serbia**

- Revise energy standards for public buildings and create a fund to implement energy savings product

**Bridgeport, CT**

- Provide training and coaching for low-income workers, rather than unemployed workers

**Buffalo, NY**

- [Eliminate minimum parking](#revise-zoning-codes-in-medium-to-large-cities-to-facilitate-upzoning)



```{r save}
# save.image(file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_greeneconomy.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_greeneconomy.Rdata")
```
