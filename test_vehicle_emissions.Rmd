---
title: "Stockton Green Economy Report"
author: "City Systems"
date: "Last Updated: February 2020"
output: 
  bookdown::gitbook:
    df_print: paged
    includes:
      in_header: header.html
    config:
      toc:
        collapse: none
        scroll_highlight: yes
        before: null
        after: null
      toolbar:
        position: fixed
      edit : null
      download: null
      search: yes
      fontsettings:
        theme: white
        family: sans
        size: 2
      sharing:
        facebook: no
        github: no
        twitter: no
        linkedin: no
        weibo: no
        instapaper: no
        vk: no
        all: no
      info: no
editor_options: 
  chunk_output_type: console
---

# Test Vehicle Emissions

```{r}
library(censusapi)
library(tidyverse)
library(tigris)
library(sf)
library(mapview)
library(raster)
library(lwgeom)
library(smoothr)
library(lwgeom)
library(units)
library(geosphere)
library(tidytransit)
library(knitr)
library(DT)
library(bookdown)
library(kableExtra)
library(FinancialMath)
library(smoothr)
library(lwgeom)
library(geosphere)
library(tidytransit)
mapviewOptions(
  basemaps = "OpenStreetMap"
)
options(
  tigris_class = "sf",
  tigris_use_cache = TRUE,
  scipen=999
)
```

The previous section estimated the total VMTs due to commuting for Stockton workers from 2011 to 2017, which can be used to forecast VMTs through 2040. While VMTs themselves are an important indicator of quality of life and economic vitality, from a GHG perspective we need to convert vehicle miles to emissions.

We followed the standard method for calculating vehicle emissions in California using the California Air Resources Board (CARB) [Emission Factors (EMFAC) model](https://ww2.arb.ca.gov/our-work/programs/mobile-source-emissions-inventory/msei-modeling-tools). Using the EMFAC2017 model, we downloaded emissions rates data for 2020, 2025, 2030, and 2040 in the San Joaquin Valley air basin. The data includes CARB's model estimates for daily vehicles across passenger cars and trucks of different fuel types, along with emissions per mile for CO2 and other pollutants. A summary of the EMFAC data is provided below.

```{r}
emfac <- read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/emfac.csv")

emfac_summary <-
  emfac %>% 
  dplyr::select(
    Year = `Calendar Year`,
    `Vehicle Category`,
    `Fuel Type` = Fuel,
    Population,
    CO2_RUNEX,
    CO2_STREX
  ) %>% 
  group_by(Year) %>% 
  mutate(
    `Percent Vehicles` = round(Population/sum(Population)*100,2) %>% as.numeric(),
    `gCO2 Running Exhaust` = CO2_RUNEX %>% as.integer(),
    `gCO2 Start Exhaust` = CO2_STREX %>% as.integer()
  ) %>% 
  ungroup() %>% 
  dplyr::select(-Population, -CO2_RUNEX, -CO2_STREX) %>% 
  mutate(
    `Fuel Type` = 
      case_when(
        `Fuel Type` == "GAS" ~ "Gasoline",
        `Fuel Type` == "DSL" ~ "Diesel",
        TRUE ~ "Electric"
      ),
    `Vehicle Category` = 
      case_when(
        `Vehicle Category` == "LDA" ~ "Passenger Car",
        TRUE ~ "Light Duty Truck"
      )
  ) %>% 
  group_by(Year, `Vehicle Category`, `Fuel Type`) %>% 
  summarize_all(sum)
  
kable(
  emfac_summary,
  booktabs = TRUE,
  caption = 'EMFAC2017 emission rates for vehicles in San Joaquin Valley.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

Emissions from N2O and CH4, along with emissions from other types of vehicles, were left out of this analysis. We applied CO2 emission rates above to 



```{r}
# save.image(file = "C:/Users/Derek Ouyang/Google Drive/City Systems/Stockton Green Economy/ADU/test_adu_save4.Rdata")
# load("C:/Users/Derek Ouyang/Google Drive/City Systems/Stockton Green Economy/ADU/test_adu_save4.Rdata")
```

```{r}
  # mutate(
  #   n2o_convert = 
  #     case_when(
  #       vehicle == "LDA" & fuel == "GAS" ~ n2o*0.011,
  #       vehicle == "LDA" & fuel == "DSL" ~ n2o*0.001,
  #       vehicle %in% c("LDT1","LDT2") & fuel == "GAS" ~ n2o*0.017,
  #       vehicle %in% c("LDT1","LDT2") & fuel == "DSL" ~ n2o*0.0015,
  #     ),
  #   ch4_convert = 
  #     case_when(
  #       vehicle == "LDA" & fuel == "GAS" ~ n2o*0.0187,
  #       vehicle == "LDA" & fuel == "DSL" ~ n2o*0.005,
  #       vehicle %in% c("LDT1","LDT2") & fuel == "GAS" ~ n2o*0.0201,
  #       vehicle %in% c("LDT1","LDT2") & fuel == "DSL" ~ n2o*0.001,
  #     )
  # )
```

